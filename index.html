<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê°€ê³„ë¶€</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#F7F6F3;--surface:#fff;--s2:#F0EEE9;--border:#E8E4DC;
  --text:#1A1916;--muted:#8C8880;
  --p:#2D5016;--plt:#E8F0E0;
  --j:#1A4A7A;--jlt:#E0EAF5;
  --danger:#C0392B;--dlt:#FDECEA;
  --warn:#E67E22;--wlt:#FEF5E7;
  --ok:#27AE60;--olt:#E8F8EF;
  --shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;line-height:1.5;}
.app{display:flex;flex-direction:column;min-height:100vh;max-width:480px;margin:0 auto;background:var(--bg);}

header{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 20px 0;position:sticky;top:0;z-index:100;}
.htop{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.htitle{font-size:18px;font-weight:700;letter-spacing:-.3px;}
.mnav{display:flex;align-items:center;gap:10px;}
.mnav button{background:none;border:none;cursor:pointer;color:var(--muted);font-size:20px;padding:2px 6px;line-height:1;}
.mlbl{font-family:'DM Mono',monospace;font-size:13px;font-weight:500;min-width:56px;text-align:center;}
.ntabs{display:flex;}
.ntab{flex:1;padding:10px 4px;text-align:center;font-size:12px;font-weight:500;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;}
.ntab.active{color:var(--p);border-bottom-color:var(--p);}

.stabs{display:flex;gap:8px;padding:12px 16px 0;background:var(--bg);}
.stab{flex:1;padding:9px;text-align:center;font-size:13px;font-weight:600;border-radius:10px 10px 0 0;cursor:pointer;border:1.5px solid var(--border);border-bottom:none;background:var(--s2);color:var(--muted);transition:all .15s;}
.stab.active.personal{background:var(--surface);color:var(--p);border-color:var(--p);}
.stab.active.joint{background:var(--surface);color:var(--j);border-color:var(--j);}

main{flex:1;padding:16px;overflow-y:auto;padding-bottom:90px;}
.card{background:var(--surface);border-radius:12px;padding:16px;box-shadow:var(--shadow);margin-bottom:12px;}
.ctitle{font-size:11px;font-weight:500;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;}
.strip{height:3px;margin:-16px -16px 14px;border-radius:12px 12px 0 0;}

/* Balance */
.balmain{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px;}
.balamt{font-family:'DM Mono',monospace;font-size:26px;font-weight:400;}
.balamt.danger{color:var(--danger);}
.balsub{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:8px;}
.balsub b{color:var(--text);font-family:'DM Mono',monospace;font-weight:500;}
.pbar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;}
.pfill{height:100%;border-radius:2px;transition:width .4s;}
.pfill.p-ok{background:var(--p);}.pfill.j-ok{background:var(--j);}
.pfill.warn{background:var(--warn);}.pfill.over{background:var(--danger);}

/* Grids */
.sg{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.si2{background:var(--s2);border-radius:8px;padding:10px 12px;}
.si2 .sl{font-size:11px;color:var(--muted);margin-bottom:2px;}
.si2 .sv{font-family:'DM Mono',monospace;font-size:15px;font-weight:500;}

/* Category rows */
.crow{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);}
.crow:last-child{border-bottom:none;}
.cdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.cinfo{flex:1;min-width:0;}
.cname{font-size:13px;font-weight:500;}
.cbw{height:3px;background:var(--border);border-radius:2px;margin-top:4px;}
.cbf{height:100%;border-radius:2px;}
.cright{text-align:right;flex-shrink:0;}
.cspent{font-family:'DM Mono',monospace;font-size:13px;font-weight:500;}
.cbudget{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}

/* Tx */
.badge{display:inline-flex;align-items:center;font-size:10px;font-weight:500;padding:2px 7px;border-radius:20px;}
.b-card{background:var(--s2);color:var(--muted);}.b-cash{background:#FEF9E7;color:#876500;}.b-acc{background:#EEF2FF;color:#3730A3;}
.txdh{font-size:11px;color:var(--muted);font-weight:500;padding:12px 0 6px;display:flex;justify-content:space-between;}
.txitem{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);cursor:pointer;}
.txitem:last-child{border-bottom:none;}
.txicon{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.txbody{flex:1;min-width:0;}
.txname{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.txmeta{display:flex;gap:4px;margin-top:2px;flex-wrap:wrap;}
.txamt{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--danger);white-space:nowrap;}

/* Alert */
.alert{border-radius:10px;padding:10px 14px;font-size:12px;margin-bottom:10px;}
.alert.warn{background:var(--wlt);color:var(--warn);}
.alert.over{background:var(--dlt);color:var(--danger);}
.alert strong{display:block;font-weight:700;margin-bottom:1px;}

/* Summary settle rows */
.srow{display:flex;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);gap:8px;}
.srow:last-child{border-bottom:none;}
.srow-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.srow-name{flex:1;font-size:13px;font-weight:500;}
.srow-type{font-size:10px;padding:2px 6px;border-radius:10px;font-weight:600;}
.srow-type.avg{background:var(--plt);color:var(--p);}
.srow-type.fixed{background:#F0F0FF;color:#5555AA;}
.srow-budget{font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);text-align:right;min-width:72px;}
.srow-spent{font-family:'DM Mono',monospace;font-size:13px;font-weight:600;text-align:right;min-width:72px;}
.srow-diff{font-family:'DM Mono',monospace;font-size:12px;font-weight:600;text-align:right;min-width:64px;}
.srow-diff.plus{color:var(--ok);}
.srow-diff.minus{color:var(--danger);}

/* FAB */
.fab{position:fixed;bottom:24px;right:calc(50% - 240px + 20px);width:52px;height:52px;border-radius:16px;color:white;border:none;cursor:pointer;font-size:26px;box-shadow:0 4px 16px rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;z-index:200;transition:background .2s,transform .15s;background:var(--p);}
.fab:hover{transform:scale(1.05);}
@media(max-width:480px){.fab{right:20px;}}

/* Modal */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:300;align-items:flex-end;justify-content:center;}
.mo.open{display:flex;}
.mb{background:var(--surface);border-radius:20px 20px 0 0;width:100%;max-width:480px;padding:20px;max-height:92vh;overflow-y:auto;}
.mh{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.mtitle{font-size:16px;font-weight:700;margin-bottom:18px;}
.fg{margin-bottom:14px;}
.fl{font-size:11px;font-weight:500;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px;display:block;}
.fi{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-family:inherit;font-size:14px;color:var(--text);outline:none;transition:border-color .15s;}
.fi:focus{border-color:var(--p);}
.fi.big{font-family:'DM Mono',monospace!important;font-size:22px!important;}
.tg{display:flex;background:var(--s2);border-radius:10px;padding:3px;gap:3px;}
.tb{flex:1;padding:8px 4px;text-align:center;font-size:12px;font-weight:500;cursor:pointer;border-radius:8px;color:var(--muted);transition:all .15s;border:none;background:none;font-family:inherit;}
.tb.active{background:var(--surface);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.1);}
.chips{display:flex;flex-wrap:wrap;gap:7px;}
.chip{padding:6px 13px;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;border:1.5px solid var(--border);color:var(--muted);background:var(--surface);transition:all .15s;}
.chip.sp{border-color:var(--p);color:var(--p);background:var(--plt);}
.chip.sj{border-color:var(--j);color:var(--j);background:var(--jlt);}
.bsub{width:100%;color:white;border:none;border-radius:12px;padding:14px;font-size:15px;font-weight:600;font-family:inherit;cursor:pointer;margin-top:6px;transition:background .2s;background:var(--p);}
.jnote{font-size:11px;color:var(--j);background:var(--jlt);border-radius:8px;padding:8px 12px;margin-bottom:14px;line-height:1.7;}

/* Settings */
.sr{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);}
.sr:last-child{border-bottom:none;}
.sl2{font-size:13px;font-weight:500;}
.sinp{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-family:'DM Mono',monospace;font-size:13px;width:130px;text-align:right;outline:none;}
.sinp:focus{border-color:var(--p);}
.sinp-sm{width:90px;}

/* Budget settings rows */
.brow{padding:12px 0;border-bottom:1px solid var(--border);}
.brow:last-child{border-bottom:none;}
.brow-top{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.brow-name{font-size:13px;font-weight:600;flex:1;}
.brow-typebtn{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;cursor:pointer;border:1.5px solid;transition:all .15s;}
.brow-typebtn.avg{border-color:var(--p);color:var(--p);background:var(--plt);}
.brow-typebtn.fixed{border-color:#5555AA;color:#5555AA;background:#F0F0FF;}
.brow-fields{display:flex;flex-direction:column;gap:6px;}
.brow-line{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--muted);}
.brow-result{font-family:'DM Mono',monospace;font-size:12px;font-weight:600;padding:4px 10px;border-radius:6px;display:inline-block;margin-top:4px;}
.brow-result.p-col{color:var(--p);background:var(--plt);}
.brow-result.j-col{color:var(--j);background:var(--jlt);}

/* Settle page */
.settle-header{display:grid;grid-template-columns:1fr 72px 72px 64px;gap:6px;padding:8px 0 6px;font-size:10px;font-weight:600;color:var(--muted);border-bottom:2px solid var(--border);margin-bottom:4px;}

/* Backup */
.btn-outline{background:none;border:1.5px solid var(--border);border-radius:10px;padding:10px 16px;font-family:inherit;font-size:13px;font-weight:500;cursor:pointer;color:var(--text);width:100%;margin-bottom:8px;transition:all .15s;}
.btn-outline:hover{border-color:var(--p);color:var(--p);}
.btn-outline.danger:hover{border-color:var(--danger);color:var(--danger);}

/* â”€â”€ Tx Filter â”€â”€ */
.txfilter{display:flex;gap:6px;padding:12px 0 8px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;}
.txfilter::-webkit-scrollbar{display:none;}
.txftab{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:500;background:var(--s2);color:var(--muted);cursor:pointer;white-space:nowrap;border:none;font-family:inherit;transition:all .15s;}
.txftab.active{background:var(--text);color:var(--bg);}
.txftab.p-act{background:var(--p);color:#fff;}
.txftab.j-act{background:var(--j);color:#fff;}
.txdate-header{display:flex;justify-content:space-between;align-items:baseline;padding:8px 0 4px;border-bottom:1px solid var(--border);margin-bottom:2px;}
.txdate-label{font-size:12px;font-weight:600;color:var(--muted);}
.txdate-sum{font-size:11px;font-family:'DM Mono',monospace;color:var(--muted);}

/* â”€â”€ Income â”€â”€ */
.b-income{background:#E8F8EF;color:#1A7A45;}
.income-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);}
.income-row:last-child{border-bottom:none;}
.income-amt{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--ok);white-space:nowrap;}

.page{display:none;}.page.active{display:block;}
.empty{text-align:center;padding:48px 24px;color:var(--muted);}
.empty .icon{font-size:36px;margin-bottom:10px;}
.empty p{font-size:13px;}
.note{font-size:11px;color:var(--muted);line-height:1.6;margin-bottom:12px;}

/* â”€â”€ Assets â”€â”€ */
.asset-card{background:var(--surface);border-radius:14px;padding:16px;box-shadow:var(--shadow);margin-bottom:10px;display:flex;align-items:center;gap:14px;}
.asset-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.asset-body{flex:1;min-width:0;}
.asset-name{font-size:13px;font-weight:600;margin-bottom:1px;}
.asset-sub{font-size:11px;color:var(--muted);}
.asset-right{text-align:right;flex-shrink:0;}
.asset-bal{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;}
.asset-change{font-size:11px;font-weight:600;margin-top:1px;}
.asset-change.plus{color:var(--ok);}
.asset-change.zero{color:var(--muted);}
.asset-total{background:linear-gradient(135deg,#1A3A5C,#2D5016);border-radius:14px;padding:18px;color:white;margin-bottom:14px;box-shadow:var(--shadow);}
.asset-total .label{font-size:11px;opacity:.7;margin-bottom:4px;}
.asset-total .amount{font-family:'DM Mono',monospace;font-size:28px;font-weight:400;}
.asset-total .sub{font-size:11px;opacity:.7;margin-top:6px;display:flex;gap:16px;}
</style>
</head>
<body>
<div class="app">
<header>
  <div class="htop">
    <span class="htitle">ê°€ê³„ë¶€</span>
    <div class="mnav">
      <button onclick="changeMonth(-1)">â€¹</button>
      <span class="mlbl" id="monthLabel"></span>
      <button onclick="changeMonth(1)">â€º</button>
    </div>
  </div>
  <div class="ntabs">
    <div class="ntab active" onclick="switchMain('overview')">ìš”ì•½</div>
    <div class="ntab" onclick="switchMain('transactions')">ë‚´ì—­</div>
    <div class="ntab" onclick="switchMain('assets')">ìì‚°</div>
    <div class="ntab" onclick="switchMain('settle')">ê²°ì‚°</div>
    <div class="ntab" onclick="switchMain('settings')">ì„¤ì •</div>
  </div>
</header>

<div class="stabs" id="subTabRow">
  <div class="stab active personal" id="st-personal" onclick="switchSub('personal')">ğŸ‘¤ ê°œì¸</div>
  <div class="stab joint" id="st-joint" onclick="switchSub('joint')">ğŸ‘¥ ê³µë™</div>
</div>

<main>
<!-- â•â• OVERVIEW â•â• -->
<div class="page active" id="page-overview">
  <div id="ov-p">
    <div class="card">
      <div class="strip" style="background:var(--p)"></div>
      <div class="ctitle">ê°œì¸ ì—¬ìœ ìê¸ˆ</div>
      <div class="balmain"><span class="balamt" id="p-amt">â‚©0</span><span style="font-size:11px;color:var(--muted)" id="p-lbl">ì”ì•¡</span></div>
      <div class="balsub">
        <span>ê³„ì¢Œ <b id="p-acc-bal">-</b></span>
        <span>í˜„ê¸ˆ <b id="p-cash-bal">-</b></span>
        <span>ê³ ì •ë¹„ <b id="p-fixed">-</b></span>
      </div>
      <div class="pbar"><div class="pfill p-ok" id="p-bar" style="width:0%"></div></div>
      <div style="font-size:11px;color:var(--muted);margin-top:8px;display:flex;justify-content:space-between;">
        <span>ì›”ì´ˆ ê³„ì¢Œ <b id="p-acc-open" style="color:var(--text);font-family:'DM Mono',monospace">-</b></span>
        <span>í˜„ê¸ˆ <b id="p-cash-open" style="color:var(--text);font-family:'DM Mono',monospace">-</b></span>
        <span>ì „ì›”ì¹´ë“œ <b id="p-prev-card" style="color:var(--danger);font-family:'DM Mono',monospace">-</b></span>
      </div>
    </div>
    <div id="p-alert"></div>
    <div class="card">
      <div class="ctitle">ì´ë²ˆ ë‹¬ ìˆ˜ì…</div>
      <div class="sg">
        <div class="si2"><div class="sl">ê³„ì¢Œ ìˆ˜ì…</div><div class="sv" style="color:var(--ok)" id="p-acc-income">â‚©0</div></div>
        <div class="si2"><div class="sl">í˜„ê¸ˆ ìˆ˜ì…</div><div class="sv" style="color:var(--ok)" id="p-cash-income">â‚©0</div></div>
      </div>
      <div id="p-income-cats"></div>
    </div>
    <div class="card">
      <div class="ctitle">ì´ë²ˆ ë‹¬ ì§€ì¶œ</div>
      <div class="sg">
        <div class="si2"><div class="sl">ê³„ì¢Œ ì§€ì¶œ</div><div class="sv" id="p-acc-spent">â‚©0</div></div>
        <div class="si2"><div class="sl">í˜„ê¸ˆ ì§€ì¶œ</div><div class="sv" id="p-cash-spent">â‚©0</div></div>
        <div class="si2"><div class="sl">ì¹´ë“œ ì§€ì¶œ</div><div class="sv" id="p-card-spent">â‚©0</div></div>
        <div class="si2"><div class="sl">ê³µë™ì¹´ë“œ ë³´ì „</div><div class="sv" style="color:var(--j)" id="p-jcard-rebate">â‚©0</div></div>
      </div>
      <div id="p-rebate"></div>
    </div>
    <div class="card">
      <div class="ctitle">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</div>
      <div id="p-cats"></div>
    </div>
  </div>
  <div id="ov-j" style="display:none">
    <div class="card">
      <div class="strip" style="background:var(--j)"></div>
      <div class="ctitle">ê³µë™ ì”ì•¡</div>
      <div class="balmain"><span class="balamt" id="j-amt">â‚©0</span><span style="font-size:11px;color:var(--muted)" id="j-lbl">ì”ì•¡</span></div>
      <div class="balsub"><span>ì›”ì´ˆì”ê³  <b id="j-open">-</b></span><span>ê³ ì •ë¹„ì˜ˆì‚° <b id="j-fixed">-</b></span></div>
      <div class="pbar"><div class="pfill j-ok" id="j-bar" style="width:0%"></div></div>
    </div>
    <div id="j-alert"></div>
    <div class="card">
      <div class="ctitle">ì´ë²ˆ ë‹¬ ìˆ˜ì…</div>
      <div class="sg">
        <div class="si2"><div class="sl">ê³„ì¢Œ ìˆ˜ì…</div><div class="sv" style="color:var(--ok)" id="j-acc-income">â‚©0</div></div>
        <div class="si2"><div class="sl">í˜„ê¸ˆ ìˆ˜ì…</div><div class="sv" style="color:var(--ok)" id="j-cash-income">â‚©0</div></div>
      </div>
      <div id="j-income-cats"></div>
    </div>
    <div class="card">
      <div class="ctitle">ê³µë™ ì§€ì¶œ</div>
      <div class="sg">
        <div class="si2"><div class="sl">ì´ ì§€ì¶œ</div><div class="sv" id="j-total">â‚©0</div></div>
        <div class="si2"><div class="sl">ì‹ ìš©ì¹´ë“œ</div><div class="sv" id="j-card">â‚©0</div></div>
      </div>
      <div id="j-breakdown"></div>
    </div>
    <div class="card">
      <div class="ctitle">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</div>
      <div id="j-cats"></div>
    </div>
  </div>
</div>

<!-- â•â• TRANSACTIONS â•â• -->
<div class="page" id="page-transactions">
  <div class="txfilter" id="txfilter"></div>
  <div id="tx-p"></div>
  <div id="tx-j" style="display:none"></div>
</div>

<!-- â•â• ASSETS â•â• -->
<div class="page" id="page-assets">
  <!-- ì´ ìì‚° ìš”ì•½ ì¹´ë“œ -->
  <div class="asset-total">
    <div class="label">ì´ ìì‚°</div>
    <div class="amount" id="asset-total">â‚©0</div>
    <div class="sub">
      <span>ì›”ì´ˆ ëŒ€ë¹„ <b id="asset-delta" style="font-family:'DM Mono',monospace">-</b></span>
      <span>ì´ë²ˆë‹¬ ì ë¦½ <b id="asset-deposit" style="font-family:'DM Mono',monospace">-</b></span>
    </div>
  </div>
  <!-- ìì‚°ë³„ ì¹´ë“œ -->
  <div id="asset-list"></div>
</div>

<!-- â•â• SETTLE â•â• -->
<div class="page" id="page-settle">
  <div id="settle-p">
    <div class="card">
      <div class="strip" style="background:var(--p)"></div>
      <div class="ctitle">ê°œì¸ ì›”ë³„ ê²°ì‚°</div>
      <div class="sg" style="margin-bottom:12px">
        <div class="si2"><div class="sl">ê³ ì •ë¹„ ì˜ˆì‚° í•©ê³„</div><div class="sv" id="sp-budget">â‚©0</div></div>
        <div class="si2"><div class="sl">ì‹¤ì œ ì§€ì¶œ í•©ê³„</div><div class="sv" id="sp-spent">â‚©0</div></div>
        <div class="si2"><div class="sl">ì ˆì•½ / ì´ˆê³¼</div><div class="sv" id="sp-diff">-</div></div>
        <div class="si2"><div class="sl">ì ˆì•½ë¥ </div><div class="sv" id="sp-rate">-</div></div>
      </div>
      <div class="settle-header">
        <span>ì¹´í…Œê³ ë¦¬</span><span style="text-align:right">ì˜ˆì‚°</span><span style="text-align:right">ì§€ì¶œ</span><span style="text-align:right">ì°¨ì´</span>
      </div>
      <div id="sp-rows"></div>
    </div>
  </div>
  <div id="settle-j" style="display:none">
    <div class="card">
      <div class="strip" style="background:var(--j)"></div>
      <div class="ctitle">ê³µë™ ì›”ë³„ ê²°ì‚°</div>
      <div class="sg" style="margin-bottom:12px">
        <div class="si2"><div class="sl">ê³ ì •ë¹„ ì˜ˆì‚° í•©ê³„</div><div class="sv" id="sj-budget">â‚©0</div></div>
        <div class="si2"><div class="sl">ì‹¤ì œ ì§€ì¶œ í•©ê³„</div><div class="sv" id="sj-spent">â‚©0</div></div>
        <div class="si2"><div class="sl">ì ˆì•½ / ì´ˆê³¼</div><div class="sv" id="sj-diff">-</div></div>
        <div class="si2"><div class="sl">ì ˆì•½ë¥ </div><div class="sv" id="sj-rate">-</div></div>
      </div>
      <div class="settle-header">
        <span>ì¹´í…Œê³ ë¦¬</span><span style="text-align:right">ì˜ˆì‚°</span><span style="text-align:right">ì§€ì¶œ</span><span style="text-align:right">ì°¨ì´</span>
      </div>
      <div id="sj-rows"></div>
    </div>
  </div>
</div>

<!-- â•â• SETTINGS â•â• -->
<div class="page" id="page-settings">
  <!-- ê°œì¸ ì”ê³  -->
  <div class="card">
    <div class="strip" style="background:var(--p)"></div>
    <div class="ctitle">ê°œì¸ ì›”ì´ˆ ì”ê³ </div>
    <div class="sr">
      <span class="sl2">ğŸ¦ ê³„ì¢Œ ì”ê³ </span>
      <input type="number" class="sinp" id="set-p-acc" placeholder="0" oninput="saveSettingsDebounced()">
    </div>
    <div class="sr">
      <span class="sl2">ğŸ’µ í˜„ê¸ˆ ì”ê³ </span>
      <input type="number" class="sinp" id="set-p-cash" placeholder="0" oninput="saveSettingsDebounced()">
    </div>
    <div class="sr">
      <span class="sl2">ğŸ’³ ì „ì›” ì¹´ë“œëŒ€ê¸ˆ</span>
      <input type="number" class="sinp" id="set-p-prev-card" placeholder="0" oninput="saveSettingsDebounced()">
    </div>
  </div>
  <!-- ê°œì¸ ê³ ì •ë¹„ ì˜ˆì‚° -->
  <div class="card">
    <div class="strip" style="background:var(--p)"></div>
    <div class="ctitle">ê°œì¸ ê³ ì •ë¹„ ì˜ˆì‚°</div>
    <div class="note">ê° í•­ëª©ì´ <strong>ì›”í‰ê· </strong>(ì§€ì¶œì— ë”°ë¼ ìë™ ê°±ì‹ )ì¸ì§€ <strong>ê³ ì •ê¸ˆì•¡</strong>(ë§¤ë‹¬ ë™ì¼)ì¸ì§€ ì„ íƒí•˜ì„¸ìš”.</div>
    <div id="set-p-budgets"></div>
  </div>
  <!-- ê³µë™ ì”ê³  -->
  <div class="card" style="margin-top:8px">
    <div class="strip" style="background:var(--j)"></div>
    <div class="ctitle">ê³µë™ ì›”ì´ˆ ì”ê³ </div>
    <div class="sr">
      <span class="sl2">ğŸ¦ ê³µë™ ê³„ì¢Œ ì”ê³ </span>
      <input type="number" class="sinp" id="set-j-bal" placeholder="0" oninput="saveSettingsDebounced()">
    </div>
  </div>
  <!-- ê³µë™ ê³ ì •ë¹„ ì˜ˆì‚° -->
  <div class="card">
    <div class="strip" style="background:var(--j)"></div>
    <div class="ctitle">ê³µë™ ê³ ì •ë¹„ ì˜ˆì‚°</div>
    <div class="note">ê° í•­ëª©ì´ <strong>ì›”í‰ê· </strong>ì¸ì§€ <strong>ê³ ì •ê¸ˆì•¡</strong>ì¸ì§€ ì„ íƒí•˜ì„¸ìš”.</div>
    <div id="set-j-budgets"></div>
  </div>
  <!-- ìì‚° ì„¤ì • -->
  <div class="card">
    <div class="strip" style="background:linear-gradient(90deg,#1A3A5C,#2D5016)"></div>
    <div class="ctitle">ìì‚° ì›”ì´ˆ ì”ì•¡</div>
    <div class="note">ì›”ì´ˆ ì”ì•¡ì„ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, ë¹„ì›Œë‘ë©´ ì „ì›” ë§ ì”ì•¡ì´ ìë™ ì´ì›”ë©ë‹ˆë‹¤. ì´ë²ˆ ë‹¬ ì§€ì¶œ ë‚´ì—­ì˜ ì ê¸ˆ í•­ëª©ì´ ìë™ í•©ì‚°ë©ë‹ˆë‹¤.</div>
    <div id="set-assets"></div>
  </div>

  <!-- ë°±ì—…/ë³µì› -->
  <div class="card" style="margin-bottom:80px">
    <div class="ctitle">ë°ì´í„° ë°±ì—… / ë³µì›</div>
    <div class="note">JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê±°ë‚˜ ë¶ˆëŸ¬ì™€ì„œ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ì„¸ìš”. ì•±ì„ ìƒˆë¡œ ë°›ì•„ë„ ë³µì› í›„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    <button class="btn-outline" onclick="exportData()">ğŸ“¤ JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°</button>
    <button class="btn-outline" onclick="document.getElementById('import-file').click()">ğŸ“¥ JSONì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
    <button class="btn-outline danger" onclick="resetData()">ğŸ—‘ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
  </div>
</div>
</main>
</div>

<button class="fab" id="fab" onclick="openModal()">+</button>

<!-- Modal -->
<div class="mo" id="modal" onclick="closeOut(event)">
<div class="mb">
  <div class="mh"></div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
    <div class="mtitle" id="modal-title" style="margin-bottom:0">ì§€ì¶œ ì¶”ê°€</div>
    <div class="tg" style="width:auto;gap:2px;padding:2px;">
      <button class="tb active" id="dir-exp" onclick="setDirection('expense')" style="padding:6px 14px;font-size:12px;">ì§€ì¶œ</button>
      <button class="tb" id="dir-inc" onclick="setDirection('income')" style="padding:6px 14px;font-size:12px;color:var(--ok)">ìˆ˜ì…</button>
    </div>
  </div>
  <div class="fg">
    <label class="fl">ìœ í˜•</label>
    <div class="tg">
      <button class="tb active" id="tp-p" onclick="setType('personal')">ğŸ‘¤ ê°œì¸</button>
      <button class="tb" id="tp-j" onclick="setType('joint')">ğŸ‘¥ ê³µë™</button>
    </div>
  </div>
  <div class="jnote" id="jnote" style="display:none">
    ğŸ¦ ê³„ì¢Œ â†’ ê³µë™ ì”ì•¡ë§Œ ì°¨ê°<br>
    ğŸ’³ ì¹´ë“œ â†’ ê³µë™ ì”ì•¡ ì°¨ê° + ê°œì¸ ê³„ì¢Œ ë³´ì „
  </div>
  <div class="fg">
    <label class="fl">ê¸ˆì•¡</label>
    <input type="number" class="fi big" id="inp-amt" placeholder="0" inputmode="numeric">
  </div>
  <div class="fg">
    <label class="fl">ë‚´ìš©</label>
    <input type="text" class="fi" id="inp-desc" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤">
  </div>
  <div class="fg">
    <label class="fl">ë‚ ì§œ</label>
    <input type="date" class="fi" id="inp-date">
  </div>
  <div class="fg">
    <label class="fl">ì¹´í…Œê³ ë¦¬</label>
    <div class="chips" id="chips"></div>
  </div>
  <div class="fg" id="asset-fg" style="display:none">
    <label class="fl">ì ê¸ˆ í•­ëª©</label>
    <div class="chips" id="asset-chips"></div>
  </div>
  <div class="fg" id="payment-fg">
    <label class="fl" id="payment-lbl">ê²°ì œ ìˆ˜ë‹¨</label>
    <div class="tg">
      <button class="tb active" id="pm-card" onclick="setPayment('card')">ğŸ’³ ì¹´ë“œ</button>
      <button class="tb" id="pm-account" onclick="setPayment('account')">ğŸ¦ ê³„ì¢Œ</button>
      <button class="tb" id="pm-cash" onclick="setPayment('cash')">ğŸ’µ í˜„ê¸ˆ</button>
    </div>
  </div>
  <button class="bsub" id="bsub" onclick="saveTx()">ì§€ì¶œ ì¶”ê°€</button>
</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PC=['#4A7C59','#C0752A','#2C7BB6','#8E44AD','#C0392B','#16A085','#B7950B','#5D6D7E','#A04000','#1A5276','#6C3483','#117A65','#616A6B'];
const JC=['#1A4A7A','#1A6B9A','#148F77','#A93226','#7D3C98','#B7950B','#1C2833','#0E6655'];

// budgetType: 'avg' = ì›”í‰ê·  ìë™ê³„ì‚°, 'fixed' = ê³ ì •ê¸ˆì•¡
const DEF_P=[
  {name:'ì™¸ì‹',emoji:'ğŸ½ï¸',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ì¹´í˜',emoji:'â˜•',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ë²„ìŠ¤/ì§€í•˜ì² ',emoji:'ğŸšŒ',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'íƒì‹œ',emoji:'ğŸš•',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'í†µì‹ ',emoji:'ğŸ“±',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'ë¨¸ë¦¬',emoji:'ğŸ’‡',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ì ê¸ˆ',emoji:'ğŸ’°',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'ë³´í—˜',emoji:'ğŸ›¡ï¸',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'ë¬¸í™”',emoji:'ğŸ¬',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ìœ ì§€ë¹„',emoji:'ğŸ”§',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'í• ë¶€',emoji:'ğŸ’³',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'ê¸°íƒ€',emoji:'ğŸ“¦',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ë¯¸ì„¤ì •',emoji:'â“',budgetType:'avg',seedAmt:0,seedMonths:0},
];

// ì ê¸ˆ í•˜ìœ„í•­ëª© = DEF_ASSETSì™€ ë™ì¼ ìˆœì„œ
const SAVINGS_CAT = 'ì ê¸ˆ'; // ì ê¸ˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„
const DEF_J=[
  {name:'ì™¸ì‹',emoji:'ğŸ½ï¸',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ì¹´í˜',emoji:'â˜•',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ê°€ìŠ¤',emoji:'ğŸ”¥',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ê´€ë¦¬ë¹„',emoji:'ğŸ¢',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'í™ˆ',emoji:'ğŸ¡',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ë¬¸í™”',emoji:'ğŸ¬',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ëŒ€ì¶œ',emoji:'ğŸ¦',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'ê¸°íƒ€',emoji:'ğŸ“¦',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ë¯¸ì„¤ì •',emoji:'â“',budgetType:'avg',seedAmt:0,seedMonths:0},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = 'hb5';

// ìì‚° ì •ì˜
const DEF_ASSETS = [
  {id:'coin',  name:'ì½”ì¸',     emoji:'ğŸª™', color:'#F59E0B'},
  {id:'gold',  name:'ê¸ˆ',       emoji:'ğŸ¥‡', color:'#D97706'},
  {id:'chung', name:'ì²­ì•½ì €ì¶•', emoji:'ğŸ ', color:'#2D5016'},
  {id:'isa',   name:'ISA',      emoji:'ğŸ“ˆ', color:'#0891B2'},
  {id:'stock', name:'ì£¼ì‹',     emoji:'ğŸ“Š', color:'#7C3AED'},
  {id:'irp',   name:'IRP',      emoji:'ğŸ›¡ï¸', color:'#DC2626'},
  {id:'pension',name:'ì—°ê¸ˆì €ì¶•',emoji:'ğŸ¦', color:'#1A4A7A'},
];

function defaultState() {
  return {
    month: new Date().toISOString().slice(0,7),
    ms: {},   // "YYYY-MM": { pAccBal, pCashBal, pPrevCard, jBal, assets:{id:bal} }
    txs: [],  // { id, amount, desc, date, category, payment, type, assetId? }
    pCats: DEF_P.map((c,i) => ({...c, color:PC[i%PC.length]})),
    jCats: DEF_J.map((c,i) => ({...c, color:JC[i%JC.length]})),
    // assetCats: ê°œì¸ ê³ ì •ë¹„ ì¹´í…Œê³ ë¦¬ ì¤‘ ìì‚°ê³¼ ì—°ê²°ëœ catName â†’ assetId ë§¤í•‘
    assetLinks: {}, // { catName: assetId }
  };
}

let S = (() => {
  try {
    const r = localStorage.getItem(STORAGE_KEY);
    if (r) {
      const p = JSON.parse(r);
      // ë§ˆì´ê·¸ë ˆì´ì…˜: êµ¬ë²„ì „ í•„ë“œ ì²˜ë¦¬
      Object.keys(p.ms||{}).forEach(k => {
        if (p.ms[k].pBal !== undefined && p.ms[k].pAccBal === undefined) {
          p.ms[k].pAccBal = p.ms[k].pBal; p.ms[k].pCashBal = 0; p.ms[k].pPrevCard = 0;
          delete p.ms[k].pBal;
        }
        if (p.ms[k].pPrevCard === undefined) p.ms[k].pPrevCard = 0;
      });
      // ë§ˆì´ê·¸ë ˆì´ì…˜: budgetType ì—†ëŠ” ì¹´í…Œê³ ë¦¬
      (p.pCats||[]).forEach(c => { if (!c.budgetType) c.budgetType = 'avg'; });
      (p.jCats||[]).forEach(c => { if (!c.budgetType) c.budgetType = 'avg'; });
      // budgets ìŠ¤ëƒ…ìƒ·ì€ ensureMonthBudgets()ì—ì„œ ìë™ ìƒì„±
      if (!p.assetLinks) p.assetLinks = {};
      // ë§ˆì´ê·¸ë ˆì´ì…˜: ë¯¸ì„¤ì • ì¹´í…Œê³ ë¦¬ ì¶”ê°€
      if (!p.pCats.find(c=>c.name==='ë¯¸ì„¤ì •'))
        p.pCats.push({name:'ë¯¸ì„¤ì •',emoji:'â“',budgetType:'avg',seedAmt:0,seedMonths:0,color:'#9CA3AF'});
      if (!p.jCats.find(c=>c.name==='ë¯¸ì„¤ì •'))
        p.jCats.push({name:'ë¯¸ì„¤ì •',emoji:'â“',budgetType:'avg',seedAmt:0,seedMonths:0,color:'#9CA3AF'});
      // ë§ˆì´ê·¸ë ˆì´ì…˜: ì²­ì•½ ì¹´í…Œê³ ë¦¬ â†’ ì ê¸ˆìœ¼ë¡œ rename
      p.txs = (p.txs||[]).map(x => x.category==='ì²­ì•½' ? {...x, category:'ì ê¸ˆ', assetId:'chung'} : x);
      // ê¸°ì¡´ pCatsì—ì„œ ì²­ì•½ ì œê±°, ì ê¸ˆì— assetId ì—†ìœ¼ë©´ ìœ ì§€
      p.pCats = (p.pCats||[]).filter(c => c.name !== 'ì²­ì•½');
      if (!p.pCats.find(c=>c.name==='ì ê¸ˆ')) {
        p.pCats.splice(6, 0, {name:'ì ê¸ˆ',emoji:'ğŸ’°',budgetType:'fixed',seedAmt:0,seedMonths:0,color:'#B7950B'});
      }
      return p;
    }
  } catch(e) {}
  return defaultState();
})();

function save() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(S)); } catch(e) {} }
function todayStr() { return new Date().toISOString().slice(0,10); }

// â”€â”€ ìì‚° ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì›” ë¬¸ìì—´ í—¬í¼
function prevMonthStr(month) {
  const [y,m] = month.split('-').map(Number);
  const d = new Date(y, m-2, 1);
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
}

// ì›”ì´ˆ ì”ì•¡: ìˆ˜ë™ ì…ë ¥ ìš°ì„ , ì—†ìœ¼ë©´ ê³¼ê±°ë¡œ ê±°ìŠ¬ëŸ¬ ì˜¬ë¼ê°€ ì”ì•¡ ëˆ„ì  (ì¬ê·€ ì—†ìŒ)
function getAssetOpening(assetId, targetMonth) {
  // targetMonth í¬í•¨ ì´ì „ ë‹¬ë“¤ì„ ìˆœì„œëŒ€ë¡œ íƒìƒ‰, ìˆ˜ë™ ì…ë ¥ëœ ê°€ì¥ ìµœê·¼ ë‹¬ ì°¾ê¸°
  const MAX_LOOKBACK = 24; // ìµœëŒ€ 24ê°œì›” ì´ì „ê¹Œì§€ë§Œ
  let cursor = targetMonth;
  const monthsToAccum = []; // ìˆ˜ë™ ì…ë ¥ ë‹¬ ì´í›„ ~ targetMonth ì´ì „ê¹Œì§€ ëˆ„ì í•  ë‹¬ë“¤

  for (let i = 0; i < MAX_LOOKBACK; i++) {
    const manual = ((S.ms[cursor]||{}).assets||{})[assetId];
    if (manual !== undefined) {
      // ì´ ë‹¬ì— ìˆ˜ë™ ì…ë ¥ ì¡´ì¬ â†’ ì´ ë‹¬ ì”ì•¡(ìˆ˜ë™+ì ë¦½)ì„ ê¸°ì¤€ìœ¼ë¡œ ì´í›„ ë‹¬ ì ë¦½ ëˆ„ì 
      let bal = manual;
      for (const m of monthsToAccum) {
        bal += S.txs.filter(x =>
          x.date.startsWith(m) && x.type==='personal' &&
          x.category===SAVINGS_CAT && x.assetId===assetId
        ).reduce((s,x) => s+x.amount, 0);
      }
      return bal;
    }
    // ì´ ë‹¬ë„ ìˆ˜ë™ ì…ë ¥ ì—†ìŒ â†’ ì „ì›”ë¡œ
    monthsToAccum.unshift(cursor); // ì•ì— ì¶”ê°€ (ì˜¤ë˜ëœ ìˆœ)
    cursor = prevMonthStr(cursor);
  }
  return 0; // 24ê°œì›” ë‚´ ìˆ˜ë™ ì…ë ¥ ì—†ìœ¼ë©´ 0
}

// ìì‚° í˜„ì¬ì”ì•¡ = ì›”ì´ˆì”ì•¡ + ì´ë²ˆë‹¬ ì ë¦½
function getAssetBal(assetId, month) {
  month = month || S.month;
  const opening = getAssetOpening(assetId, month);
  const deposited = S.txs.filter(x =>
    x.date.startsWith(month) && x.type==='personal' &&
    x.category===SAVINGS_CAT && x.assetId===assetId
  ).reduce((s,x) => s+x.amount, 0);
  return { opening, deposited, balance: opening + deposited };
}
function fmt(n) { return 'â‚©'+Math.abs(Math.round(n)).toLocaleString('ko-KR'); }
function fmtDiff(n) { return (n>=0?'+':'-')+'â‚©'+Math.abs(Math.round(n)).toLocaleString('ko-KR'); }
function cats(t) { return t==='personal' ? S.pCats : S.jCats; }
function txOfMonth(t, month) { const m=month||S.month; return S.txs.filter(x=>x.date.startsWith(m)&&x.type===t); }
// dir: 'expense'(ê¸°ë³¸) ë˜ëŠ” 'income'
function txOfMonthDir(t, dir, month) {
  const m=month||S.month;
  return S.txs.filter(x=>x.date.startsWith(m)&&x.type===t&&(x.dir||'expense')===dir);
}
function catSpend(name, list) { return list.filter(x=>x.category===name).reduce((s,x)=>s+x.amount,0); }
function catIncome(name, list) { return list.filter(x=>x.category===name).reduce((s,x)=>s+x.amount,0); }
// ì¹´í…Œê³ ë¦¬ ìˆœì§€ì¶œ = ì§€ì¶œ - ìˆ˜ì… (ìŒìˆ˜ ê°€ëŠ¥)
function catNetSpend(name, type) {
  const spent  = catSpend(name, txOfMonthDir(type,'expense'));
  const income = catSpend(name, txOfMonthDir(type,'income'));
  return spent - income;
}
function getMs(month) { return S.ms[month||S.month]||{}; }

// â”€â”€ ëˆ„ì  ì›”í‰ê·  ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appMonthsRecorded(type) {
  return new Set(S.txs.filter(x=>x.type===type).map(x=>x.date.slice(0,7))).size;
}
function appTotalForCat(catName, type) {
  return S.txs.filter(x=>x.type===type&&x.category===catName).reduce((s,x)=>s+x.amount,0);
}

// â”€â”€ ì˜ˆì‚° ìŠ¤ëƒ…ìƒ· ì‹œìŠ¤í…œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë‹¹ì›” ì˜ˆì‚°ì€ ì›”ì´ˆì— í•œ ë²ˆ í™•ì • â†’ ms[month].budgets ì— ì €ì¥.
// ê³„ì‚°ì€ "í•´ë‹¹ ì›” ì´ì „" ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ë‹¹ì›” ì§€ì¶œì´ ì˜ˆì‚°ì— ì˜í–¥ ì—†ìŒ.

function calcBudgetForSnapshot(cat, type, beforeMonth) {
  // beforeMonth ì´ì „ ë‹¬ê¹Œì§€ì˜ ë°ì´í„°ë§Œìœ¼ë¡œ ì˜ˆì‚° ê³„ì‚°
  if (cat.budgetType === 'fixed') return cat.seedAmt || 0;
  const pastTxs = S.txs.filter(x=>x.type===type && x.category===cat.name && x.date.slice(0,7) < beforeMonth);
  const pastMonths = new Set(S.txs.filter(x=>x.type===type && x.date.slice(0,7) < beforeMonth).map(x=>x.date.slice(0,7))).size;
  const appTotal = pastTxs.reduce((s,x)=>s+x.amount,0);
  const totalMonths = (cat.seedMonths||0) + pastMonths;
  if (totalMonths === 0) return 0;
  return Math.round(((cat.seedAmt||0)*(cat.seedMonths||0) + appTotal) / totalMonths);
}

function ensureMonthBudgets(month) {
  // í•´ë‹¹ ì›” ìŠ¤ëƒ…ìƒ·ì´ ì—†ìœ¼ë©´ ìƒì„±
  month = month || S.month;
  if (!S.ms[month]) S.ms[month] = {};
  if (S.ms[month].budgets) return;
  const snap = { personal:{}, joint:{} };
  ['personal','joint'].forEach(type => {
    cats(type).forEach(c => { snap[type][c.name] = calcBudgetForSnapshot(c, type, month); });
  });
  S.ms[month].budgets = snap;
  save();
}

function getMonthBudget(catName, type, month) {
  month = month || S.month;
  const snap = (S.ms[month]||{}).budgets;
  if (snap && snap[type] && snap[type][catName] !== undefined) return snap[type][catName];
  // ìŠ¤ëƒ…ìƒ· ì—†ìœ¼ë©´ ì¦‰ì‹œ ê³„ì‚° (í‘œì‹œìš©)
  const cat = cats(type).find(c=>c.name===catName);
  return cat ? calcBudgetForSnapshot(cat, type, month) : 0;
}

function calcBudgetPreview(cat, type) {
  // ì„¤ì • í™”ë©´ìš©: S.month í¬í•¨ ì „ì²´ ëˆ„ì ìœ¼ë¡œ ë‹¤ìŒë‹¬ ì˜ˆìƒ ì˜ˆì‚° ê³„ì‚°
  // ì˜ˆ) 2ì›” ê¸°ì¡´í‰ê·  10ë§ŒÃ—3ê°œì›”, 2ì›” ì§€ì¶œ 8ë§Œ â†’ 3ì›” ì˜ˆì‚° = (10ë§ŒÃ—3 + 8ë§Œ) Ã· 4 = 9.5ë§Œ
  if (cat.budgetType === 'fixed') return cat.seedAmt || 0;
  // S.month ì´í•˜(<=) ëª¨ë“  ë‹¬ í¬í•¨
  const allTxs = S.txs.filter(x=>x.type===type && x.category===cat.name && x.date.slice(0,7) <= S.month);
  const allMonths = new Set(S.txs.filter(x=>x.type===type && x.date.slice(0,7) <= S.month).map(x=>x.date.slice(0,7))).size;
  const appTotal = allTxs.reduce((s,x)=>s+x.amount,0);
  const totalMonths = (cat.seedMonths||0) + allMonths;
  if (totalMonths === 0) return 0;
  return Math.round(((cat.seedAmt||0)*(cat.seedMonths||0) + appTotal) / totalMonths);
}

function resetMonthBudgets(month) {
  // ì„¤ì • ë³€ê²½ ì‹œ ë‹¹ì›” ìŠ¤ëƒ…ìƒ· ê°•ì œ ì¬ìƒì„±
  month = month || S.month;
  if (S.ms[month]) delete S.ms[month].budgets;
  ensureMonthBudgets(month);
}

function fixedTotal(type, month) {
  month = month || S.month;
  return cats(type).reduce((s,c) => s + getMonthBudget(c.name, type, month), 0);
}

function overBudget(type) {
  return cats(type).reduce((s,c) => {
    const bud = getMonthBudget(c.name, type);
    const net = catNetSpend(c.name, type); // ì§€ì¶œ - ìˆ˜ì…
    return net > bud ? s+(net-bud) : s;
  }, 0);
}

// â”€â”€ ê°œì¸ ì”ì•¡ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcPersonalRemain(ms) {
  ms = ms || getMs();
  const accOpen  = ms.pAccBal   || 0;
  const cashOpen = ms.pCashBal  || 0;
  const prevCard = ms.pPrevCard || 0;
  const pExpList = txOfMonthDir('personal','expense');
  const pIncList = txOfMonthDir('personal','income');

  // ì§€ì¶œ
  const accSpent  = pExpList.filter(x=>x.payment==='account').reduce((s,x)=>s+x.amount,0);
  const cashSpent = pExpList.filter(x=>x.payment==='cash').reduce((s,x)=>s+x.amount,0);
  const cardSpent = pExpList.filter(x=>x.payment==='card').reduce((s,x)=>s+x.amount,0);
  const jCardAmt  = txOfMonthDir('joint','expense').filter(x=>x.payment==='card').reduce((s,x)=>s+x.amount,0);

  // ìˆ˜ì…
  const accIncome  = pIncList.filter(x=>x.payment==='account').reduce((s,x)=>s+x.amount,0);
  const cashIncome = pIncList.filter(x=>x.payment==='cash').reduce((s,x)=>s+x.amount,0);
  const totalIncome = accIncome + cashIncome;

  // ì‹¤ì œ ì”ì•¡ (ìˆ˜ì… í¬í•¨)
  const actualAccBal  = accOpen  - accSpent  + accIncome  + jCardAmt;
  const actualCashBal = cashOpen - cashSpent + cashIncome;

  // ì—¬ìœ ìê¸ˆ = (ì›”ì´ˆì”ê³  + ìˆ˜ì…) - ê³ ì •ë¹„ì˜ˆì‚° - ì „ì›”ì¹´ë“œ - ì´ˆê³¼ì§€ì¶œ
  const fixed = fixedTotal('personal');
  const totalOpening = accOpen + cashOpen;
  const over  = overBudget('personal');
  const flex  = totalOpening - fixed - prevCard;  // ìˆ˜ì…ì€ catNetSpendâ†’overBudgetì—ì„œ ë°˜ì˜
  const remain = flex - over;
  const totalActual = actualAccBal + actualCashBal;
  return { accOpen, cashOpen, prevCard, fixed, flex, remain, over,
           accSpent, cashSpent, cardSpent, jCardAmt,
           accIncome, cashIncome, totalIncome,
           actualAccBal, actualCashBal, totalActual };
}

// â”€â”€ ê³µë™ ì”ì•¡ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcJointRemain(ms) {
  ms = ms || getMs();
  const opening = ms.jBal || 0;
  const jExpList = txOfMonthDir('joint','expense');
  const jIncList = txOfMonthDir('joint','income');
  const totalSpent   = jExpList.reduce((s,x)=>s+x.amount,0);
  const cardSpent    = jExpList.filter(x=>x.payment==='card').reduce((s,x)=>s+x.amount,0);
  const accSpent     = jExpList.filter(x=>x.payment==='account').reduce((s,x)=>s+x.amount,0);
  const accIncome    = jIncList.filter(x=>x.payment==='account').reduce((s,x)=>s+x.amount,0);
  const cashIncome   = jIncList.filter(x=>x.payment==='cash').reduce((s,x)=>s+x.amount,0);
  const totalIncome  = accIncome + cashIncome;
  return { opening, totalSpent, cardSpent, accSpent,
           accIncome, cashIncome, totalIncome,
           remain: opening - totalSpent };  // ìˆ˜ì…ì€ catNetSpendâ†’overBudgetì—ì„œ ë°˜ì˜
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONTH NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changeMonth(d) {
  const [y,m]=S.month.split('-').map(Number);
  const nd=new Date(y,m-1+d,1);
  S.month=`${nd.getFullYear()}-${String(nd.getMonth()+1).padStart(2,'0')}`;
  ensureMonthBudgets(S.month);
  save(); render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mainTab='overview', subTab='personal';

function switchMain(t) {
  mainTab=t;
  document.querySelectorAll('.ntab').forEach((el,i)=>el.classList.toggle('active',['overview','transactions','assets','settle','settings'][i]===t));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+t).classList.add('active');
  const showSub = (t==='overview'||t==='transactions'||t==='settle');
  document.getElementById('subTabRow').style.display = showSub?'flex':'none';
  if(t==='transactions') { txFilter='all'; renderTxFilter(); }
  applySubTab();
}

function switchSub(s) {
  subTab=s;
  ['personal','joint'].forEach(x=>{
    document.getElementById('st-'+x).className='stab'+(s===x?` active ${x}`:` ${x}`);
  });
  document.getElementById('fab').style.background=s==='personal'?'var(--p)':'var(--j)';
  txFilter='all';
  if(mainTab==='transactions') renderTxFilter();
  applySubTab();
}

function applySubTab() {
  const sp=subTab==='personal';
  ['ov-p','ov-j'].forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.style.display=i===0?(sp?'block':'none'):(sp?'none':'block'); });
  ['tx-p','tx-j'].forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.style.display=i===0?(sp?'block':'none'):(sp?'none':'block'); });
  ['settle-p','settle-j'].forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.style.display=i===0?(sp?'block':'none'):(sp?'none':'block'); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  document.getElementById('monthLabel').textContent=parseInt(S.month.split('-')[1])+'ì›”';
  renderOv('personal'); renderOv('joint');
  renderTx('personal'); renderTx('joint');
  renderSettle('personal'); renderSettle('joint');
  renderAssets();
  renderSettingsPage();
}

// â”€â”€ Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOv(t) {
  const ms = getMs();
  const list = txOfMonth(t);

  if (t==='personal') {
    const r = calcPersonalRemain(ms);
    const remain = r.remain;
    document.getElementById('p-amt').textContent = remain<0?`-${fmt(remain)}`:fmt(remain);
    document.getElementById('p-amt').className='balamt'+(remain<0?' danger':'');
    document.getElementById('p-lbl').textContent=remain<0?'ì—¬ìœ ìê¸ˆ ì´ˆê³¼':'ì—¬ìœ ìê¸ˆ ì”ì•¡';
    document.getElementById('p-acc-bal').textContent=fmt(r.actualAccBal);
    document.getElementById('p-cash-bal').textContent=fmt(r.actualCashBal);
    document.getElementById('p-fixed').textContent=fmt(r.fixed);
    document.getElementById('p-acc-open').textContent=fmt(r.accOpen);
    document.getElementById('p-cash-open').textContent=fmt(r.cashOpen);
    document.getElementById('p-prev-card').textContent=r.prevCard>0?`-${fmt(r.prevCard)}`:'ì—†ìŒ';

    const pct=Math.min(100,r.over/Math.max(r.flex,1)*100);
    const bar=document.getElementById('p-bar');
    bar.style.width=pct+'%';
    bar.className='pfill '+(pct<60?'p-ok':pct<90?'warn':'over');

    const alertEl=document.getElementById('p-alert');
    if(r.over>0){
      alertEl.innerHTML=remain<0
        ?`<div class="alert over"><strong>âš  ì—¬ìœ ìê¸ˆ ì´ˆê³¼</strong>ê³ ì •ë¹„ ì´ˆê³¼ë¶„ì´ ì—¬ìœ ìê¸ˆì„ ${fmt(Math.abs(remain))} ë„˜ì—ˆìŠµë‹ˆë‹¤.</div>`
        :`<div class="alert warn"><strong>ğŸ’¡ ê³ ì •ë¹„ ì´ˆê³¼</strong>ì—¬ìœ ìê¸ˆì—ì„œ ${fmt(r.over)} ì°¨ê°ë©ë‹ˆë‹¤.</div>`;
    } else { alertEl.innerHTML=''; }

    // ìˆ˜ì… í‘œì‹œ
    document.getElementById('p-acc-income').textContent=r.accIncome>0?`+${fmt(r.accIncome)}`:'â‚©0';
    document.getElementById('p-cash-income').textContent=r.cashIncome>0?`+${fmt(r.cashIncome)}`:'â‚©0';
    const pIncList = txOfMonthDir('personal','income');
    document.getElementById('p-income-cats').innerHTML=renderIncomeCatList('personal', pIncList);

    document.getElementById('p-acc-spent').textContent=fmt(r.accSpent);
    document.getElementById('p-cash-spent').textContent=fmt(r.cashSpent);
    document.getElementById('p-card-spent').textContent=fmt(r.cardSpent);
    document.getElementById('p-jcard-rebate').textContent=r.jCardAmt>0?`+${fmt(r.jCardAmt)}`:'â‚©0';

    const rebateEl=document.getElementById('p-rebate');
    const notes=[];
    if(r.cardSpent>0) notes.push(`ğŸ’³ ì¹´ë“œ ${fmt(r.cardSpent)} â†’ ê³„ì¢Œ ì”ì•¡ ë³€ë™ ì—†ìŒ Â· ì—¬ìœ ìê¸ˆì—ì„œ ì°¨ê°`);
    if(r.jCardAmt>0) notes.push(`ğŸ”„ ê³µë™ì¹´ë“œ ${fmt(r.jCardAmt)} â†’ ê³µë™ì”ì•¡ ì°¨ê° + ê°œì¸ê³„ì¢Œ ë³´ì „`);
    if(r.prevCard>0) notes.push(`ğŸ“… ì „ì›”ì¹´ë“œ ${fmt(r.prevCard)} â†’ ì—¬ìœ ìê¸ˆì—ì„œ ì°¨ê°`);
    rebateEl.innerHTML=notes.length?`<div style="font-size:11px;color:var(--muted);background:var(--s2);border-radius:8px;padding:8px 12px;margin-top:8px;line-height:1.9">${notes.join('<br>')}</div>`:'';

    const pExpList = txOfMonthDir('personal','expense');
    document.getElementById('p-cats').innerHTML=renderCatList('personal', pExpList);

  } else {
    const r = calcJointRemain(ms);
    const jOver = overBudget('joint');
    const jRemain = r.remain - jOver;
    document.getElementById('j-amt').textContent=jRemain<0?`-${fmt(jRemain)}`:fmt(jRemain);
    document.getElementById('j-amt').className='balamt'+(jRemain<0?' danger':'');
    document.getElementById('j-lbl').textContent=jRemain<0?'ì´ˆê³¼':'ì”ì•¡';
    document.getElementById('j-open').textContent=fmt(r.opening);
    document.getElementById('j-fixed').textContent=fmt(fixedTotal('joint'));

    const pct=Math.min(100,r.totalSpent/Math.max(r.opening,1)*100);
    const bar=document.getElementById('j-bar');
    bar.style.width=pct+'%';
    bar.className='pfill '+(pct<60?'j-ok':pct<90?'warn':'over');

    document.getElementById('j-alert').innerHTML=r.remain<0
      ?`<div class="alert over"><strong>âš  ê³µë™ ì”ì•¡ ë¶€ì¡±</strong>${fmt(Math.abs(r.remain))} ì´ˆê³¼ ì§€ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.</div>`:'';
    // ìˆ˜ì… í‘œì‹œ
    document.getElementById('j-acc-income').textContent=r.accIncome>0?`+${fmt(r.accIncome)}`:'â‚©0';
    document.getElementById('j-cash-income').textContent=r.cashIncome>0?`+${fmt(r.cashIncome)}`:'â‚©0';
    const jIncList = txOfMonthDir('joint','income');
    document.getElementById('j-income-cats').innerHTML=renderIncomeCatList('joint', jIncList);

    document.getElementById('j-total').textContent=fmt(r.totalSpent);
    document.getElementById('j-card').textContent=fmt(r.cardSpent);

    const bdEl=document.getElementById('j-breakdown');
    if(r.cardSpent>0||r.accSpent>0){
      bdEl.innerHTML=`<div style="font-size:11px;color:var(--muted);margin-top:8px;line-height:1.9">
        ğŸ¦ ê³„ì¢Œ ${fmt(r.accSpent)} â†’ ì¦‰ì‹œ ì°¨ê°<br>
        ğŸ’³ ì¹´ë“œ ${fmt(r.cardSpent)} â†’ ê³µë™ ì°¨ê° + ê°œì¸ ê³„ì¢Œ ë³´ì „
      </div>`;
    } else { bdEl.innerHTML=''; }
    const jExpList = txOfMonthDir('joint','expense');
    document.getElementById('j-cats').innerHTML=renderCatList('joint', jExpList);
  }
}

function renderIncomeCatList(type, incList) {
  if (!incList.length) return '<div style="font-size:12px;color:var(--muted);padding:6px 0">ì´ë²ˆ ë‹¬ ìˆ˜ì… ì—†ìŒ</div>';
  // ì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„
  const incCats = cats(type);
  const rows = incCats.map(c => {
    const amt = incList.filter(x=>x.category===c.name).reduce((s,x)=>s+x.amount,0);
    if (!amt) return '';
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);">
      <span style="font-size:13px">${c.emoji} ${c.name}</span>
      <span style="font-family:'DM Mono',monospace;font-size:13px;font-weight:600;color:var(--ok)">+${fmt(amt)}</span>
    </div>`;
  }).filter(Boolean).join('');
  // ì¹´í…Œê³ ë¦¬ ì—†ëŠ” ê¸°íƒ€ ìˆ˜ì…
  const knownCats = incCats.map(c=>c.name);
  const etc = incList.filter(x=>!knownCats.includes(x.category)).reduce((s,x)=>s+x.amount,0);
  const etcRow = etc>0 ? `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;">
    <span style="font-size:13px">ğŸ“¥ ê¸°íƒ€</span>
    <span style="font-family:'DM Mono',monospace;font-size:13px;font-weight:600;color:var(--ok)">+${fmt(etc)}</span>
  </div>` : '';
  return `<div style="margin-top:8px">${rows}${etcRow}</div>`;
}

function renderCatList(type, list) {
  return cats(type).map(c=>{
    const bud = getMonthBudget(c.name, type);
    const sp  = catSpend(c.name, list);                  // ìˆœìˆ˜ ì§€ì¶œ
    const inc = catSpend(c.name, txOfMonthDir(type,'income')); // ìˆ˜ì…
    const net = Math.max(0, sp - inc);                   // ìˆœì§€ì¶œ (0 ì´í•˜ë©´ 0)
    const pct = bud>0 ? Math.min(100, net/bud*100) : 0;
    const isOver = net>bud && bud>0;
    const typeBadge=c.budgetType==='fixed'
      ?`<span style="font-size:9px;color:#5555AA;background:#F0F0FF;padding:1px 5px;border-radius:8px;margin-left:4px">ê³ ì •</span>`
      :`<span style="font-size:9px;color:var(--p);background:var(--plt);padding:1px 5px;border-radius:8px;margin-left:4px">í‰ê· </span>`;
    const incBadgeRow = inc>0
      ? `<span style="font-size:9px;color:var(--ok);background:var(--olt);padding:1px 5px;border-radius:8px;margin-left:4px">-${fmt(inc)}</span>`
      : '';
    return `<div class="crow">
      <div class="cdot" style="background:${c.color}"></div>
      <div class="cinfo">
        <div class="cname">${c.emoji} ${c.name}${typeBadge}${incBadgeRow}</div>
        <div class="cbw"><div class="cbf" style="width:${pct}%;background:${isOver?'var(--danger)':c.color}"></div></div>
      </div>
      <div class="cright">
        <div class="cspent" style="color:${isOver?'var(--danger)':'var(--text)'}">${fmt(net)}${inc>0?`<span style="font-size:10px;color:var(--muted)"> (${fmt(sp)})</span>`:''}</div>
        <div class="cbudget">/ ${bud>0?fmt(bud):'ë¯¸ì„¤ì •'}</div>
      </div>
    </div>`;
  }).join('')||'<div style="color:var(--muted);font-size:13px;padding:6px 0">ë‚´ì—­ ì—†ìŒ</div>';
}

// â”€â”€ Transactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í•„í„° ìƒíƒœ: 'all' | 'income' | 'expense' | 'date' | 'cat:ì¹´í…Œê³ ë¦¬ëª…'
let txFilter = 'all';

function setTxFilter(f) {
  txFilter = f;
  renderTxFilter();
  renderTx('personal');
  renderTx('joint');
}

function renderTxFilter() {
  const t = subTab;
  const actCls = t==='personal' ? 'p-act' : 'j-act';
  const catList = cats(t);
  const filters = [
    {id:'all',   label:'ì „ì²´'},
    {id:'date',  label:'ì¼ë³„'},
    {id:'income',label:'ìˆ˜ì…'},
    {id:'expense',label:'ì§€ì¶œ'},
    ...catList.map(c=>({id:`cat:${c.name}`, label:`${c.emoji} ${c.name}`})),
  ];
  document.getElementById('txfilter').innerHTML = filters.map(f=>
    `<button class="txftab${txFilter===f.id?' active '+actCls:''}" onclick="setTxFilter('${f.id}')">${f.label}</button>`
  ).join('');
}

function txItemHtml(x, cl) {
  const cat=cl.find(c=>c.name===x.category)||{};
  const color=cat.color||'#9CA3AF';
  const pm=x.payment==='card'?'<span class="badge b-card">ì¹´ë“œ</span>':x.payment==='account'?'<span class="badge b-acc">ê³„ì¢Œ</span>':'<span class="badge b-cash">í˜„ê¸ˆ</span>';
  const assetDef = x.assetId ? DEF_ASSETS.find(a=>a.id===x.assetId) : null;
  const assetBadge = assetDef ? `<span class="badge" style="background:${assetDef.color}22;color:${assetDef.color}">${assetDef.emoji} ${assetDef.name}</span>` : '';
  const isIncome = (x.dir||'expense')==='income';
  const incBadge = isIncome ? '<span class="badge b-income">ìˆ˜ì…</span>' : '';
  const iconEmoji = assetDef ? assetDef.emoji : (cat.emoji||'â“');
  const iconBg = isIncome ? 'var(--olt)' : `${color}22`;
  return `<div class="txitem" onclick="deleteTx('${x.id}')">
    <div class="txicon" style="background:${iconBg}">${iconEmoji}</div>
    <div class="txbody">
      <div class="txname">${x.desc}</div>
      <div class="txmeta">${incBadge}${pm}<span class="badge" style="background:var(--s2);color:var(--muted)">${x.category}</span>${assetBadge}</div>
    </div>
    <div class="txamt" style="color:${isIncome?'var(--ok)':'var(--danger)'}">${isIncome?'+':''}${fmt(x.amount)}</div>
  </div>`;
}

function renderTx(t) {
  const pfx=t==='personal'?'p':'j';
  const el=document.getElementById('tx-'+pfx);
  const cl=cats(t);

  // ì „ì²´ ëª©ë¡
  let all=txOfMonth(t).sort((a,b)=>b.date.localeCompare(a.date)||b.id.localeCompare(a.id));

  // í•„í„° ì ìš©
  let filtered = all;
  if (txFilter==='income')  filtered=all.filter(x=>(x.dir||'expense')==='income');
  else if (txFilter==='expense') filtered=all.filter(x=>(x.dir||'expense')==='expense');
  else if (txFilter.startsWith('cat:')) {
    const catName=txFilter.slice(4);
    filtered=all.filter(x=>x.category===catName);
  }

  if (!filtered.length) {
    el.innerHTML=`<div class="empty"><div class="icon">${t==='personal'?'ğŸ‘¤':'ğŸ‘¥'}</div><p>í•´ë‹¹ ë‚´ì—­ì´ ì—†ì–´ìš”</p></div>`;
    return;
  }

  // ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹
  if (txFilter.startsWith('cat:') && txFilter!=='cat:') {
    const catName=txFilter.slice(4);
    const cat=cl.find(c=>c.name===catName)||{};
    const total=filtered.reduce((s,x)=>s+(((x.dir||'expense')==='income')?-x.amount:x.amount),0);
    let html=`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0 8px;border-bottom:2px solid var(--border);margin-bottom:4px;">
      <span style="font-weight:600">${cat.emoji||'â“'} ${catName}</span>
      <span style="font-family:'DM Mono',monospace;font-size:13px;color:${total<0?'var(--ok)':'var(--text)'}">${fmt(Math.abs(total))}</span>
    </div>`;
    filtered.forEach(x=>{ html+=txItemHtml(x,cl); });
    el.innerHTML=html;
    return;
  }

  // ì¼ë³„ ê·¸ë£¹ (ì „ì²´/ìˆ˜ì…/ì§€ì¶œ/ì¼ë³„)
  const byDate={};
  filtered.forEach(x=>{ if(!byDate[x.date]) byDate[x.date]=[]; byDate[x.date].push(x); });
  let html='';
  Object.keys(byDate).sort((a,b)=>b.localeCompare(a)).forEach(date=>{
    const [,mm,dd]=date.split('-');
    const dayItems=byDate[date];
    const dayExp=dayItems.filter(x=>(x.dir||'expense')==='expense').reduce((s,x)=>s+x.amount,0);
    const dayInc=dayItems.filter(x=>(x.dir||'expense')==='income').reduce((s,x)=>s+x.amount,0);
    let sumHtml='';
    if(dayInc>0&&dayExp>0) sumHtml=`<span style="color:var(--ok)">+${fmt(dayInc)}</span> <span style="color:var(--danger)">-${fmt(dayExp)}</span>`;
    else if(dayInc>0) sumHtml=`<span style="color:var(--ok)">+${fmt(dayInc)}</span>`;
    else sumHtml=`<span>${fmt(dayExp)}</span>`;
    html+=`<div class="txdh"><span>${parseInt(mm)}/${parseInt(dd)}</span><span style="font-size:11px">${sumHtml}</span></div>`;
    dayItems.forEach(x=>{ html+=txItemHtml(x,cl); });
  });
  el.innerHTML=html;
}

// â”€â”€ Settle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSettle(t) {
  const pfx=t==='personal'?'p':'j';
  const list=txOfMonth(t);
  let totalBudget=0, totalSpent=0;

  const rows=cats(t).map(c=>{
    const bud = getMonthBudget(c.name,t);
    const sp  = catSpend(c.name, list);
    const inc = catSpend(c.name, txOfMonthDir(t,'income'));
    const net = Math.max(0, sp - inc); // ìˆœì§€ì¶œ
    const diff = bud - net; // ì–‘ìˆ˜=ì ˆì•½, ìŒìˆ˜=ì´ˆê³¼
    totalBudget+=bud; totalSpent+=net;
    const diffCls=diff>=0?'plus':'minus';
    const typeBadge=c.budgetType==='fixed'
      ?`<span class="srow-type fixed">ê³ ì •</span>`
      :`<span class="srow-type avg">í‰ê· </span>`;
    const incNote = inc>0 ? `<span style="font-size:10px;color:var(--ok);margin-left:4px">-${fmt(inc)}</span>` : '';
    return `<div class="srow">
      <div class="srow-dot" style="background:${c.color}"></div>
      <div class="srow-name">${c.emoji} ${c.name}${typeBadge}${incNote}</div>
      <div class="srow-budget">${bud>0?fmt(bud):'-'}</div>
      <div class="srow-spent" style="color:${net>bud&&bud>0?'var(--danger)':'var(--text)'}">${fmt(net)}</div>
      <div class="srow-diff ${diffCls}">${bud>0?fmtDiff(diff):'-'}</div>
    </div>`;
  }).join('');

  document.getElementById(`s${pfx}-budget`).textContent=fmt(totalBudget);
  document.getElementById(`s${pfx}-spent`).textContent=fmt(totalSpent);
  const totalDiff=totalBudget-totalSpent;
  const diffEl=document.getElementById(`s${pfx}-diff`);
  diffEl.textContent=totalBudget>0?fmtDiff(totalDiff):'-';
  diffEl.style.color=totalDiff>=0?'var(--ok)':'var(--danger)';
  const rateEl=document.getElementById(`s${pfx}-rate`);
  rateEl.textContent=totalBudget>0?Math.round(Math.abs(totalDiff)/totalBudget*100)+'%':'-';
  rateEl.style.color=totalDiff>=0?'var(--ok)':'var(--danger)';
  document.getElementById(`s${pfx}-rows`).innerHTML=rows||'<div style="color:var(--muted);font-size:13px;padding:12px 0;text-align:center">ì§€ì¶œ ë‚´ì—­ ì—†ìŒ</div>';
}

// â”€â”€ Assets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAssets() {
  let totalBal = 0, totalDeposited = 0, totalOpening = 0;

  const cards = DEF_ASSETS.map(a => {
    const r = getAssetBal(a.id);
    totalBal      += r.balance;
    totalOpening  += r.opening;
    totalDeposited += r.deposited;

    // ì›”ì´ˆ ì”ì•¡ ì¶œì²˜ í™•ì¸
    const ms = getMs();
    const isManual = (ms.assets||{})[a.id] !== undefined;
    const openingLabel = isManual ? 'ğŸ“Œ ì›”ì´ˆ ì”ì•¡' : 'ğŸ”„ ì „ì›” ì´ì›”';

    // ì´ë²ˆë‹¬ ì ë¦½ ë‚´ì—­ ëª©ë¡
    const depTxs = S.txs.filter(x =>
      x.date.startsWith(S.month) && x.type==='personal' &&
      x.category===SAVINGS_CAT && x.assetId===a.id
    ).sort((a,b)=>a.date.localeCompare(b.date));

    const depRows = depTxs.length > 0
      ? depTxs.map(x =>
          `<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);padding:2px 0 2px 20px;">
            <span>${parseInt(x.date.slice(8))}ì¼ ${x.desc}</span>
            <span style="font-family:'DM Mono',monospace;color:var(--ok)">+${fmt(x.amount)}</span>
          </div>`
        ).join('')
      : '';

    return `<div class="asset-card" style="flex-direction:column;align-items:stretch;gap:0;">
      <!-- í—¤ë” í–‰ -->
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:${depRows?'10px':'0'}">
        <div class="asset-icon" style="background:${a.color}22">${a.emoji}</div>
        <div class="asset-body">
          <div class="asset-name">${a.name}</div>
          <div class="asset-sub" style="display:flex;gap:10px;margin-top:2px">
            <span>${openingLabel} ${fmt(r.opening)}</span>
            ${r.deposited>0?`<span style="color:var(--ok)">+${fmt(r.deposited)} ì ë¦½</span>`:''}
          </div>
        </div>
        <div class="asset-right">
          <div class="asset-bal" style="color:${a.color}">${fmt(r.balance)}</div>
          <div style="font-size:10px;color:var(--muted);text-align:right;margin-top:2px">í˜„ì¬ ì”ì•¡</div>
        </div>
      </div>
      <!-- ì ë¦½ ìƒì„¸ -->
      ${depRows ? `<div style="border-top:1px solid var(--border);padding-top:8px;">${depRows}</div>` : ''}
      <!-- ì”ì•¡ ì§„í–‰ë°” (ì „ì²´ ëŒ€ë¹„ ë¹„ì¤‘) -->
      <div class="pbar" style="margin-top:${depRows?'8px':'6px'}">
        <div class="pfill" style="background:${a.color};width:__PCT_${a.id}__"></div>
      </div>
    </div>`;
  }).join('');

  const delta = totalBal - totalOpening;
  document.getElementById('asset-total').textContent = fmt(totalBal);
  document.getElementById('asset-delta').textContent = (delta>=0?'+':'-')+'â‚©'+Math.abs(Math.round(delta)).toLocaleString('ko-KR');
  document.getElementById('asset-delta').style.color = delta>=0?'rgba(255,255,255,.9)':'#FCA5A5';
  document.getElementById('asset-deposit').textContent = fmt(totalDeposited);

  // ë¹„ì¤‘ ê³„ì‚° í›„ ì§„í–‰ë°” ì¹˜í™˜
  let html = cards;
  DEF_ASSETS.forEach(a => {
    const r = getAssetBal(a.id);
    const pct = totalBal > 0 ? Math.round(r.balance / totalBal * 100) : 0;
    html = html.replace(`__PCT_${a.id}__`, pct + '%');
  });
  document.getElementById('asset-list').innerHTML = html;
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSettingsPage() {
  const ms=getMs();
  const fields=[['set-p-acc','pAccBal'],['set-p-cash','pCashBal'],['set-p-prev-card','pPrevCard'],['set-j-bal','jBal']];
  fields.forEach(([id,key])=>{ const el=document.getElementById(id); if(el&&document.activeElement!==el) el.value=ms[key]||''; });
  renderBudgetSection('personal');
  renderBudgetSection('joint');
  renderAssetSettings();
}

function renderBudgetSection(type) {
  const pfx=type==='personal'?'p':'j';
  const col=type==='personal'?'p-col':'j-col';
  const appMonths=appMonthsRecorded(type);

  document.getElementById(`set-${pfx}-budgets`).innerHTML=cats(type).map((c,i)=>{
    const bud=getMonthBudget(c.name,type);
    const nextBud=calcBudgetPreview(c,type);
    const isFixed=c.budgetType==='fixed';
    const totalM=(c.seedMonths||0)+appMonths;

    let fieldsHtml;
    if (isFixed) {
      fieldsHtml=`<div class="brow-line">
        <span>ê³ ì •ê¸ˆì•¡</span>
        <input type="number" class="sinp sinp-sm" value="${c.seedAmt||''}" placeholder="0"
          onchange="updCatField('${type}',${i},'seedAmt',this.value)" title="ë§¤ë‹¬ ë™ì¼í•˜ê²Œ ë‚˜ê°€ëŠ” ê¸ˆì•¡">
        <span>ì›</span>
      </div>`;
    } else {
      fieldsHtml=`<div class="brow-line">
        <span>ê¸°ì¡´í‰ê· </span>
        <input type="number" class="sinp sinp-sm" value="${c.seedAmt||''}" placeholder="0"
          onchange="updCatField('${type}',${i},'seedAmt',this.value)">
        <span>ì› Ã—</span>
        <input type="number" class="sinp sinp-sm" value="${c.seedMonths||''}" placeholder="0"
          onchange="updCatField('${type}',${i},'seedMonths',this.value)">
        <span>ê°œì›”</span>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:2px">ì•± ê¸°ë¡ ${appMonths}ê°œì›” ë°˜ì˜ Â· ì´ ${totalM}ê°œì›”${nextBud!==bud?"<b style='color:var(--p)'> â†’ ë‹¤ìŒë‹¬ "+fmt(nextBud)+"</b>":""}</div>`;
    }

    return `<div class="brow">
      <div class="brow-top">
        <span class="brow-name">${c.emoji} ${c.name}</span>
        <button class="brow-typebtn ${isFixed?'fixed':'avg'}"
          onclick="toggleBudgetType('${type}',${i})">${isFixed?'ê³ ì •ê¸ˆì•¡':'ì›”í‰ê· '}</button>
        <span class="brow-result ${col}" title="ë‹¹ì›” í™•ì • ì˜ˆì‚°">${bud>0?fmt(bud):'ë¯¸ì„¤ì •'}</span>
      </div>
      <div class="brow-fields">${fieldsHtml}</div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAssetSettings() {
  const ms = getMs();
  const manualAssets = ms.assets || {};

  const balRows = DEF_ASSETS.map(a => {
    const isManual = manualAssets[a.id] !== undefined;
    const opening = getAssetOpening(a.id, S.month);
    const bal = getAssetBal(a.id);
    return `<div class="sr" style="align-items:flex-start;flex-direction:column;gap:6px;padding:14px 0">
      <div style="display:flex;justify-content:space-between;width:100%;align-items:center">
        <span class="sl2">${a.emoji} ${a.name}</span>
        <div style="text-align:right">
          <div style="font-family:'DM Mono',monospace;font-size:14px;font-weight:600">${fmt(bal.balance)}</div>
          <div style="font-size:10px;color:var(--ok)">+${fmt(bal.deposited)} ì ë¦½</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;width:100%">
        <span style="font-size:11px;color:var(--muted);flex:1">${isManual?'ğŸ“Œ ìˆ˜ë™ì…ë ¥':'ğŸ”„ ì „ì›” ìë™ì´ì›”'} ì›”ì´ˆ ${fmt(opening)}</span>
        <input type="number" class="sinp" style="width:120px" id="set-asset-${a.id}"
          placeholder="ì§ì ‘ì…ë ¥(ì„ íƒ)"
          value="${isManual ? manualAssets[a.id] : ''}"
          oninput="saveAssetBal('${a.id}',this.value)"
          title="ë¹„ì›Œë‘ë©´ ì „ì›” ì”ì•¡ì´ ìë™ ì´ì›”ë©ë‹ˆë‹¤">
      </div>
    </div>`;
  }).join('');
  document.getElementById('set-assets').innerHTML = balRows;
}

function saveAssetBal(assetId, val) {
  if (!S.ms[S.month]) S.ms[S.month] = {};
  if (!S.ms[S.month].assets) S.ms[S.month].assets = {};
  S.ms[S.month].assets[assetId] = parseFloat(val)||0;
  save();
  if (mainTab==='assets') renderAssets();
  if (mainTab==='transactions') renderTxFilter();
}

let _st;
function saveSettingsDebounced() {
  clearTimeout(_st); _st=setTimeout(()=>{
    if(!S.ms[S.month]) S.ms[S.month]={};
    S.ms[S.month].pAccBal   = parseFloat(document.getElementById('set-p-acc').value)||0;
    S.ms[S.month].pCashBal  = parseFloat(document.getElementById('set-p-cash').value)||0;
    S.ms[S.month].pPrevCard = parseFloat(document.getElementById('set-p-prev-card').value)||0;
    S.ms[S.month].jBal      = parseFloat(document.getElementById('set-j-bal').value)||0;
    save(); renderOv('personal'); renderOv('joint');
  },400);
}

function setAssetLink(catName, assetId) {
  if (!S.assetLinks) S.assetLinks = {};
  if (assetId) S.assetLinks[catName] = assetId;
  else delete S.assetLinks[catName];
  save();
  if (mainTab==='assets') renderAssets();
}

function updCatField(type,i,key,val) {
  cats(type)[i][key]=parseFloat(val)||0;
  resetMonthBudgets(S.month);
  save(); renderOv(type); renderSettle(type); renderBudgetSection(type);
}

function toggleBudgetType(type,i) {
  const c=cats(type)[i];
  c.budgetType = c.budgetType==='fixed' ? 'avg' : 'fixed';
  resetMonthBudgets(S.month);
  save(); renderOv(type); renderSettle(type); renderBudgetSection(type);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKUP / RESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportData() {
  const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const dateStr=new Date().toISOString().slice(0,10);
  a.href=url; a.download=`ê°€ê³„ë¶€_ë°±ì—…_${dateStr}.json`;
  a.click(); URL.revokeObjectURL(url);
}

function importData(e) {
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try {
      const data=JSON.parse(ev.target.result);
      if(!data.txs||!data.pCats) { alert('ì˜¬ë°”ë¥¸ ê°€ê³„ë¶€ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.'); return; }
      if(!confirm(`ë°±ì—… íŒŒì¼(${file.name})ì„ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.`)) return;
      S=data;
      save(); render();
      alert('âœ… ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    } catch(err) { alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
  };
  reader.readAsText(file);
  e.target.value='';
}

function resetData() {
  if(!confirm('âš  ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
  if(!confirm('ë§ˆì§€ë§‰ í™•ì¸: ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  S=defaultState(); save(); render();
  alert('ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mPay='account', mType='personal', mCat=null, mDir='expense';

function setDirection(dir) {
  mDir = dir;
  const isInc = dir==='income';
  document.getElementById('dir-exp').classList.toggle('active', !isInc);
  document.getElementById('dir-inc').classList.toggle('active', isInc);
  document.getElementById('modal-title').textContent = isInc ? 'ìˆ˜ì… ì¶”ê°€' : 'ì§€ì¶œ ì¶”ê°€';
  document.getElementById('bsub').textContent = isInc ? 'ìˆ˜ì… ì¶”ê°€' : 'ì§€ì¶œ ì¶”ê°€';
  document.getElementById('bsub').style.background = isInc ? 'var(--ok)' : (mType==='personal'?'var(--p)':'var(--j)');
  // ìˆ˜ì…: ì¹´ë“œ ìˆ¨ê¹€, ê¸°ë³¸ ê³„ì¢Œ
  document.getElementById('pm-card').style.display = isInc ? 'none' : '';
  if (isInc && mPay==='card') setPayment('account');
  document.getElementById('payment-lbl').textContent = isInc ? 'ìˆ˜ì… ê²½ë¡œ' : 'ê²°ì œ ìˆ˜ë‹¨';
  document.getElementById('jnote').style.display = 'none';
  mCat=null;
  // ì¹´í…Œê³ ë¦¬ ì¹© ì¬ë Œë”
  const selCls = mType==='personal'?'sp':'sj';
  const catSrc = cats(mType);
  document.getElementById('chips').innerHTML = catSrc.map(c=>
    `<div class="chip" onclick="selCat('${c.name}',this,'${selCls}')">${c.emoji} ${c.name}</div>`
  ).join('');
  document.getElementById('asset-fg').style.display='none';
}

function openModal() {
  document.getElementById('inp-date').value=todayStr();
  document.getElementById('inp-amt').value='';
  document.getElementById('inp-desc').value='';
  mCat=null; mAssetId=null; mDir='expense';
  document.getElementById('asset-fg').style.display='none';
  document.getElementById('dir-exp').classList.add('active');
  document.getElementById('dir-inc').classList.remove('active');
  document.getElementById('modal-title').textContent='ì§€ì¶œ ì¶”ê°€';
  document.getElementById('bsub').textContent='ì§€ì¶œ ì¶”ê°€';
  document.getElementById('pm-card').style.display='';
  document.getElementById('payment-lbl').textContent='ê²°ì œ ìˆ˜ë‹¨';
  setType(subTab==='personal'?'personal':'joint'); setPayment('account');
  document.getElementById('modal').classList.add('open');
}
function closeOut(e) { if(e.target===document.getElementById('modal')) closeModal(); }
function closeModal() { document.getElementById('modal').classList.remove('open'); }

function setType(t) {
  mType=t;
  document.getElementById('tp-p').classList.toggle('active',t==='personal');
  document.getElementById('tp-j').classList.toggle('active',t==='joint');
  document.getElementById('bsub').style.background=t==='personal'?'var(--p)':'var(--j)';
  document.getElementById('jnote').style.display=t==='joint'?'block':'none';
  mCat=null;
  // ê³µë™: í˜„ê¸ˆ ì—†ìŒ
  const cashBtn=document.getElementById('pm-cash');
  if(t==='joint'){ cashBtn.style.display='none'; if(mPay==='cash') setPayment('account'); }
  else { cashBtn.style.display=''; }
  const selCls=t==='personal'?'sp':'sj';
  const catSrc2 = cats(t);
  document.getElementById('chips').innerHTML=catSrc2.map(c=>
    `<div class="chip" onclick="selCat('${c.name}',this,'${selCls}')">${c.emoji} ${c.name}</div>`
  ).join('');
}

function setPayment(p) {
  mPay=p;
  ['card','account','cash'].forEach(x=>{
    const el=document.getElementById('pm-'+x);
    if(el) el.classList.toggle('active',p===x);
  });
}

let mAssetId = null;

function selCat(name,el,cls) {
  mCat=name;
  mAssetId=null;
  document.querySelectorAll('#chips .chip').forEach(c=>c.className='chip');
  el.classList.add(cls);
  // ì ê¸ˆ ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ìì‚° í•˜ìœ„í•­ëª© í‘œì‹œ (ì§€ì¶œ ëª¨ë“œë§Œ)
  const assetFg = document.getElementById('asset-fg');
  if (name===SAVINGS_CAT && mType==='personal' && mDir==='expense') {
    assetFg.style.display='block';
    document.getElementById('asset-chips').innerHTML = DEF_ASSETS.map(a=>
      `<div class="chip" onclick="selAsset('${a.id}',this)">${a.emoji} ${a.name}</div>`
    ).join('');
  } else {
    assetFg.style.display='none';
  }
}

function selAsset(assetId, el) {
  mAssetId = assetId;
  document.querySelectorAll('#asset-chips .chip').forEach(c=>c.className='chip');
  el.classList.add('sp');
}

function saveTx() {
  const amt=parseFloat(document.getElementById('inp-amt').value);
  const desc=document.getElementById('inp-desc').value.trim();
  const date=document.getElementById('inp-date').value;
  if(!amt||amt<=0) return alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
  if(!desc) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
  if(!mCat) return alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
  if(mDir==='expense' && mCat===SAVINGS_CAT && mType==='personal' && !mAssetId) return alert('ì ê¸ˆ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
  const tx = {id:Date.now().toString(),amount:amt,desc,date,category:mCat,payment:mPay,type:mType,dir:mDir};
  if(mAssetId) tx.assetId = mAssetId;
  S.txs.push(tx);
  save(); closeModal(); render();
}

function deleteTx(id) {
  if(!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
  S.txs=S.txs.filter(x=>x.id!==id);
  save(); render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ensureMonthBudgets(S.month);
switchSub('personal');
render();
</script>
</body>
</html>
