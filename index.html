<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ê°€ê³„ë¶€</title>
<link rel="stylesheet" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#F2F4F6;--surface:#FFFFFF;--s2:#F9FAFB;--border:#E5E8EB;
  --text:#191F28;--muted:#8B95A1;
  --p:#3182F6;--plt:#E8F3FF;
  --j:#5C46E5;--jlt:#F0EDFF;
  --danger:#F04452;--dlt:#FEECEF;
  --warn:#FF9F28;--wlt:#FFF5E5;
  --ok:#00C896;--olt:#E4F9F3;
  --shadow:0 8px 20px rgba(0,0,0,0.04),0 2px 6px rgba(0,0,0,0.02);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased;}
.app{display:flex;flex-direction:column;min-height:100vh;max-width:480px;margin:0 auto;background:var(--bg);}

header{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 20px 0;position:sticky;top:0;z-index:100;}
.htop{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.htitle{font-size:18px;font-weight:700;letter-spacing:-.3px;}
.mnav{display:flex;align-items:center;gap:10px;}
.mnav button{background:none;border:none;cursor:pointer;color:var(--muted);font-size:20px;padding:2px 6px;line-height:1;}
.mlbl{font-family:'DM Mono',monospace;font-size:13px;font-weight:500;min-width:56px;text-align:center;}
.ntabs{display:flex;}
.ntab{flex:1;padding:10px 4px;text-align:center;font-size:12px;font-weight:500;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;}
.ntab.active{color:var(--p);border-bottom-color:var(--p);}

.stabs{display:flex;gap:16px;padding:8px 24px 0;background:var(--surface);border-bottom:1px solid var(--border);}
.stab{flex:none;padding:12px 4px;font-size:15px;font-weight:600;cursor:pointer;background:transparent !important;color:var(--muted);border:none;border-bottom:3px solid transparent;transition:all .15s;}
.stab.active.personal{color:var(--text);border-bottom-color:var(--p);}
.stab.active.joint{color:var(--text);border-bottom-color:var(--j);}

main{flex:1;padding:16px;overflow-y:auto;padding-bottom:90px;}
.card{background:var(--surface);border-radius:20px;padding:24px 20px;box-shadow:var(--shadow);margin-bottom:16px;border:none;overflow:hidden;}
.ctitle{font-size:14px;font-weight:700;color:var(--text);margin-bottom:16px;letter-spacing:-0.3px;}
.strip{display:none;}
.pbar{height:8px;background:var(--s2);border-radius:999px;overflow:hidden;margin:6px 0;}
.pfill{height:100%;border-radius:999px;transition:width 0.5s cubic-bezier(0.4,0,0.2,1);}
/* Balance */
.balmain{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px;}
.balamt{font-family:'DM Mono',monospace;font-size:32px;font-weight:700;letter-spacing:-1px;}
.balamt.danger{color:var(--danger);}
.balsub{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:8px;}
.balsub b{color:var(--text);font-family:'DM Mono',monospace;font-weight:500;}
.pbar{height:4px;background:var(--border);border-radius:2px;overflow:hidden;}
.pfill{height:100%;border-radius:2px;transition:width .4s;}
.pfill.p-ok{background:var(--p);}.pfill.j-ok{background:var(--j);}
.pfill.warn{background:var(--warn);}.pfill.over{background:var(--danger);}

/* Grids */
.sg{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.si2{background:var(--s2);border-radius:8px;padding:10px 12px;}
.si2 .sl{font-size:11px;color:var(--muted);margin-bottom:2px;}
.si2 .sv{font-family:'DM Mono',monospace;font-size:15px;font-weight:500;}

/* Category rows */
.crow{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);}
.crow:last-child{border-bottom:none;}
.cdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.cinfo{flex:1;min-width:0;}
.cname{font-size:13px;font-weight:500;}
.cbw{height:3px;background:var(--border);border-radius:2px;margin-top:4px;}
.cbf{height:100%;border-radius:2px;}
.cright{text-align:right;flex-shrink:0;}
.cspent{font-family:'DM Mono',monospace;font-size:13px;font-weight:500;}
.cbudget{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}

/* Tx */
.badge{display:inline-flex;align-items:center;font-size:10px;font-weight:500;padding:2px 7px;border-radius:20px;}
.b-card{background:var(--s2);color:var(--muted);}.b-cash{background:#FEF9E7;color:#876500;}.b-acc{background:#EEF2FF;color:#3730A3;}
.txdh{font-size:11px;color:var(--muted);font-weight:500;padding:12px 0 6px;display:flex;justify-content:space-between;}
.txitem{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);cursor:pointer;}
.txitem:last-child{border-bottom:none;}
.txicon{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.txbody{flex:1;min-width:0;}
.txname{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.txmeta{display:flex;gap:4px;margin-top:2px;flex-wrap:wrap;}
.txamt{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--danger);white-space:nowrap;}

/* Alert */
.alert{border-radius:10px;padding:10px 14px;font-size:12px;margin-bottom:10px;}
.alert.warn{background:var(--wlt);color:var(--warn);}
.alert.over{background:var(--dlt);color:var(--danger);}
.alert strong{display:block;font-weight:700;margin-bottom:1px;}

/* Summary settle rows */
.srow{display:grid;grid-template-columns:16px 1fr 72px 72px 64px;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);gap:6px;}
.srow:last-child{border-bottom:none;}
.srow-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.srow-name{font-size:13px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.srow-type{font-size:10px;padding:2px 6px;border-radius:10px;font-weight:600;}
.srow-type.avg{background:var(--plt);color:var(--p);}
.srow-type.fixed{background:#F0F0FF;color:#5555AA;}
.srow-budget{font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);text-align:right;}
.srow-net{font-family:'DM Mono',monospace;font-size:13px;font-weight:600;text-align:right;}
.srow-diff{font-family:'DM Mono',monospace;font-size:12px;font-weight:600;text-align:right;}
.srow-diff.plus{color:var(--ok);}
.srow-diff.minus{color:var(--danger);}
.settle-header{display:grid;grid-template-columns:16px 1fr 72px 72px 64px;gap:6px;padding:8px 0 6px;font-size:10px;font-weight:600;color:var(--muted);border-bottom:2px solid var(--border);margin-bottom:4px;}
/* FAB */
.fab{position:fixed;bottom:24px;right:calc(50% - 240px + 20px);width:56px;height:56px;border-radius:999px;color:white;border:none;cursor:pointer;font-size:26px;box-shadow:0 8px 24px rgba(0,0,0,0.15);display:flex;align-items:center;justify-content:center;z-index:200;transition:background .2s,transform .15s;background:var(--p);}
.fab:hover{transform:scale(1.05);}
@media(max-width:480px){.fab{right:20px;}}

/* Modal */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:300;align-items:flex-end;justify-content:center;}
.mo.open{display:flex;}
.mb{background:var(--surface);border-radius:20px 20px 0 0;width:100%;max-width:480px;padding:20px;max-height:92vh;overflow-y:auto;}
.mh{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.mtitle{font-size:16px;font-weight:700;margin-bottom:18px;}
.fg{margin-bottom:14px;}
.fl{font-size:11px;font-weight:500;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px;display:block;}
.fi{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-family:inherit;font-size:14px;color:var(--text);outline:none;transition:border-color .15s;}
.fi:focus{border-color:var(--p);}
.fi.big{font-family:'DM Mono',monospace!important;font-size:22px!important;}
.tg{display:flex;background:var(--s2);border-radius:10px;padding:3px;gap:3px;}
.tb{flex:1;padding:8px 4px;text-align:center;font-size:12px;font-weight:500;cursor:pointer;border-radius:8px;color:var(--muted);transition:all .15s;border:none;background:none;font-family:inherit;}
.tb.active{background:var(--surface);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.1);}
.chips{display:flex;flex-wrap:wrap;gap:7px;}
.chip{padding:6px 13px;border-radius:20px;font-size:12px;font-weight:500;cursor:pointer;border:1.5px solid var(--border);color:var(--muted);background:var(--surface);transition:all .15s;}
.chip.sp{border-color:var(--p);color:var(--p);background:var(--plt);}
.chip.sj{border-color:var(--j);color:var(--j);background:var(--jlt);}
.bsub{width:100%;color:white;border:none;border-radius:12px;padding:14px;font-size:15px;font-weight:600;font-family:inherit;cursor:pointer;margin-top:6px;transition:background .2s;background:var(--p);}
.jnote{font-size:11px;color:var(--j);background:var(--jlt);border-radius:8px;padding:8px 12px;margin-bottom:14px;line-height:1.7;}

/* Settings */
.sr{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);}
.sr:last-child{border-bottom:none;}
.sl2{font-size:13px;font-weight:500;}
.sinp{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-family:'DM Mono',monospace;font-size:13px;width:130px;text-align:right;outline:none;}
.sinp:focus{border-color:var(--p);}
.sinp-sm{width:90px;}

/* Budget settings rows */
.brow{padding:12px 0;border-bottom:1px solid var(--border);}
.brow:last-child{border-bottom:none;}
.brow-top{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.brow-name{font-size:13px;font-weight:600;flex:1;}
.brow-typebtn{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;cursor:pointer;border:1.5px solid;transition:all .15s;}
.brow-typebtn.avg{border-color:var(--p);color:var(--p);background:var(--plt);}
.brow-typebtn.fixed{border-color:#5555AA;color:#5555AA;background:#F0F0FF;}
.brow-fields{display:flex;flex-direction:column;gap:6px;}
.brow-line{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--muted);}
.brow-result{font-family:'DM Mono',monospace;font-size:12px;font-weight:600;padding:4px 10px;border-radius:6px;display:inline-block;margin-top:4px;}
.brow-result.p-col{color:var(--p);background:var(--plt);}
.brow-result.j-col{color:var(--j);background:var(--jlt);}


/* Backup */
.btn-outline{background:none;border:1.5px solid var(--border);border-radius:10px;padding:10px 16px;font-family:inherit;font-size:13px;font-weight:500;cursor:pointer;color:var(--text);width:100%;margin-bottom:8px;transition:all .15s;}
.btn-outline:hover{border-color:var(--p);color:var(--p);}
.btn-outline.danger:hover{border-color:var(--danger);color:var(--danger);}

/* â”€â”€ Cat manage â”€â”€ */
.cat-add-row{display:flex;flex-wrap:wrap;gap:6px;padding:10px 0 4px;border-top:1px dashed var(--border);margin-top:8px;min-width:0;}
.cat-add-inp{flex:1;border:1.5px solid var(--border);border-radius:8px;padding:7px 10px;font-family:inherit;font-size:13px;background:var(--bg);color:var(--text);}
.cat-add-inp:focus{outline:none;border-color:var(--p);}
.cat-del-btn{background:none;border:none;font-size:16px;cursor:pointer;padding:4px 6px;color:var(--muted);line-height:1;}
.cat-del-btn:hover{color:var(--danger);}
.emoji-inp{width:46px;text-align:center;border:1.5px solid var(--border);border-radius:8px;padding:7px 4px;font-size:16px;font-family:inherit;background:var(--bg);color:var(--text);}
.emoji-inp:focus{outline:none;border-color:var(--p);}

/* â”€â”€ Tx Filter â”€â”€ */
.txfilter{display:flex;gap:6px;padding:12px 0 8px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;}
.txfilter::-webkit-scrollbar{display:none;}
.txftab{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:500;background:var(--s2);color:var(--muted);cursor:pointer;white-space:nowrap;border:none;font-family:inherit;transition:all .15s;}
.txftab.active{background:var(--text);color:var(--bg);}
.txftab.p-act{background:var(--p);color:#fff;}
.txftab.j-act{background:var(--j);color:#fff;}
.txdate-header{display:flex;justify-content:space-between;align-items:baseline;padding:8px 0 4px;border-bottom:1px solid var(--border);margin-bottom:2px;}
.txdate-label{font-size:12px;font-weight:600;color:var(--muted);}
.txdate-sum{font-size:11px;font-family:'DM Mono',monospace;color:var(--muted);}

/* â”€â”€ Income â”€â”€ */
.b-income{background:#E8F8EF;color:#1A7A45;}
.income-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);}
.income-row:last-child{border-bottom:none;}
.income-amt{font-family:'DM Mono',monospace;font-size:14px;font-weight:500;color:var(--ok);white-space:nowrap;}

.page{display:none;}.page.active{display:block;}
.empty{text-align:center;padding:48px 24px;color:var(--muted);}
.empty .icon{font-size:36px;margin-bottom:10px;}
.empty p{font-size:13px;}
.note{font-size:11px;color:var(--muted);line-height:1.6;margin-bottom:12px;}

/* â”€â”€ Assets â”€â”€ */
.asset-card{background:var(--surface);border-radius:14px;padding:16px;box-shadow:var(--shadow);margin-bottom:10px;display:flex;align-items:center;gap:14px;}
.asset-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.asset-body{flex:1;min-width:0;}
.asset-name{font-size:13px;font-weight:600;margin-bottom:1px;}
.asset-sub{font-size:11px;color:var(--muted);}
.asset-right{text-align:right;flex-shrink:0;}
.asset-bal{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;}
.asset-change{font-size:11px;font-weight:600;margin-top:1px;}
.asset-change.plus{color:var(--ok);}
.asset-change.zero{color:var(--muted);}
.asset-total{background:linear-gradient(135deg,#1A3A5C,#2D5016);border-radius:14px;padding:18px;color:white;margin-bottom:14px;box-shadow:var(--shadow);}
.asset-total .label{font-size:11px;opacity:.7;margin-bottom:4px;}
.asset-total .amount{font-family:'DM Mono',monospace;font-size:28px;font-weight:400;}
.asset-total .sub{font-size:11px;opacity:.7;margin-top:6px;display:flex;gap:16px;}
/* í† ê¸€(ìì„¸íˆ ë³´ê¸°) UI ìŠ¤íƒ€ì¼ */
details.detail-box summary::-webkit-details-marker { display:none; }
details.detail-box summary { list-style: none; text-align: center; display: inline-block; padding: 6px 12px; background: var(--s2); border-radius: 12px; transition: background 0.2s; }
details.detail-box summary:hover { background: var(--border); }
details.detail-box summary::after { content: " â–¼"; font-size: 10px; margin-left: 4px; color: var(--muted); }
details[open].detail-box summary::after { content: " â–²"; }
</style>
</head>
<body>
<div class="app">
<header>
  <div class="htop">
    <span class="htitle">ê°€ê³„ë¶€</span>
    <div class="mnav">
      <button onclick="changeMonth(-1)">â€¹</button>
      <span class="mlbl" id="monthLabel"></span>
      <button onclick="changeMonth(1)">â€º</button>
    </div>
  </div>
  <div class="ntabs">
    <div class="ntab active" onclick="switchMain('overview')">ìš”ì•½</div>
    <div class="ntab" onclick="switchMain('transactions')">ë‚´ì—­</div>
    <div class="ntab" onclick="switchMain('assets')">ìì‚°</div>
    <div class="ntab" onclick="switchMain('settle')">ê²°ì‚°</div>
    <div class="ntab" onclick="switchMain('settings')">ì„¤ì •</div>
  </div>
</header>

<div class="stabs" id="subTabRow">
  <div class="stab active personal" id="st-personal" onclick="switchSub('personal')">ğŸ‘¤ ê°œì¸</div>
  <div class="stab joint" id="st-joint" onclick="switchSub('joint')">ğŸ‘¥ ê³µë™</div>
</div>

<main>
<!-- â•â• OVERVIEW â•â• -->
<div class="page active" id="page-overview">
  <div id="ov-p">
    <div id="ov-p-empty" style="display:none; text-align:center; padding: 64px 20px;">
      <div style="font-size:52px; margin-bottom:16px;">ğŸ‘‹</div>
      <h3 style="font-size:18px; font-weight:700; color:var(--text); margin-bottom:8px;">ê°€ê³„ë¶€ ì‘ì„±ì„ ì‹œì‘í•´ë³¼ê¹Œìš”?</h3>
      <p style="font-size:13px; color:var(--muted); margin-bottom:24px; line-height:1.5;">í˜„ì¬ í†µì¥ ì”ê³ ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì‹œë©´<br>ì´ë²ˆ ë‹¬ ì“¸ ìˆ˜ ìˆëŠ” ëˆì„ ê³„ì‚°í•´ ë“œë ¤ìš”.</p>
      <button class="bsub" onclick="openWizard()" style="width:auto; padding:12px 24px; border-radius:24px; display:inline-block; font-size:14px;">ì´ˆê¸° ì”ê³  ì„¤ì •í•˜ëŸ¬ ê°€ê¸°</button>
    </div>

    <div id="ov-p-main">
      <div class="card">
        <div class="strip" style="background:var(--p)"></div>
        <div class="ctitle">ì—¬ìœ ìê¸ˆ</div>
        <div class="balmain"><span class="balamt" id="p-amt">â‚©0</span><span style="font-size:11px;color:var(--muted)" id="p-lbl">ì”ì•¡</span></div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
          <div style="font-size:11px;color:var(--muted);white-space:nowrap;text-align:left">
            <div>ì›”ì´ˆ ì—¬ìœ ìê¸ˆ</div>
            <div id="p-flex-open" style="font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:var(--text)">â‚©0</div>
          </div>
          <div class="pbar" style="flex:1;margin:0"><div class="pfill p-ok" id="p-bar" style="width:0%"></div></div>
          <div style="font-size:11px;color:var(--muted);white-space:nowrap;text-align:right">
            <div>í˜„ì¬ ì—¬ìœ ìê¸ˆ</div>
            <div id="p-flex-now" style="font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:var(--text)">â‚©0</div>
          </div>
        </div>
        <div style="border-top:1px solid var(--border);margin:10px 0"></div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px">ê³„ì¢Œ + í˜„ê¸ˆ ì”ì•¡</div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
          <div style="font-size:11px;color:var(--muted);white-space:nowrap;text-align:left">
            <div>ì›”ì´ˆ</div>
            <div id="p-open-bal" style="font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:var(--text)">â‚©0</div>
          </div>
          <div class="pbar" style="flex:1;margin:0"><div class="pfill p-ok" id="p-bal-bar" style="width:0%"></div></div>
          <div style="font-size:11px;color:var(--muted);white-space:nowrap;text-align:right">
            <div>í˜„ì¬</div>
            <div id="p-total-bal" style="font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:var(--text)">â‚©0</div>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:2px">
          <div>
            <span>ê³„ì¢Œ </span><span id="p-open-acc" style="font-family:'DM Mono',monospace;color:var(--text)">â‚©0</span>
            <span style="margin-left:6px">í˜„ê¸ˆ </span><span id="p-open-cash" style="font-family:'DM Mono',monospace;color:var(--text)">â‚©0</span>
          </div>
          <div style="text-align:right">
            <span>ê³„ì¢Œ </span><span id="p-acc-bal" style="font-family:'DM Mono',monospace;color:var(--text)">â‚©0</span>
            <span style="margin-left:6px">í˜„ê¸ˆ </span><span id="p-cash-bal" style="font-family:'DM Mono',monospace;color:var(--text)">â‚©0</span>
          </div>
        </div>
        <div style="border-top:1px solid var(--border);margin:10px 0"></div>
        <div class="sg">
          <div class="si2">
            <div class="sl">ğŸ“‰ ì´ë²ˆë‹¬ ì§€ì¶œ</div>
            <div class="sv" id="p-total-spent">â‚©0</div>
          </div>
          <div class="si2">
            <div class="sl" style="color:var(--ok)">ğŸ“ˆ ì´ë²ˆë‹¬ ìˆ˜ì…</div>
            <div class="sv" style="color:var(--ok)" id="p-total-income">â‚©0</div>
          </div>
        </div>
      </div>
      <div id="p-alert" style="display:none"></div>
      <span style="display:none" id="p-acc-income"></span>
      <span style="display:none" id="p-cash-income"></span>
      <div style="display:none" id="p-income-cats"></div>
      <span style="display:none" id="p-acc-spent"></span>
      <span style="display:none" id="p-cash-spent"></span>
      <span style="display:none" id="p-card-spent"></span>
      <span style="display:none" id="p-jcard-rebate"></span>
      <div style="display:none" id="p-rebate"></div>
      <div class="card">
        <div class="ctitle">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</div>
        <div id="p-cats"></div>
      </div>
    </div>
  </div>

  <div id="ov-j" style="display:none">
    <div id="ov-j-empty" style="display:none; text-align:center; padding: 64px 20px;">
      <div style="font-size:52px; margin-bottom:16px;">ğŸ‘¥</div>
      <h3 style="font-size:18px; font-weight:700; color:var(--text); margin-bottom:8px;">ê³µë™ ìƒí™œë¹„ ê´€ë¦¬ë¥¼ ì‹œì‘í•´ìš”</h3>
      <p style="font-size:13px; color:var(--muted); margin-bottom:24px; line-height:1.5;">ê³µë™ í†µì¥ì˜ ì”ê³ ë¥¼ ì…ë ¥í•˜ë©´<br>ì´ë²ˆ ë‹¬ ìƒí™œë¹„ ì§„í–‰ë¥ ì„ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>
      <button class="bsub" style="background:var(--j); width:auto; padding:12px 24px; border-radius:24px; display:inline-block; font-size:14px;" onclick="openWizard()">ê³µë™ ì”ê³  ì„¤ì •í•˜ëŸ¬ ê°€ê¸°</button>
    </div>

    <div id="ov-j-main">
      <div class="card">
        <div class="strip" style="background:var(--j)"></div>
        <div class="ctitle">ê³µë™ ì”ì•¡</div>
        <div class="balmain"><span class="balamt" id="j-amt">â‚©0</span><span style="font-size:11px;color:var(--muted)" id="j-lbl">ì”ì•¡</span></div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
          <div style="font-size:11px;color:var(--muted);white-space:nowrap;text-align:left">
            <div>ì›”ì´ˆ</div>
            <div id="j-open-bal" style="font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:var(--text)">â‚©0</div>
          </div>
          <div class="pbar" style="flex:1;margin:0"><div class="pfill j-ok" id="j-bar" style="width:0%"></div></div>
          <div style="font-size:11px;color:var(--muted);white-space:nowrap;text-align:right">
            <div>í˜„ì¬</div>
            <div id="j-acc-bal" style="font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:var(--text)">â‚©0</div>
          </div>
        </div>
        <div class="sg" style="margin-bottom:8px">
          <div class="si2">
            <div class="sl">ğŸ“‰ ì´ë²ˆë‹¬ ì§€ì¶œ</div>
            <div class="sv" id="j-total">â‚©0</div>
          </div>
          <div class="si2">
            <div class="sl" style="color:var(--ok)">ğŸ“ˆ ì´ë²ˆë‹¬ ìˆ˜ì…</div>
            <div class="sv" style="color:var(--ok)" id="j-total-income">â‚©0</div>
          </div>
        </div>
      </div>
      <div id="j-alert" style="display:none"></div>
      <span style="display:none" id="j-acc-income"></span>
      <span style="display:none" id="j-cash-income"></span>
      <div style="display:none" id="j-income-cats"></div>
      <div style="display:none" id="j-breakdown"></div>
      <div class="card">
        <div class="ctitle">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ</div>
        <div id="j-cats"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• TRANSACTIONS â•â• -->
<div class="page" id="page-transactions">
  <!-- ìˆ˜ì…/ì§€ì¶œ ìš”ì•½ -->
  <div id="tx-summary-p">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px 0 4px">
      <div class="si2">
        <div class="sl">ì´ë²ˆë‹¬ ìˆ˜ì…</div>
        <div class="sv" style="color:var(--ok)" id="txs-p-income">â‚©0</div>
      </div>
      <div class="si2">
        <div class="sl">ì´ë²ˆë‹¬ ì§€ì¶œ</div>
        <div class="sv" id="txs-p-spent">â‚©0</div>
      </div>
    </div>
  </div>
  <div id="tx-summary-j" style="display:none">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px 0 4px">
      <div class="si2">
        <div class="sl">ì´ë²ˆë‹¬ ìˆ˜ì…</div>
        <div class="sv" style="color:var(--ok)" id="txs-j-income">â‚©0</div>
      </div>
      <div class="si2">
        <div class="sl">ì´ë²ˆë‹¬ ì§€ì¶œ</div>
        <div class="sv" id="txs-j-spent">â‚©0</div>
      </div>
    </div>
  </div>
  <div class="txfilter" id="txfilter"></div>
  <div id="tx-p"></div>
  <div id="tx-j" style="display:none"></div>
</div>

<!-- â•â• ASSETS â•â• -->
<div class="page" id="page-assets">
  <!-- ì´ ìì‚° ìš”ì•½ ì¹´ë“œ -->
  <div class="asset-total">
    <div class="label">ì´ ìì‚°</div>
    <div class="amount" id="asset-total">â‚©0</div>
    <div class="sub">
      <span>ì›”ì´ˆ ëŒ€ë¹„ <b id="asset-delta" style="font-family:'DM Mono',monospace">-</b></span>
      <span>ì´ë²ˆë‹¬ ì ë¦½ <b id="asset-deposit" style="font-family:'DM Mono',monospace">-</b></span>
    </div>
  </div>
  <!-- ìì‚°ë³„ ì¹´ë“œ -->
  <div id="asset-list"></div>
</div>

<!-- â•â• LIQUIDATE MODAL â•â• -->
<div class="mo" id="mo-liquidate">
  <div class="mb">
    <div class="mh"></div>
    <div class="mtitle" id="liq-title">ğŸ’° í˜„ê¸ˆí™”</div>
    <div class="fg">
      <label class="fl">ë§¤ë„ ê¸ˆì•¡</label>
      <input type="number" class="fi" id="liq-amount" placeholder="0" inputmode="numeric">
    </div>
    <div class="fg">
      <label class="fl">ë©”ëª¨</label>
      <input type="text" class="fi" id="liq-desc" placeholder="ì˜ˆ: ì£¼ì‹ ì¼ë¶€ ë§¤ë„">
    </div>
    <div class="fg">
      <label class="fl">ë‚ ì§œ</label>
      <input type="date" class="fi" id="liq-date">
    </div>
    <div class="fg">
      <label class="fl">ê³„ì¢Œ ì…ê¸ˆ</label>
      <div class="tg">
        <button class="tb active" id="pm-liq-account" onclick="setLiqPayment('account')">ğŸ¦ ê³„ì¢Œ</button>
        <button class="tb" id="pm-liq-cash" onclick="setLiqPayment('cash')">ğŸ’µ í˜„ê¸ˆ</button>
      </div>
    </div>
    <div id="liq-balance-info" style="font-size:12px;color:var(--muted);margin-bottom:14px;padding:10px 12px;background:var(--s2);border-radius:10px;"></div>
    <button class="bsub" onclick="saveLiquidate()">í˜„ê¸ˆí™” ì‹¤í–‰</button>
  </div>
</div>


<div class="page" id="page-settle">
  <div id="settle-p">
    <div class="card">
      <div class="strip" style="background:var(--p)"></div>
      <div class="ctitle">ê°œì¸ ì›”ë³„ ê²°ì‚°</div>
      <div class="sg" style="margin-bottom:12px">
        <div class="si2"><div class="sl">ì›”ì´ˆ ì”ì•¡</div><div class="sv" id="sp-budget">â‚©0</div></div>
        <div class="si2"><div class="sl">ì‹¤ì œ ìˆ˜ì§€ í•©ê³„</div><div class="sv" id="sp-spent">â‚©0</div></div>
        <div class="si2"><div class="sl">ì ˆì•½ / ì´ˆê³¼</div><div class="sv" id="sp-diff">-</div></div>
        <div class="si2"><div class="sl">ì ˆì•½ë¥ </div><div class="sv" id="sp-rate">-</div></div>
      </div>
      <div class="settle-header">
        <span></span><span>ì¹´í…Œê³ ë¦¬</span><span style="text-align:right">ì˜ˆì‚°</span><span style="text-align:right">ìˆ˜ì§€</span><span style="text-align:right">ì°¨ì´</span>
      </div>
      <div id="sp-rows"></div>
    </div>
  </div>
  <div id="settle-j" style="display:none">
    <div class="card">
      <div class="strip" style="background:var(--j)"></div>
      <div class="ctitle">ê³µë™ ì›”ë³„ ê²°ì‚°</div>
      <div class="sg" style="margin-bottom:12px">
        <div class="si2"><div class="sl">ê³ ì •ë¹„ ì˜ˆì‚° í•©ê³„</div><div class="sv" id="sj-budget">â‚©0</div></div>
        <div class="si2"><div class="sl">ì‹¤ì œ ìˆ˜ì§€ í•©ê³„</div><div class="sv" id="sj-spent">â‚©0</div></div>
        <div class="si2"><div class="sl">ì ˆì•½ / ì´ˆê³¼</div><div class="sv" id="sj-diff">-</div></div>
        <div class="si2"><div class="sl">ì ˆì•½ë¥ </div><div class="sv" id="sj-rate">-</div></div>
      </div>
      <div class="settle-header">
        <span></span><span>ì¹´í…Œê³ ë¦¬</span><span style="text-align:right">ì˜ˆì‚°</span><span style="text-align:right">ìˆ˜ì§€</span><span style="text-align:right">ì°¨ì´</span>
      </div>
      <div id="sj-rows"></div>
    </div>
  </div>
</div>

<!-- â•â• SETTINGS â•â• -->
<div class="page" id="page-settings">
  <!-- ê°œì¸ ì”ê³  -->
  <div class="card">
    <div class="strip" style="background:var(--p)"></div>
    <div class="ctitle">ê°œì¸ ì›”ì´ˆ ì”ê³ </div>
    <div class="sr">
      <span class="sl2">ğŸ¦ ê³„ì¢Œ ì”ê³ </span>
      <input type="number" class="sinp" id="set-p-acc" placeholder="0" oninput="saveSettingsDebounced()">
    </div>
    <div class="sr">
      <span class="sl2">ğŸ’µ í˜„ê¸ˆ ì”ê³ </span>
      <input type="number" class="sinp" id="set-p-cash" placeholder="0" oninput="saveSettingsDebounced()">
    </div>
    <div class="sr">
      <span class="sl2">ğŸ’³ ì „ì›” ì¹´ë“œëŒ€ê¸ˆ</span>
      <input type="number" class="sinp" id="set-p-prev-card" placeholder="0" oninput="saveSettingsDebounced()">
    </div>
  </div>
  <!-- ê°œì¸ ê³ ì •ë¹„ ì˜ˆì‚° -->
  <div class="card">
    <div class="strip" style="background:var(--p)"></div>
    <div class="ctitle">ê°œì¸ ê³ ì •ë¹„ ì˜ˆì‚°</div>
    <div class="note">ê° í•­ëª©ì´ <strong>ì›”í‰ê· </strong>(ì§€ì¶œì— ë”°ë¼ ìë™ ê°±ì‹ )ì¸ì§€ <strong>ê³ ì •ê¸ˆì•¡</strong>(ë§¤ë‹¬ ë™ì¼)ì¸ì§€ ì„ íƒí•˜ì„¸ìš”.</div>
    <div id="set-p-budgets"></div>
  </div>
  <!-- ê³µë™ ì”ê³  -->
  <div class="card" style="margin-top:8px">
    <div class="strip" style="background:var(--j)"></div>
    <div class="ctitle">ê³µë™ ì›”ì´ˆ ì”ê³ </div>
    <div class="sr">
      <span class="sl2">ğŸ¦ ê³µë™ ê³„ì¢Œ ì”ê³ </span>
      <input type="number" class="sinp" id="set-j-bal" placeholder="0" oninput="saveSettingsDebounced()">
    </div>
  </div>
  <!-- ê³µë™ ê³ ì •ë¹„ ì˜ˆì‚° -->
  <div class="card">
    <div class="strip" style="background:var(--j)"></div>
    <div class="ctitle">ê³µë™ ê³ ì •ë¹„ ì˜ˆì‚°</div>
    <div class="note">ê° í•­ëª©ì´ <strong>ì›”í‰ê· </strong>ì¸ì§€ <strong>ê³ ì •ê¸ˆì•¡</strong>ì¸ì§€ ì„ íƒí•˜ì„¸ìš”.</div>
    <div id="set-j-budgets"></div>
  </div>
  <!-- ìì‚° ì„¤ì • -->
  <div class="card">
    <div class="strip" style="background:linear-gradient(90deg,#1A3A5C,#2D5016)"></div>
    <div class="ctitle">ìì‚° ì›”ì´ˆ ì”ì•¡</div>
    <div class="note">ì›”ì´ˆ ì”ì•¡ì„ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, ë¹„ì›Œë‘ë©´ ì „ì›” ë§ ì”ì•¡ì´ ìë™ ì´ì›”ë©ë‹ˆë‹¤. ì´ë²ˆ ë‹¬ ì§€ì¶œ ë‚´ì—­ì˜ ì ê¸ˆ í•­ëª©ì´ ìë™ í•©ì‚°ë©ë‹ˆë‹¤.</div>
    <div id="set-assets"></div>
  </div>

  <!-- ë°±ì—…/ë³µì› -->
  <div class="card" style="margin-bottom:80px">
    <div class="ctitle">ë°ì´í„° ë°±ì—… / ë³µì›</div>
    <div class="note">JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê±°ë‚˜ ë¶ˆëŸ¬ì™€ì„œ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ ë³´ê´€í•˜ì„¸ìš”. ì•±ì„ ìƒˆë¡œ ë°›ì•„ë„ ë³µì› í›„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    <button class="btn-outline" onclick="exportData()">ğŸ“¤ JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°</button>
    <button class="btn-outline" onclick="document.getElementById('import-file').click()">ğŸ“¥ JSONì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
    <button class="btn-outline danger" onclick="resetData()">ğŸ—‘ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
  </div>
</div>
</main>
</div>

<button class="fab" id="fab" onclick="openModal()">+</button>

<!-- Modal -->
<div class="mo" id="modal" onclick="closeOut(event)">
  <div class="mb" style="padding: 24px 20px;">
    <div class="mh"></div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <div class="mtitle" id="modal-title" style="margin-bottom:0; font-size:18px;">ì§€ì¶œ ì¶”ê°€</div>
    </div>

    <div style="display:flex; gap:12px; margin-bottom:24px;">
      <div class="tg" style="flex:1; background:var(--s2); border-radius:12px; padding:4px;">
        <button class="tb active" id="dir-exp" onclick="setDirection('expense')" style="padding:10px 0; font-size:13px; font-weight:600;">ğŸ“‰ ì§€ì¶œ</button>
        <button class="tb" id="dir-inc" onclick="setDirection('income')" style="padding:10px 0; font-size:13px; font-weight:600;">ğŸ“ˆ ìˆ˜ì…</button>
      </div>
      <div class="tg" style="flex:1; background:var(--bg); border:1px solid var(--border); border-radius:12px; padding:4px;">
        <button class="tb active" id="tp-p" onclick="setType('personal')" style="padding:10px 0; font-size:13px; font-weight:600;">ğŸ‘¤ ê°œì¸</button>
        <button class="tb" id="tp-j" onclick="setType('joint')" style="padding:10px 0; font-size:13px; font-weight:600;">ğŸ‘¥ ê³µë™</button>
      </div>
    </div>

    <div class="jnote" id="jnote" style="display:none; margin-top:-12px; margin-bottom:20px; text-align:center;">
      ğŸ¦ ê³„ì¢Œ: ê³µë™ ì”ì•¡ ì°¨ê° &nbsp;|&nbsp; ğŸ’³ ì¹´ë“œ: ê³µë™ ì°¨ê° + ê°œì¸ ë³´ì „
    </div>

    <div class="fg" style="margin-bottom:28px;">
      <input type="number" class="fi big" id="inp-amt" placeholder="ì–¼ë§ˆë¥¼ ì“°ì…¨ë‚˜ìš”?" inputmode="numeric" style="text-align:center; font-size:32px!important; font-weight:700; padding:16px 0; border:none; border-bottom:2px solid var(--p); border-radius:0; background:transparent; color:var(--text);">
    </div>

    <div style="display:grid; grid-template-columns:1fr auto; gap:12px; margin-bottom:20px;">
      <div class="fg" style="margin-bottom:0;">
        <label class="fl">ë‚´ìš©</label>
        <input type="text" class="fi" id="inp-desc" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤, ì£¼ë§ë†ì¥ ìš©í’ˆ ë“±" style="padding:12px 14px;">
      </div>
      <div class="fg" style="margin-bottom:0;">
        <label class="fl">ë‚ ì§œ</label>
        <input type="date" class="fi" id="inp-date" style="padding:12px 10px; font-size:13px; min-width:0; width:100%;">
      </div>
    </div>

    <div class="fg" style="margin-bottom:20px;">
      <label class="fl">ì¹´í…Œê³ ë¦¬</label>
      <div class="chips" id="chips"></div>
    </div>
    
    <div class="fg" id="asset-fg" style="display:none; margin-bottom:20px;">
      <label class="fl">ì ê¸ˆ í•­ëª©</label>
      <div class="chips" id="asset-chips"></div>
    </div>

    <div class="fg" id="payment-fg" style="margin-bottom:28px;">
      <label class="fl" id="payment-lbl">ê²°ì œ ìˆ˜ë‹¨</label>
      <div class="tg" style="background:var(--bg); border:1px solid var(--border); padding:4px; border-radius:12px;">
        <button class="tb active" id="pm-card" onclick="setPayment('card')" style="padding:10px 0; font-size:13px;">ğŸ’³ ì¹´ë“œ</button>
        <button class="tb" id="pm-account" onclick="setPayment('account')" style="padding:10px 0; font-size:13px;">ğŸ¦ ê³„ì¢Œ</button>
        <button class="tb" id="pm-cash" onclick="setPayment('cash')" style="padding:10px 0; font-size:13px;">ğŸ’µ í˜„ê¸ˆ</button>
      </div>
    </div>

    <button class="bsub" id="bsub" onclick="saveTx()" style="padding:16px; font-size:16px; border-radius:14px;">ì§€ì¶œ ì¶”ê°€</button>
    <button id="bsub-del" onclick="deleteTxFromModal()" style="display:none;width:100%;padding:14px;border:none;background:var(--dlt);color:var(--danger);border-radius:14px;font-size:15px;font-weight:700;cursor:pointer;margin-top:10px;">ğŸ—‘ ë‚´ì—­ ì‚­ì œ</button>
  </div>
</div>

<!-- â•â• ONBOARDING WIZARD â•â• -->
<div class="mo" id="mo-wizard">
  <div class="mb" style="padding: 32px 24px;">

    <div id="wiz-step-1">
      <div style="font-size:32px; margin-bottom:12px;">ğŸ‘¤</div>
      <h3 style="margin-bottom:8px; font-size:18px;">1ë‹¨ê³„: ë‚˜ì˜ í˜„ì¬ ì”ê³ </h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:24px;line-height:1.5;">ì—¬ìœ ìê¸ˆì„ ê³„ì‚°í•˜ê¸° ìœ„í•´<br>í˜„ì¬ ë³´ìœ í•˜ì‹  ê¸ˆì•¡ê³¼ ê²°ì œ ì˜ˆì • ì¹´ë“œê°’ì„ ì ì–´ì£¼ì„¸ìš”.</p>
      <div class="fg">
        <label class="fl">ğŸ¦ ê°œì¸ í†µì¥ ì”ì•¡ (ê¸‰ì—¬í†µì¥ ë“±)</label>
        <input type="number" class="fi" id="wiz-p-acc" placeholder="ì˜ˆ: 3000000" inputmode="numeric">
      </div>
      <div class="fg">
        <label class="fl">ğŸ’µ ê°œì¸ í˜„ê¸ˆ ì”ì•¡</label>
        <input type="number" class="fi" id="wiz-p-cash" placeholder="0" inputmode="numeric">
      </div>
      <div class="fg" style="margin-bottom:32px;">
        <label class="fl">ğŸ’³ ì „ì›” ì¹´ë“œëŒ€ê¸ˆ (ì´ë²ˆ ë‹¬ ê²°ì œë  ê¸ˆì•¡)</label>
        <input type="number" class="fi" id="wiz-p-card" placeholder="0" inputmode="numeric">
      </div>
      <button class="bsub" onclick="nextWizard(2)">ë‹¤ìŒ ë‹¨ê³„ë¡œ (1/3)</button>
    </div>

    <div id="wiz-step-2" style="display:none;">
      <div style="font-size:32px; margin-bottom:12px;">ğŸ‘¥</div>
      <h3 style="margin-bottom:8px; font-size:18px;">2ë‹¨ê³„: ê³µë™ í†µì¥ ì”ê³ </h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:24px;line-height:1.5;">ê°€ì¡±ê³¼ í•¨ê»˜ ì“°ëŠ” ê³µë™ ìƒí™œë¹„ í†µì¥ì´ ìˆë‹¤ë©´ ì ì–´ì£¼ì„¸ìš”.<br><b>(ê°œì¸ ê°€ê³„ë¶€ë§Œ ì“°ì‹ ë‹¤ë©´ ê±´ë„ˆë›°ì…”ë„ ë©ë‹ˆë‹¤!)</b></p>
      <div class="fg" style="margin-bottom:32px;">
        <label class="fl">ğŸ¦ ê³µë™ ìƒí™œë¹„ í†µì¥ ì”ì•¡</label>
        <input type="number" class="fi" id="wiz-j-acc" placeholder="ì˜ˆ: 1500000" inputmode="numeric">
      </div>
      <div style="display:flex;gap:8px;">
        <button class="bsub" style="background:var(--bg);color:var(--muted);border:1px solid var(--border);flex:0.6;font-size:14px;" onclick="document.getElementById('wiz-j-acc').value=''; nextWizard(3)">ê±´ë„ˆë›°ê¸°</button>
        <button class="bsub" style="background:var(--j);flex:1;" onclick="nextWizard(3)">ì…ë ¥ í›„ ë‹¤ìŒ (2/3)</button>
      </div>
    </div>

    <div id="wiz-step-3" style="display:none; text-align:center; padding-top:10px;">
      <div style="font-size:48px; margin-bottom:12px;">âœ¨</div>
      <h3 style="margin-bottom:12px; font-size:18px;">ê¸°ë³¸ ì”ê³  ì…ë ¥ ì™„ë£Œ!</h3>
      <div style="font-size:13px;color:var(--text);margin-bottom:28px;line-height:1.6;text-align:left;background:var(--s2);padding:16px;border-radius:12px;">
        <b>ì´ì œ ë§ˆì§€ë§‰ìœ¼ë¡œ 'ì˜ˆì‚°'ì„ ì„¤ì •í•  ì°¨ë¡€ì…ë‹ˆë‹¤.</b><br><br>
        ğŸ“Œ <b>ê³ ì • ê¸ˆì•¡:</b> ì›”ì„¸, í†µì‹ ë¹„ì²˜ëŸ¼ ë§¤ë‹¬ ìˆ¨ë§Œ ì‰¬ì–´ë„ <b>ë˜‘ê°™ì´</b> ë‚˜ê°€ëŠ” ëˆì´ì—ìš”.<br>
        <br>
        ğŸ“Š <b>í‰ê·  ê¸ˆì•¡:</b> ì‹ë¹„, ê¾¸ë°ˆë¹„ì²˜ëŸ¼ ë§¤ë‹¬ ë‹¤ë¥´ì§€ë§Œ <b>"ì´ ì •ë„ë§Œ ì¨ì•¼ì§€"</b> í•˜ê³  ì •í•´ë‘ëŠ” ëª©í‘œ ê¸ˆì•¡ì´ì—ìš”. (ì•±ì— ì§€ì¶œì´ ìŒ“ì¼ìˆ˜ë¡ ì§„ì§œ ë‚˜ì˜ ì›”í‰ê· ìœ¼ë¡œ ë˜‘ë˜‘í•˜ê²Œ ìë™ ë³´ì •ë©ë‹ˆë‹¤!)
      </div>
      <button class="bsub" onclick="finishWizard()" style="background:var(--text);">ì˜ˆì‚° ì„¤ì •í•˜ëŸ¬ ê°€ê¸°</button>
    </div>

  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PC=['#4A7C59','#C0752A','#2C7BB6','#8E44AD','#C0392B','#16A085','#B7950B','#5D6D7E','#A04000','#1A5276','#6C3483','#117A65','#616A6B'];
const JC=['#1A4A7A','#1A6B9A','#148F77','#A93226','#7D3C98','#B7950B','#1C2833','#0E6655'];

// budgetType: 'avg' = ì›”í‰ê·  ìë™ê³„ì‚°, 'fixed' = ê³ ì •ê¸ˆì•¡
const DEF_P=[
  {name:'ì™¸ì‹',emoji:'ğŸ½ï¸',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ì¹´í˜',emoji:'â˜•',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ë²„ìŠ¤/ì§€í•˜ì² ',emoji:'ğŸšŒ',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'íƒì‹œ',emoji:'ğŸš•',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'í†µì‹ ',emoji:'ğŸ“±',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'ë¨¸ë¦¬',emoji:'ğŸ’‡',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ì ê¸ˆ',emoji:'ğŸ’°',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'ë³´í—˜',emoji:'ğŸ›¡ï¸',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'ë¬¸í™”',emoji:'ğŸ¬',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ìœ ì§€ë¹„',emoji:'ğŸ”§',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'í• ë¶€',emoji:'ğŸ’³',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'ê¸°íƒ€',emoji:'ğŸ“¦',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ì¹´ë“œëŒ€ê¸ˆ',emoji:'ğŸ’³',budgetType:'none',seedAmt:0,seedMonths:0},
  {name:'ê¸‰ì—¬',emoji:'ğŸ’µ',budgetType:'none',seedAmt:0,seedMonths:0},
];

// ì ê¸ˆ í•˜ìœ„í•­ëª© = DEF_ASSETSì™€ ë™ì¼ ìˆœì„œ
const SAVINGS_CAT = 'ì ê¸ˆ'; // ì ê¸ˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„
const DEF_J=[
  {name:'ì™¸ì‹',emoji:'ğŸ½ï¸',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ì¹´í˜',emoji:'â˜•',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ê°€ìŠ¤',emoji:'ğŸ”¥',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ê´€ë¦¬ë¹„',emoji:'ğŸ¢',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'í™ˆ',emoji:'ğŸ¡',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ë¬¸í™”',emoji:'ğŸ¬',budgetType:'avg',seedAmt:0,seedMonths:0},
  {name:'ëŒ€ì¶œ',emoji:'ğŸ¦',budgetType:'fixed',seedAmt:0,seedMonths:0},
  {name:'ê¸°íƒ€',emoji:'ğŸ“¦',budgetType:'avg',seedAmt:0,seedMonths:0},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = 'hb5';

// ìì‚° ì •ì˜
const DEF_ASSETS = [
  {id:'coin',  name:'ì½”ì¸',     emoji:'ğŸª™', color:'#F59E0B'},
  {id:'gold',  name:'ê¸ˆ',       emoji:'ğŸ¥‡', color:'#D97706'},
  {id:'chung', name:'ì²­ì•½ì €ì¶•', emoji:'ğŸ ', color:'#2D5016'},
  {id:'isa',   name:'ISA',      emoji:'ğŸ“ˆ', color:'#0891B2'},
  {id:'stock', name:'ì£¼ì‹',     emoji:'ğŸ“Š', color:'#7C3AED'},
  {id:'irp',   name:'IRP',      emoji:'ğŸ›¡ï¸', color:'#DC2626'},
  {id:'pension',name:'ì—°ê¸ˆì €ì¶•',emoji:'ğŸ¦', color:'#1A4A7A'},
];

function defaultState() {
  return {
    month: new Date().toISOString().slice(0,7),
    ms: {},   // "YYYY-MM": { pAccBal, pCashBal, pPrevCard, jBal, assets:{id:bal} }
    txs: [],  // { id, amount, desc, date, category, payment, type, assetId? }
    pCats: DEF_P.map((c,i) => ({...c, color:PC[i%PC.length]})),
    jCats: DEF_J.map((c,i) => ({...c, color:JC[i%JC.length]})),
    // assetCats: ê°œì¸ ê³ ì •ë¹„ ì¹´í…Œê³ ë¦¬ ì¤‘ ìì‚°ê³¼ ì—°ê²°ëœ catName â†’ assetId ë§¤í•‘
    assetLinks: {}, // { catName: assetId }
  };
}

let S = (() => {
  try {
    const r = localStorage.getItem(STORAGE_KEY);
    if (r) {
      const p = JSON.parse(r);
      // ë§ˆì´ê·¸ë ˆì´ì…˜: êµ¬ë²„ì „ í•„ë“œ ì²˜ë¦¬
      Object.keys(p.ms||{}).forEach(k => {
        if (p.ms[k].pBal !== undefined && p.ms[k].pAccBal === undefined) {
          p.ms[k].pAccBal = p.ms[k].pBal; p.ms[k].pCashBal = 0; p.ms[k].pPrevCard = 0;
          delete p.ms[k].pBal;
        }
        if (p.ms[k].pPrevCard === undefined) p.ms[k].pPrevCard = 0;
      });
      // ë§ˆì´ê·¸ë ˆì´ì…˜: budgetType ì—†ëŠ” ì¹´í…Œê³ ë¦¬
      (p.pCats||[]).forEach(c => { if (!c.budgetType) c.budgetType = 'avg'; });
      (p.jCats||[]).forEach(c => { if (!c.budgetType) c.budgetType = 'avg'; });
      // budgets ìŠ¤ëƒ…ìƒ·ì€ ensureMonthBudgets()ì—ì„œ ìë™ ìƒì„±
      if (!p.assetLinks) p.assetLinks = {};
      // ë§ˆì´ê·¸ë ˆì´ì…˜: ë¯¸ì„¤ì • ì¹´í…Œê³ ë¦¬ ì œê±°
      p.pCats = (p.pCats||[]).filter(c => c.name !== 'ë¯¸ì„¤ì •');
      p.jCats = (p.jCats||[]).filter(c => c.name !== 'ë¯¸ì„¤ì •');
      // ë§ˆì´ê·¸ë ˆì´ì…˜: ë¯¸ì„¤ì • ë‚´ì—­ â†’ ê¸°íƒ€ë¡œ ë³€ê²½
      p.txs = (p.txs||[]).map(x => x.category==='ë¯¸ì„¤ì •' ? {...x, category:'ê¸°íƒ€'} : x);
      // ë§ˆì´ê·¸ë ˆì´ì…˜: ì¹´ë“œëŒ€ê¸ˆ/ê¸‰ì—¬ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ (ì—†ìœ¼ë©´)
      if (!p.pCats.find(c=>c.name==='ì¹´ë“œëŒ€ê¸ˆ'))
        p.pCats.push({name:'ì¹´ë“œëŒ€ê¸ˆ',emoji:'ğŸ’³',budgetType:'none',seedAmt:0,seedMonths:0,color:'#C0392B'});
      if (!p.pCats.find(c=>c.name==='ê¸‰ì—¬'))
        p.pCats.push({name:'ê¸‰ì—¬',emoji:'ğŸ’µ',budgetType:'none',seedAmt:0,seedMonths:0,color:'#27AE60'});
      // ë§ˆì´ê·¸ë ˆì´ì…˜: ì²­ì•½ ì¹´í…Œê³ ë¦¬ â†’ ì ê¸ˆìœ¼ë¡œ rename
      p.txs = (p.txs||[]).map(x => x.category==='ì²­ì•½' ? {...x, category:'ì ê¸ˆ', assetId:'chung'} : x);
      // ê¸°ì¡´ pCatsì—ì„œ ì²­ì•½ ì œê±°, ì ê¸ˆì— assetId ì—†ìœ¼ë©´ ìœ ì§€
      p.pCats = (p.pCats||[]).filter(c => c.name !== 'ì²­ì•½');
      if (!p.pCats.find(c=>c.name==='ì ê¸ˆ')) {
        p.pCats.splice(6, 0, {name:'ì ê¸ˆ',emoji:'ğŸ’°',budgetType:'fixed',seedAmt:0,seedMonths:0,color:'#B7950B'});
      }
      return p;
    }
  } catch(e) {}
  return defaultState();
})();

function save() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(S)); } catch(e) {} }
function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// â”€â”€ ìì‚° ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì›” ë¬¸ìì—´ í—¬í¼
function prevMonthStr(month) {
  const [y,m] = month.split('-').map(Number);
  const d = new Date(y, m-2, 1);
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
}

// ì›”ì´ˆ ì”ì•¡: ìˆ˜ë™ ì…ë ¥ ìš°ì„ , ì—†ìœ¼ë©´ ê³¼ê±°ë¡œ ê±°ìŠ¬ëŸ¬ ì˜¬ë¼ê°€ ì”ì•¡ ëˆ„ì  (ì¬ê·€ ì—†ìŒ)
function getAssetOpening(assetId, targetMonth) {
  // targetMonth í¬í•¨ ì´ì „ ë‹¬ë“¤ì„ ìˆœì„œëŒ€ë¡œ íƒìƒ‰, ìˆ˜ë™ ì…ë ¥ëœ ê°€ì¥ ìµœê·¼ ë‹¬ ì°¾ê¸°
  const MAX_LOOKBACK = 24; // ìµœëŒ€ 24ê°œì›” ì´ì „ê¹Œì§€ë§Œ
  let cursor = targetMonth;
  const monthsToAccum = []; // ìˆ˜ë™ ì…ë ¥ ë‹¬ ì´í›„ ~ targetMonth ì´ì „ê¹Œì§€ ëˆ„ì í•  ë‹¬ë“¤

  for (let i = 0; i < MAX_LOOKBACK; i++) {
    const manual = ((S.ms[cursor]||{}).assets||{})[assetId];
    if (manual !== undefined) {
      // ìˆ˜ë™ì…ë ¥ê°’ + cursorë‹¬ ì ë¦½(ë‹¨, cursorê°€ targetMonth ìì‹ ì´ë©´ ì œì™¸) + ì´í›„ ë‹¬ ì ë¦½ ëˆ„ì 
      let bal = manual;
      const accumMonths = cursor === targetMonth ? monthsToAccum : [cursor, ...monthsToAccum];
      for (const m of accumMonths) {
        bal += S.txs.filter(x =>
          x.date.startsWith(m) && x.type==='personal' &&
          x.category===SAVINGS_CAT && x.assetId===assetId
        ).reduce((s,x) => s+x.amount, 0);
      }
      return bal;
    }
    // ì´ ë‹¬ë„ ìˆ˜ë™ ì…ë ¥ ì—†ìŒ â†’ ì „ì›”ë¡œ
    monthsToAccum.unshift(cursor);
    cursor = prevMonthStr(cursor);
  }
  return 0; // 24ê°œì›” ë‚´ ìˆ˜ë™ ì…ë ¥ ì—†ìœ¼ë©´ 0
}

// ìì‚° í˜„ì¬ì”ì•¡ = ì›”ì´ˆì”ì•¡ + ì´ë²ˆë‹¬ ì ë¦½
function getAssetBal(assetId, month) {
  month = month || S.month;
  const opening = getAssetOpening(assetId, month);
  const deposited = S.txs.filter(x =>
    x.date.startsWith(month) && x.type==='personal' &&
    x.category===SAVINGS_CAT && x.assetId===assetId
  ).reduce((s,x) => s+x.amount, 0);
  return { opening, deposited, balance: opening + deposited };
}
function fmt(n) { return 'â‚©'+Math.abs(Math.round(n)).toLocaleString('ko-KR'); }
function fmtDiff(n) { return (n>=0?'+':'-')+'â‚©'+Math.abs(Math.round(n)).toLocaleString('ko-KR'); }
function cats(t) { return t==='personal' ? S.pCats : S.jCats; }
function txOfMonth(t, month) { const m=month||S.month; return S.txs.filter(x=>x.date.startsWith(m)&&x.type===t); }
// dir: 'expense'(ê¸°ë³¸) ë˜ëŠ” 'income'
function txOfMonthDir(t, dir, month) {
  const m=month||S.month;
  return S.txs.filter(x=>x.date.startsWith(m)&&x.type===t&&(x.dir||'expense')===dir);
}
function catSpend(name, list) { return list.filter(x=>x.category===name).reduce((s,x)=>s+x.amount,0); }
function catIncome(name, list) { return list.filter(x=>x.category===name).reduce((s,x)=>s+x.amount,0); }
// ì¹´í…Œê³ ë¦¬ ìˆœì§€ì¶œ = ì§€ì¶œ - ìˆ˜ì… (ìŒìˆ˜ ê°€ëŠ¥)
function catNetSpend(name, type) {
  const spent  = catSpend(name, txOfMonthDir(type,'expense'));
  const income = catSpend(name, txOfMonthDir(type,'income'));
  return spent - income;
}
function getMs(month) { return S.ms[month||S.month]||{}; }

// â”€â”€ ëˆ„ì  ì›”í‰ê·  ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appMonthsRecorded(type) {
  return new Set(S.txs.filter(x=>x.type===type).map(x=>x.date.slice(0,7))).size;
}
function appTotalForCat(catName, type) {
  return S.txs.filter(x=>x.type===type&&x.category===catName).reduce((s,x)=>s+x.amount,0);
}

// â”€â”€ ì˜ˆì‚° ìŠ¤ëƒ…ìƒ· ì‹œìŠ¤í…œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë‹¹ì›” ì˜ˆì‚°ì€ ì›”ì´ˆì— í•œ ë²ˆ í™•ì • â†’ ms[month].budgets ì— ì €ì¥.
// ê³„ì‚°ì€ "í•´ë‹¹ ì›” ì´ì „" ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ë‹¹ì›” ì§€ì¶œì´ ì˜ˆì‚°ì— ì˜í–¥ ì—†ìŒ.

function calcBudgetForSnapshot(cat, type, beforeMonth) {
  // beforeMonth ì´ì „ ë‹¬ê¹Œì§€ì˜ ë°ì´í„°ë§Œìœ¼ë¡œ ì˜ˆì‚° ê³„ì‚°
  if (cat.budgetType === 'none') return 0;
  if (cat.budgetType === 'fixed') return cat.seedAmt || 0;
  const pastTxs = S.txs.filter(x=>x.type===type && x.category===cat.name && x.date.slice(0,7) < beforeMonth);
  const pastMonths = new Set(S.txs.filter(x=>x.type===type && x.date.slice(0,7) < beforeMonth).map(x=>x.date.slice(0,7))).size;
  const appTotal = pastTxs.reduce((s,x)=>s+x.amount,0);
  const totalMonths = (cat.seedMonths||0) + pastMonths;
  if (totalMonths === 0) return 0;
  return Math.round(((cat.seedAmt||0)*(cat.seedMonths||0) + appTotal) / totalMonths);
}

function ensureMonthBudgets(month) {
  // í•´ë‹¹ ì›” ìŠ¤ëƒ…ìƒ·ì´ ì—†ìœ¼ë©´ ìƒì„±
  month = month || S.month;
  if (!S.ms[month]) S.ms[month] = {};
  if (S.ms[month].budgets) return;
  const snap = { personal:{}, joint:{} };
  ['personal','joint'].forEach(type => {
    cats(type).forEach(c => { snap[type][c.name] = calcBudgetForSnapshot(c, type, month); });
  });
  S.ms[month].budgets = snap;
  save();
}

function getMonthBudget(catName, type, month) {
  month = month || S.month;
  const snap = (S.ms[month]||{}).budgets;
  const base = (snap && snap[type] && snap[type][catName] !== undefined)
    ? snap[type][catName]
    : (cats(type).find(c=>c.name===catName)
        ? calcBudgetForSnapshot(cats(type).find(c=>c.name===catName), type, month)
        : 0);
  // ì›”í‰ê·  íƒ€ì…ì¸ ê²½ìš°ë§Œ ì¡°ì •ì•¡ ì ìš©
  const cat = cats(type).find(c=>c.name===catName);
  if (!cat || cat.budgetType === 'fixed') return base;
  const adj = ((S.ms[month]||{}).adjusts||{})[type]?.[catName] || 0;
  return Math.max(0, base + adj);
}

function getMonthBudgetBase(catName, type, month) {
  // ì¡°ì •ì•¡ ì œì™¸í•œ ìˆœìˆ˜ ìŠ¤ëƒ…ìƒ· ì˜ˆì‚° (ì„¤ì • í™”ë©´ í‘œì‹œìš©)
  month = month || S.month;
  const snap = (S.ms[month]||{}).budgets;
  if (snap && snap[type] && snap[type][catName] !== undefined) return snap[type][catName];
  const cat = cats(type).find(c=>c.name===catName);
  return cat ? calcBudgetForSnapshot(cat, type, month) : 0;
}

function saveAdjust(type, catName, val) {
  const month = S.month;
  if (!S.ms[month]) S.ms[month] = {};
  if (!S.ms[month].adjusts) S.ms[month].adjusts = {};
  if (!S.ms[month].adjusts[type]) S.ms[month].adjusts[type] = {};
  const n = parseFloat(val);
  if (!n) delete S.ms[month].adjusts[type][catName];
  else S.ms[month].adjusts[type][catName] = n;
  save();
  renderOv(type); renderSettle(type); renderBudgetSection(type);
}

function calcBudgetPreview(cat, type) {
  if (cat.budgetType === 'none') return 0;
  if (cat.budgetType === 'fixed') return cat.seedAmt || 0;
  // S.month ì´í•˜(<=) ëª¨ë“  ë‹¬ í¬í•¨
  const allTxs = S.txs.filter(x=>x.type===type && x.category===cat.name && x.date.slice(0,7) <= S.month);
  const allMonths = new Set(S.txs.filter(x=>x.type===type && x.date.slice(0,7) <= S.month).map(x=>x.date.slice(0,7))).size;
  const appTotal = allTxs.reduce((s,x)=>s+x.amount,0);
  const totalMonths = (cat.seedMonths||0) + allMonths;
  if (totalMonths === 0) return 0;
  return Math.round(((cat.seedAmt||0)*(cat.seedMonths||0) + appTotal) / totalMonths);
}

function resetMonthBudgets(month) {
  // ì„¤ì • ë³€ê²½ ì‹œ ë‹¹ì›” ìŠ¤ëƒ…ìƒ· ê°•ì œ ì¬ìƒì„±
  month = month || S.month;
  if (S.ms[month]) delete S.ms[month].budgets;
  ensureMonthBudgets(month);
}

function fixedTotal(type, month) {
  month = month || S.month;
  return cats(type).filter(c=>c.budgetType!=='none').reduce((s,c) => s + getMonthBudget(c.name, type, month), 0);
}

function overBudget(type) {
  return cats(type).filter(c=>c.budgetType!=='none').reduce((s,c) => {
    const bud = getMonthBudget(c.name, type);
    const net = catNetSpend(c.name, type); // ì§€ì¶œ - ìˆ˜ì…
    return net > bud ? s+(net-bud) : s;
  }, 0);
}

// â”€â”€ ê°œì¸ ì”ì•¡ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcPersonalRemain(ms) {
  ms = ms || getMs();
  const accOpen  = ms.pAccBal   || 0;
  const cashOpen = ms.pCashBal  || 0;
  const prevCard = ms.pPrevCard || 0;
  const pExpList = txOfMonthDir('personal','expense');
  const pIncList = txOfMonthDir('personal','income');

  // ì§€ì¶œ
  const accSpent  = pExpList.filter(x=>x.payment==='account').reduce((s,x)=>s+x.amount,0);
  const cashSpent = pExpList.filter(x=>x.payment==='cash').reduce((s,x)=>s+x.amount,0);
  const cardSpent = pExpList.filter(x=>x.payment==='card').reduce((s,x)=>s+x.amount,0);
  const jCardAmt  = txOfMonthDir('joint','expense').filter(x=>x.payment==='card').reduce((s,x)=>s+x.amount,0);

  // ìˆ˜ì…
  const accIncome  = pIncList.filter(x=>x.payment==='account').reduce((s,x)=>s+x.amount,0);
  const cashIncome = pIncList.filter(x=>x.payment==='cash').reduce((s,x)=>s+x.amount,0);
  const totalIncome = accIncome + cashIncome;

  // ì‹¤ì œ ì”ì•¡ (ìˆ˜ì… í¬í•¨)
  const actualAccBal  = accOpen  - accSpent  + accIncome  + jCardAmt;
  const actualCashBal = cashOpen - cashSpent + cashIncome;

  // ì—¬ìœ ìê¸ˆ = (ì›”ì´ˆì”ê³  + ìˆ˜ì…) - ê³ ì •ë¹„ì˜ˆì‚° - ì „ì›”ì¹´ë“œ - ì´ˆê³¼ì§€ì¶œ
  const fixed = fixedTotal('personal');
  const totalOpening = accOpen + cashOpen;
  const over  = overBudget('personal');
  const flex  = totalOpening - fixed - prevCard;  // ìˆ˜ì…ì€ catNetSpendâ†’overBudgetì—ì„œ ë°˜ì˜
  const remain = flex - over;
  const totalActual = actualAccBal + actualCashBal;
  return { accOpen, cashOpen, prevCard, fixed, flex, remain, over,
           accSpent, cashSpent, cardSpent, jCardAmt,
           accIncome, cashIncome, totalIncome,
           actualAccBal, actualCashBal, totalActual };
}

// â”€â”€ ê³µë™ ì”ì•¡ ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcJointRemain(ms) {
  ms = ms || getMs();
  const opening = ms.jBal || 0;
  const jExpList = txOfMonthDir('joint','expense');
  const jIncList = txOfMonthDir('joint','income');
  const totalSpent   = jExpList.reduce((s,x)=>s+x.amount,0);
  const cardSpent    = jExpList.filter(x=>x.payment==='card').reduce((s,x)=>s+x.amount,0);
  const accSpent     = jExpList.filter(x=>x.payment==='account').reduce((s,x)=>s+x.amount,0);
  const accIncome    = jIncList.filter(x=>x.payment==='account').reduce((s,x)=>s+x.amount,0);
  const cashIncome   = jIncList.filter(x=>x.payment==='cash').reduce((s,x)=>s+x.amount,0);
  const totalIncome  = accIncome + cashIncome;
  // ì‹¤ì”ì•¡ = ì›”ì´ˆ - ì§€ì¶œ + ìˆ˜ì… (ë¯¸ì„¤ì • í¬í•¨ ì „ì²´ ê±°ë˜ ë°˜ì˜)
  const actualRemain = opening - totalSpent + totalIncome;
  return { opening, totalSpent, cardSpent, accSpent,
           accIncome, cashIncome, totalIncome,
           remain: actualRemain };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MONTH NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changeMonth(d) {
  const [y,m]=S.month.split('-').map(Number);
  const nd=new Date(y,m-1+d,1);
  S.month=`${nd.getFullYear()}-${String(nd.getMonth()+1).padStart(2,'0')}`;
  ensureMonthBudgets(S.month);
  save(); render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mainTab='overview', subTab='personal';

function switchMain(t) {
  mainTab=t;
  document.querySelectorAll('.ntab').forEach((el,i)=>el.classList.toggle('active',['overview','transactions','assets','settle','settings'][i]===t));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+t).classList.add('active');
  const showSub = (t==='overview'||t==='transactions'||t==='settle');
  document.getElementById('subTabRow').style.display = showSub?'flex':'none';
  if(t==='transactions') { txFilter='all'; renderTxFilter(); }
  applySubTab();
}

function switchSub(s) {
  subTab=s;
  ['personal','joint'].forEach(x=>{
    document.getElementById('st-'+x).className='stab'+(s===x?` active ${x}`:` ${x}`);
  });
  document.getElementById('fab').style.background=s==='personal'?'var(--p)':'var(--j)';
  txFilter='all';
  if(mainTab==='transactions') renderTxFilter();
  applySubTab();
}

function applySubTab() {
  const sp=subTab==='personal';
  ['ov-p','ov-j'].forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.style.display=i===0?(sp?'block':'none'):(sp?'none':'block'); });
  ['tx-p','tx-j'].forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.style.display=i===0?(sp?'block':'none'):(sp?'none':'block'); });
  ['settle-p','settle-j'].forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.style.display=i===0?(sp?'block':'none'):(sp?'none':'block'); });
  // ë‚´ì—­íƒ­ ìš”ì•½
  const spSum=document.getElementById('tx-summary-p'); if(spSum) spSum.style.display=sp?'block':'none';
  const sjSum=document.getElementById('tx-summary-j'); if(sjSum) sjSum.style.display=sp?'none':'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  document.getElementById('monthLabel').textContent=parseInt(S.month.split('-')[1])+'ì›”';
  renderOv('personal'); renderOv('joint');
  renderTx('personal'); renderTx('joint');
  renderSettle('personal'); renderSettle('joint');
  renderAssets();
  renderSettingsPage();
}

// â”€â”€ Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOv(t) {
  const ms = getMs();
  const list = txOfMonth(t);

  if (t === 'personal') {
    // ì „ì²´ txsê°€ ì—†ê³ , ì–´ë–¤ ë‹¬ì—ë„ ì”ê³  ì„¤ì •ì´ ì—†ì„ ë•Œë§Œ ì˜¨ë³´ë”©
    const hasAnyBal = Object.values(S.ms||{}).some(m => m.pAccBal || m.pCashBal);
    const isSetupNeeded = !hasAnyBal && S.txs.length === 0;
    document.getElementById('ov-p-empty').style.display = isSetupNeeded ? 'block' : 'none';
    document.getElementById('ov-p-main').style.display  = isSetupNeeded ? 'none'  : 'block';
    if (isSetupNeeded) return;

    const r = calcPersonalRemain(ms);
    const remain = r.remain;
    document.getElementById('p-amt').textContent = remain<0?`-${fmt(remain)}`:fmt(remain);
    document.getElementById('p-amt').className='balamt'+(remain<0?' danger':'');
    document.getElementById('p-lbl').textContent=remain<0?'ì—¬ìœ ìê¸ˆ ì´ˆê³¼':'ì—¬ìœ ìê¸ˆ ì”ì•¡';
    document.getElementById('p-acc-bal').textContent=fmt(r.actualAccBal);
    document.getElementById('p-cash-bal').textContent=fmt(r.actualCashBal);
    document.getElementById('p-open-bal').textContent=fmt(r.accOpen+r.cashOpen);
    document.getElementById('p-open-acc').textContent=fmt(r.accOpen);
    document.getElementById('p-open-cash').textContent=fmt(r.cashOpen);
    const curBal=r.actualAccBal+r.actualCashBal;
    const openBal=r.accOpen+r.cashOpen;
    document.getElementById('p-total-bal').textContent=fmt(curBal);
    const balBar=document.getElementById('p-bal-bar');
    const balPct=openBal>0?Math.min(100,curBal/openBal*100):0;
    balBar.style.width=balPct+'%';
    balBar.className='pfill '+(balPct>60?'p-ok':balPct>30?'warn':'over');
    document.getElementById('p-flex-open').textContent=fmt(r.flex);
    const flexNowEl=document.getElementById('p-flex-now');
    flexNowEl.textContent=r.remain<0?`-${fmt(r.remain)}`:fmt(r.remain);
    flexNowEl.style.color=r.remain<0?'var(--danger)':r.remain>0?'var(--ok)':'var(--text)';
    document.getElementById('p-total-spent').textContent=fmt(r.accSpent+r.cashSpent+r.cardSpent);
    document.getElementById('p-total-income').textContent=r.totalIncome>0?`+${fmt(r.totalIncome)}`:'â‚©0';

    const pct=Math.min(100,r.over/Math.max(r.flex,1)*100);
    const bar=document.getElementById('p-bar');
    bar.style.width=pct+'%';
    bar.className='pfill '+(pct<60?'p-ok':pct<90?'warn':'over');

    document.getElementById('p-acc-income').textContent=r.accIncome>0?`+${fmt(r.accIncome)}`:'â‚©0';
    document.getElementById('p-cash-income').textContent=r.cashIncome>0?`+${fmt(r.cashIncome)}`:'â‚©0';
    const pIncList = txOfMonthDir('personal','income');
    document.getElementById('p-income-cats').innerHTML=renderIncomeCatList('personal', pIncList);

    document.getElementById('p-acc-spent').textContent=fmt(r.accSpent);
    document.getElementById('p-cash-spent').textContent=fmt(r.cashSpent);
    document.getElementById('p-card-spent').textContent=fmt(r.cardSpent);
    document.getElementById('p-jcard-rebate').textContent=r.jCardAmt>0?`+${fmt(r.jCardAmt)}`:'â‚©0';

    const rebateEl=document.getElementById('p-rebate');
    const notes=[];
    if(r.cardSpent>0) notes.push(`ğŸ’³ ì¹´ë“œ ${fmt(r.cardSpent)} â†’ ê³„ì¢Œ ì”ì•¡ ë³€ë™ ì—†ìŒ Â· ì—¬ìœ ìê¸ˆì—ì„œ ì°¨ê°`);
    if(r.jCardAmt>0) notes.push(`ğŸ”„ ê³µë™ì¹´ë“œ ${fmt(r.jCardAmt)} â†’ ê³µë™ì”ì•¡ ì°¨ê° + ê°œì¸ê³„ì¢Œ ë³´ì „`);
    if(r.prevCard>0) notes.push(`ğŸ“… ì „ì›”ì¹´ë“œ ${fmt(r.prevCard)} â†’ ì—¬ìœ ìê¸ˆì—ì„œ ì°¨ê°`);
    rebateEl.innerHTML=notes.length?`<div style="font-size:11px;color:var(--muted);background:var(--s2);border-radius:8px;padding:8px 12px;margin-top:8px;line-height:1.9">${notes.join('<br>')}</div>`:'';

    const txsPI = document.getElementById('txs-p-income');
    const txsPS = document.getElementById('txs-p-spent');
    if(txsPI) txsPI.textContent = r.totalIncome>0?`+${fmt(r.totalIncome)}`:'â‚©0';
    if(txsPS) txsPS.textContent = fmt(r.accSpent+r.cashSpent+r.cardSpent);

    const pExpList = txOfMonthDir('personal','expense');
    document.getElementById('p-cats').innerHTML=renderCatList('personal', pExpList);

  } else {
    const hasAnyJBal = Object.values(S.ms||{}).some(m => m.jBal);
    const isSetupNeeded = !hasAnyJBal && S.txs.filter(x=>x.type==='joint').length === 0;
    document.getElementById('ov-j-empty').style.display = isSetupNeeded ? 'block' : 'none';
    document.getElementById('ov-j-main').style.display  = isSetupNeeded ? 'none'  : 'block';
    if (isSetupNeeded) return;

    const r = calcJointRemain(ms);
    document.getElementById('j-amt').textContent=r.remain<0?`-${fmt(r.remain)}`:fmt(r.remain);
    document.getElementById('j-amt').className='balamt'+(r.remain<0?' danger':'');
    document.getElementById('j-lbl').textContent=r.remain<0?'ì´ˆê³¼':'ì”ì•¡';

    const pct=Math.min(100,r.totalSpent/Math.max(r.opening,1)*100);
    const bar=document.getElementById('j-bar');
    bar.style.width=pct+'%';
    bar.className='pfill '+(pct<60?'j-ok':pct<90?'warn':'over');

    document.getElementById('j-acc-income').textContent=r.accIncome>0?`+${fmt(r.accIncome)}`:'â‚©0';
    document.getElementById('j-cash-income').textContent=r.cashIncome>0?`+${fmt(r.cashIncome)}`:'â‚©0';
    const jIncList = txOfMonthDir('joint','income');
    document.getElementById('j-income-cats').innerHTML=renderIncomeCatList('joint', jIncList);

    document.getElementById('j-total').textContent=fmt(r.totalSpent);
    const jtInc = document.getElementById('j-total-income');
    if(jtInc) jtInc.textContent = r.totalIncome>0?`+${fmt(r.totalIncome)}`:'â‚©0';
    document.getElementById('j-open-bal').textContent=fmt(r.opening);
    const jAccBal = document.getElementById('j-acc-bal');
    if(jAccBal) jAccBal.textContent = fmt(r.opening - r.totalSpent + r.totalIncome);

    const bdEl=document.getElementById('j-breakdown');
    if(r.cardSpent>0||r.accSpent>0){
      bdEl.innerHTML=`<div style="font-size:11px;color:var(--muted);margin-top:8px;line-height:1.9">
        ğŸ¦ ê³„ì¢Œ ${fmt(r.accSpent)} â†’ ì¦‰ì‹œ ì°¨ê°<br>
        ğŸ’³ ì¹´ë“œ ${fmt(r.cardSpent)} â†’ ê³µë™ ì°¨ê° + ê°œì¸ ê³„ì¢Œ ë³´ì „
      </div>`;
    } else { bdEl.innerHTML=''; }

    const txsJI = document.getElementById('txs-j-income');
    const txsJS = document.getElementById('txs-j-spent');
    if(txsJI) txsJI.textContent = r.totalIncome>0?`+${fmt(r.totalIncome)}`:'â‚©0';
    if(txsJS) txsJS.textContent = fmt(r.totalSpent);
    const jExpList = txOfMonthDir('joint','expense');
    document.getElementById('j-cats').innerHTML=renderCatList('joint', jExpList);
  }
}

function renderIncomeCatList(type, incList) {
  if (!incList.length) return '<div style="font-size:12px;color:var(--muted);padding:6px 0">ì´ë²ˆ ë‹¬ ìˆ˜ì… ì—†ìŒ</div>';
  const incCats = cats(type);
  const rows = incCats.map(c => {
    const amt = incList.filter(x=>x.category===c.name).reduce((s,x)=>s+x.amount,0);
    if (!amt) return '';
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);">
      <span style="font-size:13px">${c.emoji} ${c.name}</span>
      <span style="font-family:'DM Mono',monospace;font-size:13px;font-weight:600;color:var(--ok)">+${fmt(amt)}</span>
    </div>`;
  }).filter(Boolean).join('');
  const knownCats = incCats.map(c=>c.name);
  const etc = incList.filter(x=>!knownCats.includes(x.category)).reduce((s,x)=>s+x.amount,0);
  const etcRow = etc>0 ? `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;">
    <span style="font-size:13px">ğŸ“¥ ê¸°íƒ€</span>
    <span style="font-family:'DM Mono',monospace;font-size:13px;font-weight:600;color:var(--ok)">+${fmt(etc)}</span>
  </div>` : '';
  return `<div style="margin-top:8px">${rows}${etcRow}</div>`;
}

function renderCatList(type, list) {
  const items = cats(type).map(c=>{
    const bud = getMonthBudget(c.name, type);
    const sp  = catSpend(c.name, list);
    const inc = catSpend(c.name, txOfMonthDir(type,'income'));
    const net = sp - inc;
    return {c, bud, net};
  });
  items.sort((a,b) => b.net - a.net);
  return items.map(({c, bud, net})=>{
    const absNet = Math.abs(net);
    const isIncomeSurplus = net < 0;
    const pct = bud>0 ? Math.min(100, Math.max(0, net)/bud*100) : 0;
    const isOver = net>bud && bud>0;
    const diff = bud>0 ? bud - net : null;
    const diffHtml = diff!==null
      ? `<span style="font-size:10px;font-weight:700;color:${diff>=0?'var(--ok)':'var(--danger)'}">${diff>=0?'âˆ’'+fmt(diff):'+'+fmt(Math.abs(diff))}</span>`
      : '';
    const typeBadge = c.budgetType==='none'
      ? ''
      : c.budgetType==='fixed'
        ? `<span style="font-size:9px;color:#5555AA;background:#F0F0FF;padding:1px 5px;border-radius:8px;margin-left:4px">ê³ ì •</span>`
        : `<span style="font-size:9px;color:var(--p);background:var(--plt);padding:1px 5px;border-radius:8px;margin-left:4px">í‰ê· </span>`;
    const amtColor = isIncomeSurplus ? 'var(--ok)' : isOver ? 'var(--danger)' : 'var(--text)';
    const amtText = isIncomeSurplus ? `+${fmt(absNet)}` : fmt(net);
    const budgetLine = c.budgetType==='none'
      ? `<div class="cbudget" style="color:var(--muted)">ì˜ˆì‚° ì—†ìŒ</div>`
      : `<div class="cbudget">/ ${bud>0?fmt(bud):'ë¯¸ì„¤ì •'} ${diffHtml}</div>`;
    return `<div class="crow">
      <div class="cdot" style="background:${c.color}"></div>
      <div class="cinfo">
        <div class="cname">${c.emoji} ${c.name}${typeBadge}</div>
        <div class="cbw"><div class="cbf" style="width:${pct}%;background:${isOver?'var(--danger)':c.color}"></div></div>
      </div>
      <div class="cright">
        <div class="cspent" style="color:${amtColor}">${amtText}</div>
        ${budgetLine}
      </div>
    </div>`;
  }).join('')||'<div style="color:var(--muted);font-size:13px;padding:6px 0">ë‚´ì—­ ì—†ìŒ</div>';
}

// â”€â”€ Transactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í•„í„° ìƒíƒœ: 'all' | 'income' | 'expense' | 'date' | 'cat:ì¹´í…Œê³ ë¦¬ëª…'
let txFilter = 'all';

function setTxFilter(f) {
  txFilter = f;
  renderTxFilter();
  renderTx('personal');
  renderTx('joint');
}

function renderTxFilter() {
  const t = subTab;
  const actCls = t==='personal' ? 'p-act' : 'j-act';
  const catList = cats(t);
  const filters = [
    {id:'all', label:'ì „ì²´'},
    {id:'income', label:'ğŸ“ˆ ìˆ˜ì…'},
    {id:'expense', label:'ğŸ“‰ ì§€ì¶œ'},
    ...catList.map(c=>({id:`cat:${c.name}`, label:`${c.emoji} ${c.name}`})),
  ];
  document.getElementById('txfilter').innerHTML = filters.map(f=>
    `<button class="txftab${txFilter===f.id?' active '+actCls:''}" onclick="setTxFilter('${f.id}')">${f.label}</button>`
  ).join('');
}

function txItemHtml(x, cl) {
  const cat=cl.find(c=>c.name===x.category)||{};
  const color=cat.color||'#9CA3AF';
  const pm=x.payment==='card'?'<span class="badge b-card">ì¹´ë“œ</span>':x.payment==='account'?'<span class="badge b-acc">ê³„ì¢Œ</span>':'<span class="badge b-cash">í˜„ê¸ˆ</span>';
  const assetDef = x.assetId ? DEF_ASSETS.find(a=>a.id===x.assetId) : null;
  const assetBadge = assetDef ? `<span class="badge" style="background:${assetDef.color}22;color:${assetDef.color}">${assetDef.emoji} ${assetDef.name}</span>` : '';
  const isIncome = (x.dir||'expense')==='income';
  const incBadge = isIncome ? '<span class="badge b-income">ìˆ˜ì…</span>' : '';
  const iconEmoji = assetDef ? assetDef.emoji : (cat.emoji||'â“');
  const iconBg = isIncome ? 'var(--olt)' : `${color}22`;
  return `<div class="txitem" onclick="openEditModal('${x.id}')">
    <div class="txicon" style="background:${iconBg}">${iconEmoji}</div>
    <div class="txbody">
      <div class="txname">${x.desc}</div>
      <div class="txmeta">${incBadge}${pm}<span class="badge" style="background:var(--s2);color:var(--muted)">${x.category}</span>${assetBadge}</div>
    </div>
    <div class="txamt" style="color:${isIncome?'var(--ok)':'var(--danger)'}">${isIncome?'+':''}${fmt(x.amount)}</div>
  </div>`;
}

function renderTx(t) {
  const pfx=t==='personal'?'p':'j';
  const el=document.getElementById('tx-'+pfx);
  const cl=cats(t);

  // ì „ì²´ ëª©ë¡
  let all=txOfMonth(t).sort((a,b)=>b.date.localeCompare(a.date)||b.id.localeCompare(a.id));

  // í•„í„° ì ìš©
  let filtered = all;
  if (txFilter==='income') {
    filtered=all.filter(x=>(x.dir||'expense')==='income');
  } else if (txFilter==='expense') {
    filtered=all.filter(x=>(x.dir||'expense')==='expense');
  } else if (txFilter.startsWith('cat:')) {
    const catName=txFilter.split(':')[1];
    filtered=all.filter(x=>x.category===catName);
  }

  if (!filtered.length) {
    el.innerHTML=`<div class="empty"><div class="icon">${t==='personal'?'ğŸ‘¤':'ğŸ‘¥'}</div><p>í•´ë‹¹ ë‚´ì—­ì´ ì—†ì–´ìš”</p></div>`;
    return;
  }

  // ë‚ ì§œë³„ ê·¸ë£¹ ë Œë”ë§ í—¬í¼
  function renderByDate(items) {
    const byDate={};
    items.forEach(x=>{ if(!byDate[x.date]) byDate[x.date]=[]; byDate[x.date].push(x); });
    let h='';
    Object.keys(byDate).sort((a,b)=>b.localeCompare(a)).forEach(date=>{
      const [,mm,dd]=date.split('-');
      const dayItems=byDate[date].sort((a,b)=>b.amount-a.amount);
      const dayExp=dayItems.filter(x=>(x.dir||'expense')==='expense').reduce((s,x)=>s+x.amount,0);
      const dayInc=dayItems.filter(x=>(x.dir||'expense')==='income').reduce((s,x)=>s+x.amount,0);
      let sumHtml='';
      if(dayInc>0&&dayExp>0) sumHtml=`<span style="color:var(--ok)">+${fmt(dayInc)}</span> <span style="color:var(--danger)">-${fmt(dayExp)}</span>`;
      else if(dayInc>0) sumHtml=`<span style="color:var(--ok)">+${fmt(dayInc)}</span>`;
      else sumHtml=`<span>${fmt(dayExp)}</span>`;
      h+=`<div class="txdh"><span>${parseInt(mm)}/${parseInt(dd)}</span><span style="font-size:11px">${sumHtml}</span></div>`;
      dayItems.forEach(x=>{ h+=txItemHtml(x,cl); });
    });
    return h;
  }

  // ìˆ˜ì…/ì§€ì¶œ í•„í„° í—¤ë”
  if (txFilter==='income' || txFilter==='expense') {
    const isInc = txFilter==='income';
    const total = filtered.reduce((s,x)=>s+x.amount, 0);
    let html=`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0 8px;border-bottom:2px solid var(--border);margin-bottom:4px;">
      <span style="font-weight:600">${isInc?'ğŸ“ˆ ìˆ˜ì…':'ğŸ“‰ ì§€ì¶œ'}</span>
      <span style="font-family:'DM Mono',monospace;font-size:13px;color:${isInc?'var(--ok)':'var(--danger)'}">${isInc?'+':''}${fmt(total)}</span>
    </div>`;
    html += renderByDate(filtered);
    el.innerHTML=html;
    return;
  }

  // ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹
  if (txFilter.startsWith('cat:')) {
    const parts = txFilter.split(':');
    const catName = parts[1];
    const dirSub = parts[2] || 'all';
    const cat = cl.find(c=>c.name===catName)||{};

    let catFiltered = filtered;
    if (dirSub==='income') catFiltered = filtered.filter(x=>(x.dir||'expense')==='income');
    else if (dirSub==='expense') catFiltered = filtered.filter(x=>(x.dir||'expense')==='expense');

    const totalExp = filtered.filter(x=>(x.dir||'expense')==='expense').reduce((s,x)=>s+x.amount,0);
    const totalInc = filtered.filter(x=>(x.dir||'expense')==='income').reduce((s,x)=>s+x.amount,0);
    const net = totalExp - totalInc;

    const actCls2 = subTab==='personal'?'p-act':'j-act';
    const subBtnCls = (d) => `txftab${dirSub===d?' active '+actCls2:''}`;

    let html=`<div style="padding:10px 0 8px;border-bottom:2px solid var(--border);margin-bottom:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-weight:600">${cat.emoji||'â“'} ${catName}</span>
        <span style="font-family:'DM Mono',monospace;font-size:13px;color:${net<0?'var(--ok)':'var(--text)'}">${net<0?'+'+fmt(totalInc-totalExp):fmt(net)}</span>
      </div>
      <div style="display:flex;gap:6px;font-size:12px">
        <button class="${subBtnCls('all')}" onclick="setTxFilter('cat:${catName}')">ì „ì²´</button>
        <button class="${subBtnCls('income')}" onclick="setTxFilter('cat:${catName}:income')">ğŸ“ˆ ìˆ˜ì… +${fmt(totalInc)}</button>
        <button class="${subBtnCls('expense')}" onclick="setTxFilter('cat:${catName}:expense')">ğŸ“‰ ì§€ì¶œ ${fmt(totalExp)}</button>
      </div>
    </div>`;
    if (!catFiltered.length) {
      html += `<div class="empty"><div class="icon">ğŸ“­</div><p>í•´ë‹¹ ë‚´ì—­ì´ ì—†ì–´ìš”</p></div>`;
    } else {
      html += renderByDate(catFiltered);
    }
    el.innerHTML=html;
    return;
  }

  // ì „ì²´ ì¼ë³„ ê·¸ë£¹
  el.innerHTML=renderByDate(filtered);
}

// â”€â”€ Settle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSettle(t) {
  const pfx=t==='personal'?'p':'j';
  const list=txOfMonth(t);
  let totalBudget=0, totalSpent=0, totalIncome=0;

  const rows=cats(t).map(c=>{
    const bud = getMonthBudget(c.name,t);
    const sp  = catSpend(c.name, list);
    const inc = catSpend(c.name, txOfMonthDir(t,'income'));
    const net = sp - inc; // ìˆ˜ì§€ (ìŒìˆ˜=ìˆ˜ì…ì´ˆê³¼)
    const diff = bud>0 ? bud - Math.max(0,net) : null;
    totalBudget+=bud; totalSpent+=sp; totalIncome+=inc;
    return {c, bud, sp, inc, net, diff};
  })
  .sort((a,b) => {
    const aHasBud = a.bud > 0, bHasBud = b.bud > 0;
    if (!aHasBud && !bHasBud) return 0;
    if (!aHasBud) return 1;
    if (!bHasBud) return -1;
    const ad = a.diff??0, bd = b.diff??0;
    if (ad < 0 && bd < 0) return ad - bd;
    if (ad < 0) return -1;
    if (bd < 0) return 1;
    return bd - ad;
  })
  .map(({c, bud, sp, inc, net, diff}) => {
    const isIncomeSurplus = net < 0;
    const diffCls = diff===null?'':diff>=0?'plus':'minus';
    const typeBadge = c.budgetType==='none' ? ''
      : c.budgetType==='fixed'
        ? `<span class="srow-type fixed">ê³ ì •</span>`
        : `<span class="srow-type avg">í‰ê· </span>`;
    const netColor = isIncomeSurplus?'var(--ok)':Math.max(0,net)>bud&&bud>0?'var(--danger)':'var(--text)';
    return `<div class="srow">
      <div class="srow-dot" style="background:${c.color}"></div>
      <div class="srow-name">${c.emoji} ${c.name}${typeBadge}</div>
      <div class="srow-budget">${bud>0?fmt(bud):'-'}</div>
      <div class="srow-net" style="color:${netColor}">${isIncomeSurplus?'+'+fmt(Math.abs(net)):fmt(net)}</div>
      <div class="srow-diff ${diffCls}">${diff!==null?fmtDiff(diff):'-'}</div>
    </div>`;
  }).join('');

  document.getElementById(`s${pfx}-rows`).innerHTML=rows||'<div style="color:var(--muted);font-size:13px;padding:12px 0;text-align:center">ì§€ì¶œ ë‚´ì—­ ì—†ìŒ</div>';

  const totalNet = totalSpent - totalIncome;
  document.getElementById(`s${pfx}-spent`).textContent=totalNet<0?'+'+fmt(Math.abs(totalNet)):fmt(totalNet);

  const diffEl  = document.getElementById(`s${pfx}-diff`);
  const rateEl  = document.getElementById(`s${pfx}-rate`);
  const budgEl  = document.getElementById(`s${pfx}-budget`);

  if (pfx==='p') {
    // ê°œì¸: ì›”ì´ˆ ì”ì•¡(ê³„ì¢Œ+í˜„ê¸ˆ) ê¸°ì¤€
    const ms = getMs();
    const opening = (ms.pAccBal||0) + (ms.pCashBal||0);
    const netPos  = Math.max(0, totalNet);
    const saved   = opening - netPos;

    budgEl.textContent = fmt(opening);
    diffEl.textContent = opening>0 ? fmtDiff(saved) : '-';
    diffEl.style.color = saved>=0 ? 'var(--ok)' : 'var(--danger)';
    rateEl.textContent = opening>0 ? Math.round((1 - netPos/opening)*100)+'%' : '-';
    rateEl.style.color = saved>=0 ? 'var(--ok)' : 'var(--danger)';
  } else {
    // ê³µë™: ê³ ì •ë¹„ ì˜ˆì‚° ê¸°ì¤€ ìœ ì§€
    budgEl.textContent = fmt(totalBudget);
    const totalDiff = totalBudget - Math.max(0, totalNet);
    diffEl.textContent = totalBudget>0 ? fmtDiff(totalDiff) : '-';
    diffEl.style.color = totalDiff>=0 ? 'var(--ok)' : 'var(--danger)';
    rateEl.textContent = totalBudget>0 ? Math.round(Math.abs(totalDiff)/totalBudget*100)+'%' : '-';
    rateEl.style.color = totalDiff>=0 ? 'var(--ok)' : 'var(--danger)';
  }
}

// â”€â”€ Assets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAssets() {
  let totalBal = 0, totalDeposited = 0, totalOpening = 0;

  const cards = DEF_ASSETS.map(a => {
    const r = getAssetBal(a.id);
    totalBal      += r.balance;
    totalOpening  += r.opening;
    totalDeposited += r.deposited;
    return {a, r};
  })
  .sort((x,y) => y.r.balance - x.r.balance)
  .map(({a, r}) => {
    const ms = getMs();
    const isManual = (ms.assets||{})[a.id] !== undefined;
    const openingLabel = isManual ? 'ğŸ“Œ ì›”ì´ˆ ì”ì•¡' : 'ğŸ”„ ì „ì›” ì´ì›”';

    // ì´ë²ˆë‹¬ ì ë¦½ ë‚´ì—­ ëª©ë¡
    const depTxs = S.txs.filter(x =>
      x.date.startsWith(S.month) && x.type==='personal' &&
      x.category===SAVINGS_CAT && x.assetId===a.id
    ).sort((a,b)=>a.date.localeCompare(b.date));

    const depRows = depTxs.length > 0
      ? depTxs.map(x =>
          `<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);padding:2px 0 2px 20px;">
            <span>${parseInt(x.date.slice(8))}ì¼ ${x.desc}</span>
            <span style="font-family:'DM Mono',monospace;color:var(--ok)">+${fmt(x.amount)}</span>
          </div>`
        ).join('')
      : '';

    return `<div class="asset-card" style="flex-direction:column;align-items:stretch;gap:0;">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="asset-icon" style="background:${a.color}22">${a.emoji}</div>
        <div class="asset-body">
          <div class="asset-name">${a.name}</div>
          <div class="asset-sub" style="display:flex;gap:10px;margin-top:2px">
            <span>${openingLabel} ${fmt(r.opening)}</span>
            ${r.deposited>0?`<span style="color:var(--ok)">+${fmt(r.deposited)} ì ë¦½</span>`:''}
          </div>
        </div>
        <div class="asset-right" style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
          <div class="asset-bal" style="color:${a.color}">${fmt(r.balance)}</div>
          <button onclick="openLiquidate('${a.id}')" style="font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;border:1.5px solid ${a.color};color:${a.color};background:${a.color}14;cursor:pointer;">ë§¤ë„</button>
        </div>
      </div>
    </div>`;
  }).join('');

  const delta = totalBal - totalOpening;
  document.getElementById('asset-total').textContent = fmt(totalBal);
  document.getElementById('asset-delta').textContent = (delta>=0?'+':'-')+'â‚©'+Math.abs(Math.round(delta)).toLocaleString('ko-KR');
  document.getElementById('asset-delta').style.color = delta>=0?'rgba(255,255,255,.9)':'#FCA5A5';
  document.getElementById('asset-deposit').textContent = fmt(totalDeposited);

  document.getElementById('asset-list').innerHTML = cards;
}

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSettingsPage() {
  const ms=getMs();
  const fields=[['set-p-acc','pAccBal'],['set-p-cash','pCashBal'],['set-p-prev-card','pPrevCard'],['set-j-bal','jBal']];
  fields.forEach(([id,key])=>{ const el=document.getElementById(id); if(el&&document.activeElement!==el) el.value=ms[key]||''; });
  renderBudgetSection('personal');
  renderBudgetSection('joint');
  renderAssetSettings();
}

function renderBudgetSection(type) {
  const pfx=type==='personal'?'p':'j';
  const col=type==='personal'?'p-col':'j-col';
  const appMonths=appMonthsRecorded(type);

  document.getElementById(`set-${pfx}-budgets`).innerHTML=cats(type).map((c,i)=>{
    const isNone=c.budgetType==='none';
    const bud=getMonthBudget(c.name,type);
    const isFixed=c.budgetType==='fixed';

    let fieldsHtml;
    if (isNone) {
      fieldsHtml=`<div style="font-size:12px;color:var(--muted);padding:8px 0;text-align:center;background:var(--s2);border-radius:8px;margin-top:4px;">ì˜ˆì‚°ì„ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” í•­ëª©ì…ë‹ˆë‹¤ (ë‹¨ìˆœ ê¸°ë¡ìš©)</div>`;
    } else if (isFixed) {
      fieldsHtml=`
      <div style="background:var(--bg); padding:14px; border-radius:12px; margin-top:8px;">
        <div style="font-size:12px; font-weight:700; color:#5555AA; margin-bottom:6px;">ğŸ“Œ ê³ ì • ê¸ˆì•¡ (ë§¤ë‹¬ ë™ì¼)</div>
        <div style="font-size:11px; color:var(--muted); margin-bottom:12px;">ì›”ì„¸, í†µì‹ ë¹„, ë³´í—˜ë£Œì²˜ëŸ¼ ë§¤ë‹¬ ë˜‘ê°™ì´ í™•ì •ë˜ì–´ ë‚˜ê°€ëŠ” ê¸ˆì•¡ì„ ì ì–´ì£¼ì„¸ìš”.</div>
        <div style="display:flex; align-items:center; gap:8px;">
          <input type="number" class="sinp" style="flex:1; text-align:right; font-size:14px;" value="${c.seedAmt||''}" placeholder="ì˜ˆ: 50000" onchange="updCatField('${type}',${i},'seedAmt',this.value)">
          <span style="font-size:13px; font-weight:600;">ì›</span>
        </div>
      </div>`;
    } else {
      const adjVal = ((S.ms[S.month]||{}).adjusts||{})[type]?.[c.name] || '';
      const adjColor = adjVal>0?'var(--danger)':adjVal<0?'var(--ok)':'var(--muted)';
      fieldsHtml=`
      <div style="background:var(--bg); padding:14px; border-radius:12px; margin-top:8px;">
        <div style="font-size:12px; font-weight:700; color:var(--p); margin-bottom:6px;">ğŸ“Š ëª©í‘œ/í‰ê·  ê¸ˆì•¡ (ìœ ë™ì )</div>
        <div style="font-size:11px; color:var(--muted); margin-bottom:12px; line-height:1.4;">
          ì‹ë¹„ì²˜ëŸ¼ ë§¤ë‹¬ ë‹¬ë¼ì§€ì§€ë§Œ, <b>ëŒ€ëµì ì¸ í•œ ë‹¬ ëª©í‘œ ê¸ˆì•¡</b>ì„ ì •í•´ì£¼ì„¸ìš”.<br>
          <span style="color:var(--text); font-weight:500;">(ì•±ì„ ì“¸ìˆ˜ë¡ ì‹¤ì œ ì§€ì¶œê³¼ í•©ì‚°ë˜ì–´ ì§„ì§œ í‰ê· ìœ¼ë¡œ ë³´ì •ë©ë‹ˆë‹¤)</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
          <input type="number" class="sinp" style="flex:1; text-align:right; font-size:14px;" value="${c.seedAmt||''}" placeholder="ì˜ˆ: 300000" onchange="updCatField('${type}',${i},'seedAmt',this.value)">
          <span style="font-size:13px; font-weight:600;">ì›</span>
        </div>
        <details style="margin-top:12px;">
          <summary style="font-size:11px; color:var(--muted); cursor:pointer; outline:none; font-weight:500;">âš™ï¸ ì„¸ë¶€ ì¡°ì • (ê³¼ê±° ë°˜ì˜ ë° ì´ë²ˆ ë‹¬ íŠ¹ë³„ ì˜ˆì‚°)</summary>
          <div style="padding-top:12px; margin-top:8px; border-top:1px dashed var(--border); display:flex; flex-direction:column; gap:10px;">
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <span style="font-size:11px; color:var(--text);">ê³¼ê±° ìœ ì§€ê¸°ê°„ (ì„ íƒ)</span>
              <div style="display:flex; align-items:center; gap:4px;">
                <input type="number" class="sinp" style="width:40px; text-align:center; padding:6px;" value="${c.seedMonths||''}" placeholder="0" onchange="updCatField('${type}',${i},'seedMonths',this.value)">
                <span style="font-size:11px; color:var(--muted);">ê°œì›” ì „ë¶€í„° ì¼ë‹¤ê³  ê°€ì •</span>
              </div>
            </div>
            <div style="display:flex; align-items:center; justify-content:space-between;">
              <span style="font-size:11px; color:var(--text);">ì´ë²ˆ ë‹¬ë§Œ ì˜ˆì™¸ ì¡°ì •</span>
              <div style="display:flex; align-items:center; gap:4px;">
                <input type="number" class="sinp" style="width:100px; color:${adjColor}; border-color:${adjVal?adjColor:'var(--border)'}" value="${adjVal}" placeholder="ì˜ˆ: +50000" onchange="saveAdjust('${type}','${c.name}',this.value)">
                <span style="font-size:11px; color:var(--muted);">ì› (ì¶”ê°€/ì‚­ê°)</span>
              </div>
            </div>
          </div>
        </details>
      </div>`;
    }

    const delBtn=`<button class="cat-del-btn" onclick="delCat('${type}',${i})" title="ì¹´í…Œê³ ë¦¬ ì‚­ì œ">âœ•</button>`;
    const typeBtn=isNone
      ? `<span style="font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;border:1.5px solid #9CA3AF;color:#9CA3AF;background:#F9FAFB">ì˜ˆì‚°ì—†ìŒ</span>`
      : `<button class="brow-typebtn ${isFixed?'fixed':'avg'}" onclick="toggleBudgetType('${type}',${i})">${isFixed?'ğŸ“Œ ê³ ì •':'ğŸ“Š í‰ê· '}</button>`;
    return `<div class="brow">
      <div class="brow-top" style="margin-bottom:0;">
        <span class="brow-name" style="font-size:14px;">${c.emoji} ${c.name}</span>
        ${typeBtn}
        <span class="brow-result ${col}" title="ë‹¹ì›” í™•ì • ì˜ˆì‚°">${isNone?'-':bud>0?fmt(bud):'ë¯¸ì„¤ì •'}</span>
        ${delBtn}
      </div>
      <div class="brow-fields">${fieldsHtml}</div>
    </div>`;
  }).join('') +
  `<div class="cat-add-row" style="margin-top:16px;">
    <input class="emoji-inp" id="new-cat-emoji-${type}" placeholder="ğŸ˜Š" maxlength="2">
    <input class="cat-add-inp" id="new-cat-name-${type}" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„" maxlength="10">
    <button class="brow-typebtn fixed" style="white-space:nowrap; background:var(--text); color:white; border-color:var(--text);" onclick="addCat('${type}')">+ ì¶”ê°€</button>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAssetSettings() {
  const ms = getMs();
  const manualAssets = ms.assets || {};

  const balRows = DEF_ASSETS.map(a => {
    const isManual = manualAssets[a.id] !== undefined;
    const opening = getAssetOpening(a.id, S.month);
    const bal = getAssetBal(a.id);
    return `<div class="sr" style="align-items:flex-start;flex-direction:column;gap:6px;padding:14px 0">
      <div style="display:flex;justify-content:space-between;width:100%;align-items:center">
        <span class="sl2">${a.emoji} ${a.name}</span>
        <div style="text-align:right">
          <div style="font-family:'DM Mono',monospace;font-size:14px;font-weight:600">${fmt(bal.balance)}</div>
          <div style="font-size:10px;color:var(--muted)">ë‹¹ì›” í˜„ì¬ ì”ì•¡ â†’ ë‹¤ìŒë‹¬ ì›”ì´ˆ ìë™ì´ì›”</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;width:100%">
        <span style="font-size:11px;color:var(--muted);flex:1">${isManual?'ğŸ“Œ ìˆ˜ë™ì…ë ¥':'ğŸ”„ ì „ì›” ìë™ì´ì›”'} ì´ë²ˆë‹¬ ì›”ì´ˆ ${fmt(opening)}</span>
        <input type="number" class="sinp" style="width:120px" id="set-asset-${a.id}"
          placeholder="ì§ì ‘ì…ë ¥(ì„ íƒ)"
          value="${isManual ? manualAssets[a.id] : ''}"
          oninput="saveAssetBal('${a.id}',this.value)"
          title="ë¹„ì›Œë‘ë©´ ì „ì›” ì”ì•¡ì´ ìë™ ì´ì›”ë©ë‹ˆë‹¤">
      </div>
    </div>`;
  }).join('');
  document.getElementById('set-assets').innerHTML = balRows;
}

function saveAssetBal(assetId, val) {
  if (!S.ms[S.month]) S.ms[S.month] = {};
  if (!S.ms[S.month].assets) S.ms[S.month].assets = {};
  S.ms[S.month].assets[assetId] = parseFloat(val)||0;
  save();
  if (mainTab==='assets') renderAssets();
  if (mainTab==='transactions') renderTxFilter();
}

function saveNextAssetBal(assetId, val, nextMonth) {
  if (!S.ms[nextMonth]) S.ms[nextMonth] = {};
  if (!S.ms[nextMonth].assets) S.ms[nextMonth].assets = {};
  const n = parseFloat(val);
  if (!val || isNaN(n)) {
    delete S.ms[nextMonth].assets[assetId];
  } else {
    S.ms[nextMonth].assets[assetId] = n;
  }
  save();
  renderAssetSettings();
}

let _st;
function saveSettingsDebounced() {
  clearTimeout(_st); _st=setTimeout(()=>{
    if(!S.ms[S.month]) S.ms[S.month]={};
    S.ms[S.month].pAccBal   = parseFloat(document.getElementById('set-p-acc').value)||0;
    S.ms[S.month].pCashBal  = parseFloat(document.getElementById('set-p-cash').value)||0;
    S.ms[S.month].pPrevCard = parseFloat(document.getElementById('set-p-prev-card').value)||0;
    S.ms[S.month].jBal      = parseFloat(document.getElementById('set-j-bal').value)||0;
    save(); renderOv('personal'); renderOv('joint');
  },400);
}

function setAssetLink(catName, assetId) {
  if (!S.assetLinks) S.assetLinks = {};
  if (assetId) S.assetLinks[catName] = assetId;
  else delete S.assetLinks[catName];
  save();
  if (mainTab==='assets') renderAssets();
}

function addCat(type) {
  const emojiEl = document.getElementById(`new-cat-emoji-${type}`);
  const nameEl  = document.getElementById(`new-cat-name-${type}`);
  const emoji = emojiEl.value.trim() || 'ğŸ“¦';
  const name  = nameEl.value.trim();
  if (!name) return alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
  if (cats(type).find(c=>c.name===name)) return alert('ì´ë¯¸ ìˆëŠ” ì¹´í…Œê³ ë¦¬ ì´ë¦„ì…ë‹ˆë‹¤');
  const palette = type==='personal' ? PC : JC;
  const color = palette[cats(type).length % palette.length];
  // ë¯¸ì„¤ì • ë°”ë¡œ ì•ì— ì‚½ì…
  const arr = cats(type);
  const unIdx = arr.findIndex(c=>c.name==='ë¯¸ì„¤ì •');
  const newCat = {name, emoji, budgetType:'avg', seedAmt:0, seedMonths:0, color};
  if (unIdx>=0) arr.splice(unIdx, 0, newCat);
  else arr.push(newCat);
  resetMonthBudgets(S.month);
  save(); render();
  emojiEl.value=''; nameEl.value='';
}

function delCat(type, i) {
  const c = cats(type)[i];
  if (!c || c.name==='ë¯¸ì„¤ì •') return;
  if (!confirm(`"${c.name}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí• ê¹Œìš”?
í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ê¸°ì¡´ ë‚´ì—­ì€ ë¯¸ì„¤ì •ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.`)) return;
  // ê¸°ì¡´ ë‚´ì—­ â†’ ë¯¸ì„¤ì •ìœ¼ë¡œ ë³€ê²½
  S.txs.forEach(x => { if(x.type===type && x.category===c.name) x.category='ë¯¸ì„¤ì •'; });
  cats(type).splice(i, 1);
  resetMonthBudgets(S.month);
  save(); render();
}

function updCatField(type,i,key,val) {
  cats(type)[i][key]=parseFloat(val)||0;
  resetMonthBudgets(S.month);
  save(); renderOv(type); renderSettle(type); renderBudgetSection(type);
}

function toggleBudgetType(type,i) {
  const c=cats(type)[i];
  c.budgetType = c.budgetType==='fixed' ? 'avg' : 'fixed';
  resetMonthBudgets(S.month);
  save(); renderOv(type); renderSettle(type); renderBudgetSection(type);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKUP / RESTORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportData() {
  const blob=new Blob([JSON.stringify(S,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const dateStr=new Date().toISOString().slice(0,10);
  a.href=url; a.download=`ê°€ê³„ë¶€_ë°±ì—…_${dateStr}.json`;
  a.click(); URL.revokeObjectURL(url);
}

function importData(e) {
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try {
      const data=JSON.parse(ev.target.result);
      if(!data.txs) { alert('ì˜¬ë°”ë¥¸ ê°€ê³„ë¶€ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.'); return; }
      if(!confirm(`ë°±ì—… íŒŒì¼(${file.name})ì„ ë¶ˆëŸ¬ì˜¬ê¹Œìš”?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.`)) return;
      // ëˆ„ë½ í•„ë“œ ë³´ì™„
      if(!data.pCats) data.pCats = defaultState().pCats;
      if(!data.jCats) data.jCats = defaultState().jCats;
      if(!data.ms) data.ms = {};
      if(!data.assetLinks) data.assetLinks = {};
      if(!data.month) data.month = new Date().toISOString().slice(0,7);
      S = data;
      save(); render();
      alert('âœ… ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
    } catch(err) { alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message); }
  };
  reader.readAsText(file);
  e.target.value='';
}

function resetData() {
  if(!confirm('âš  ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
  if(!confirm('ë§ˆì§€ë§‰ í™•ì¸: ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  S=defaultState(); save(); render();
  alert('ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mPay='account', mType='personal', mCat=null, mDir='expense';

function setDirection(dir) {
  mDir = dir;
  const isInc = dir==='income';
  document.getElementById('dir-exp').classList.toggle('active', !isInc);
  document.getElementById('dir-inc').classList.toggle('active', isInc);
  document.getElementById('modal-title').textContent = _editId ? 'ë‚´ì—­ ìˆ˜ì •' : (isInc ? 'ìˆ˜ì… ì¶”ê°€' : 'ì§€ì¶œ ì¶”ê°€');
  document.getElementById('bsub').textContent = _editId ? 'ìˆ˜ì • ì™„ë£Œ' : (isInc ? 'ìˆ˜ì… ì¶”ê°€' : 'ì§€ì¶œ ì¶”ê°€');
  document.getElementById('bsub').style.background = isInc ? 'var(--ok)' : (mType==='personal'?'var(--p)':'var(--j)');
  // ìˆ˜ì…: ì¹´ë“œ ìˆ¨ê¹€, ê¸°ë³¸ ê³„ì¢Œ
  document.getElementById('pm-card').style.display = isInc ? 'none' : '';
  if (isInc && mPay==='card') setPayment('account');
  document.getElementById('payment-lbl').textContent = isInc ? 'ìˆ˜ì… ê²½ë¡œ' : 'ê²°ì œ ìˆ˜ë‹¨';
  if (!_editId) mCat=null;
  // ì¹´í…Œê³ ë¦¬ ì¹© ì¬ë Œë”
  const selCls = mType==='personal'?'sp':'sj';
  const catSrc = cats(mType);
  document.getElementById('chips').innerHTML = catSrc.map(c=>
    `<div class="chip${_editId&&c.name===mCat?' '+selCls:''}" onclick="selCat('${c.name}',this,'${selCls}')">${c.emoji} ${c.name}</div>`
  ).join('');
  document.getElementById('asset-fg').style.display='none';
  updatePaymentNote();
}

let _editId = null;

function openModal() {
  _editId = null;
  document.getElementById('inp-date').value=todayStr();
  document.getElementById('inp-amt').value='';
  document.getElementById('inp-desc').value='';
  mCat=null; mAssetId=null; mDir='expense';
  document.getElementById('asset-fg').style.display='none';
  document.getElementById('dir-exp').classList.add('active');
  document.getElementById('dir-inc').classList.remove('active');
  document.getElementById('modal-title').textContent='ì§€ì¶œ ì¶”ê°€';
  document.getElementById('bsub').textContent='ì§€ì¶œ ì¶”ê°€';
  document.getElementById('bsub-del').style.display='none';
  document.getElementById('pm-card').style.display='';
  document.getElementById('payment-lbl').textContent='ê²°ì œ ìˆ˜ë‹¨';
  setType(subTab==='personal'?'personal':'joint'); setPayment('account');
  document.getElementById('modal').classList.add('open');
}

function openEditModal(id) {
  const tx = S.txs.find(x=>x.id===id);
  if (!tx) return;
  _editId = id;
  mDir = tx.dir || 'expense';
  mCat = tx.category;           // â† setType ì „ì— ë¨¼ì € ì„¤ì •
  mAssetId = tx.assetId || null;

  document.getElementById('inp-date').value = tx.date;
  document.getElementById('inp-amt').value = tx.amount;
  document.getElementById('inp-desc').value = tx.desc;
  document.getElementById('dir-exp').classList.toggle('active', mDir==='expense');
  document.getElementById('dir-inc').classList.toggle('active', mDir==='income');
  document.getElementById('modal-title').textContent = 'ë‚´ì—­ ìˆ˜ì •';
  document.getElementById('bsub').textContent = 'ìˆ˜ì • ì™„ë£Œ';
  document.getElementById('bsub-del').style.display = 'block';
  document.getElementById('pm-card').style.display = mDir==='income' ? 'none' : '';
  document.getElementById('payment-lbl').textContent = mDir==='income' ? 'ìˆ˜ì… ê²½ë¡œ' : 'ê²°ì œ ìˆ˜ë‹¨';
  document.getElementById('asset-fg').style.display = 'none';

  // setType ë‚´ë¶€ì—ì„œ ì¹© ë Œë”ë§ ì‹œ mCat ì´ë¯¸ ì„¸íŒ…ë¼ ìˆìœ¼ë¯€ë¡œ í•˜ì´ë¼ì´íŠ¸ ìë™ ì ìš©
  setType(tx.type);
  setPayment(tx.payment);

  // ì ê¸ˆ ìì‚° í•˜ìœ„ ì„ íƒ
  if (mAssetId && tx.category === SAVINGS_CAT && mDir === 'expense') {
    document.getElementById('asset-fg').style.display = 'block';
    document.getElementById('asset-chips').innerHTML = DEF_ASSETS.map(a =>
      `<div class="chip${a.id===mAssetId?' sp':''}" onclick="selAsset('${a.id}',this)">${a.emoji} ${a.name}</div>`
    ).join('');
  }

  document.getElementById('modal').classList.add('open');
}
function closeOut(e) { if(e.target===document.getElementById('modal')) closeModal(); }
function closeModal() { document.getElementById('modal').classList.remove('open'); }

// ëˆì˜ íë¦„ ì•ˆë‚´ ë¬¸êµ¬ ì—…ë°ì´íŠ¸
function updatePaymentNote() {
  const noteEl = document.getElementById('jnote');
  if (mDir === 'income') { noteEl.style.display = 'none'; return; }

  noteEl.style.display = 'block';
  noteEl.style.padding = '10px 14px';
  noteEl.style.borderRadius = '10px';
  noteEl.style.fontSize = '12px';
  noteEl.style.marginTop = '-12px';
  noteEl.style.marginBottom = '20px';
  noteEl.style.lineHeight = '1.5';

  if (mType === 'personal') {
    if (mPay === 'card') {
      noteEl.style.background = 'var(--plt)';
      noteEl.style.color = 'var(--p)';
      noteEl.innerHTML = 'ğŸ’³ <b>ê°œì¸ ì‹ ìš©ì¹´ë“œ:</b> ë‹¹ì¥ ì”ê³ ê°€ ì¤„ì§€ ì•Šìœ¼ë©°, ì´ë²ˆ ë‹¬ ì—¬ìœ ìê¸ˆì—ì„œ ì˜ˆì‚°ì´ ì°¨ê°ë©ë‹ˆë‹¤.';
    } else {
      noteEl.style.background = 'var(--s2)';
      noteEl.style.color = 'var(--muted)';
      noteEl.innerHTML = 'ğŸ¦ <b>ê°œì¸ í˜„ê¸ˆ/ê³„ì¢Œ:</b> ì…ë ¥ ì¦‰ì‹œ ë‚˜ì˜ ì‹¤ì”ì•¡ê³¼ ì—¬ìœ ìê¸ˆì—ì„œ ëˆì´ ë¹ ì ¸ë‚˜ê°‘ë‹ˆë‹¤.';
    }
  } else if (mType === 'joint') {
    if (mPay === 'card') {
      noteEl.style.background = 'var(--jlt)';
      noteEl.style.color = 'var(--j)';
      noteEl.innerHTML = 'ğŸ”„ <b>ê³µë™ ì§€ì¶œì„ ë‚´ ì¹´ë“œë¡œ ê²°ì œ:</b><br>ê³µë™ ì”ì•¡ì—ì„œ ëˆì„ ì°¨ê°í•˜ê³ , ê·¸ë§Œí¼ ë‚´ ê°œì¸ ê³„ì¢Œë¡œ ë³´ì „(+í˜ì´ë°±) ë°›ìŠµë‹ˆë‹¤.';
    } else {
      noteEl.style.background = 'var(--jlt)';
      noteEl.style.color = 'var(--j)';
      noteEl.innerHTML = 'ğŸ¦ <b>ê³µë™ ê³„ì¢Œ ê²°ì œ:</b> ê³µë™ ì”ì•¡ì—ì„œ ì¦‰ì‹œ ëˆì´ ë¹ ì ¸ë‚˜ê°‘ë‹ˆë‹¤.';
    }
  }
}

function setType(t) {
  mType=t;
  document.getElementById('tp-p').classList.toggle('active',t==='personal');
  document.getElementById('tp-j').classList.toggle('active',t==='joint');
  document.getElementById('bsub').style.background=t==='personal'?'var(--p)':'var(--j)';
  if (!_editId) mCat=null;
  const cashBtn=document.getElementById('pm-cash');
  if(t==='joint'){ cashBtn.style.display='none'; if(mPay==='cash') setPayment('account'); }
  else { cashBtn.style.display=''; }
  const selCls=t==='personal'?'sp':'sj';
  const catSrc2 = cats(t);
  document.getElementById('chips').innerHTML=catSrc2.map(c=>
    `<div class="chip${_editId&&c.name===mCat?' '+selCls:''}" onclick="selCat('${c.name}',this,'${selCls}')">${c.emoji} ${c.name}</div>`
  ).join('');
  updatePaymentNote();
}

function setPayment(p) {
  mPay=p;
  ['card','account','cash'].forEach(x=>{
    const el=document.getElementById('pm-'+x);
    if(el) el.classList.toggle('active',p===x);
  });
  updatePaymentNote();
}

let mAssetId = null;

function selCat(name,el,cls) {
  mCat=name;
  mAssetId=null;
  document.querySelectorAll('#chips .chip').forEach(c=>c.className='chip');
  el.classList.add(cls);
  // ì ê¸ˆ ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ìì‚° í•˜ìœ„í•­ëª© í‘œì‹œ (ì§€ì¶œ ëª¨ë“œë§Œ)
  const assetFg = document.getElementById('asset-fg');
  if (name===SAVINGS_CAT && mType==='personal' && mDir==='expense') {
    assetFg.style.display='block';
    document.getElementById('asset-chips').innerHTML = DEF_ASSETS.map(a=>
      `<div class="chip" onclick="selAsset('${a.id}',this)">${a.emoji} ${a.name}</div>`
    ).join('');
  } else {
    assetFg.style.display='none';
  }
}

function selAsset(assetId, el) {
  mAssetId = assetId;
  document.querySelectorAll('#asset-chips .chip').forEach(c=>c.className='chip');
  el.classList.add('sp');
}

function saveTx() {
  const amt=parseFloat(document.getElementById('inp-amt').value);
  const desc=document.getElementById('inp-desc').value.trim();
  const date=document.getElementById('inp-date').value;
  if(!amt||amt<=0) return alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
  if(!desc) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
  if(!mCat) return alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
  if(mDir==='expense' && mCat===SAVINGS_CAT && mType==='personal' && !mAssetId) return alert('ì ê¸ˆ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”');

  if (_editId) {
    // ìˆ˜ì • ëª¨ë“œ
    const idx = S.txs.findIndex(x=>x.id===_editId);
    if (idx !== -1) {
      const orig = S.txs[idx];
      const updated = {id:_editId, amount:amt, desc, date, category:mCat, payment:mPay, type:mType, dir:mDir};
      if (mAssetId) updated.assetId = mAssetId;
      // else: assetId ì—†ìœ¼ë©´ í¬í•¨í•˜ì§€ ì•ŠìŒ (undefined ìë™ ì œê±°)
      S.txs[idx] = updated;
      // ë‚ ì§œê°€ ë°”ë€Œì—ˆê±°ë‚˜ ê¸ˆì•¡/ì¹´í…Œê³ ë¦¬ê°€ ë°”ë€ ê²½ìš° ì˜í–¥ë°›ëŠ” ì›” ì˜ˆì‚° ìŠ¤ëƒ…ìƒ· ì¬ê³„ì‚°
      const affectedMonths = new Set([orig.date.slice(0,7), date.slice(0,7)]);
      affectedMonths.forEach(m => resetMonthBudgets(m));
    }
  } else {
    // ì¶”ê°€ ëª¨ë“œ
    const tx = {id:Date.now().toString(),amount:amt,desc,date,category:mCat,payment:mPay,type:mType,dir:mDir};
    if(mAssetId) tx.assetId = mAssetId;
    S.txs.push(tx);
  }
  save(); closeModal(); render();
}

function deleteTxFromModal() {
  if(!confirm('ì´ ë‚´ì—­ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  S.txs = S.txs.filter(x=>x.id!==_editId);
  save(); closeModal(); render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LIQUIDATE (í˜„ê¸ˆí™”)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _liqAssetId = null;
let _liqPayment = 'account';

function openLiquidate(assetId) {
  _liqAssetId = assetId;
  _liqPayment = 'account';
  const a = DEF_ASSETS.find(x=>x.id===assetId);
  const r = getAssetBal(assetId);
  document.getElementById('liq-title').textContent = `${a.emoji} ${a.name} í˜„ê¸ˆí™”`;
  document.getElementById('liq-amount').value = '';
  document.getElementById('liq-desc').value = `${a.name} ë§¤ë„`;
  document.getElementById('liq-date').value = todayStr();
  document.getElementById('pm-liq-account').classList.add('active');
  document.getElementById('pm-liq-cash').classList.remove('active');
  updateLiqInfo();
  document.getElementById('mo-liquidate').classList.add('open');
  setTimeout(()=>document.getElementById('liq-amount').focus(), 100);
}

function setLiqPayment(p) {
  _liqPayment = p;
  document.getElementById('pm-liq-account').classList.toggle('active', p==='account');
  document.getElementById('pm-liq-cash').classList.toggle('active', p==='cash');
  updateLiqInfo();
}

function updateLiqInfo() {
  if (!_liqAssetId) return;
  const r = getAssetBal(_liqAssetId);
  const amt = parseFloat(document.getElementById('liq-amount').value) || 0;
  const afterAsset = r.balance - amt;
  const payLabel = _liqPayment === 'account' ? 'ê³„ì¢Œ' : 'í˜„ê¸ˆ';
  document.getElementById('liq-balance-info').innerHTML =
    `<div style="display:flex;justify-content:space-between;margin-bottom:4px">
      <span>ìì‚° ì”ì•¡ ë³€ë™</span>
      <span style="font-family:'DM Mono',monospace">${fmt(r.balance)} â†’ <b style="color:${afterAsset<0?'var(--danger)':'var(--text)'}">${fmt(afterAsset)}</b></span>
    </div>
    <div style="display:flex;justify-content:space-between">
      <span>${payLabel} ìˆ˜ì… ê¸°ë¡</span>
      <span style="font-family:'DM Mono',monospace;color:var(--ok)">+${fmt(amt)}</span>
    </div>`;
}

function saveLiquidate() {
  const amt = parseFloat(document.getElementById('liq-amount').value);
  if (!amt || amt <= 0) { alert('ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const desc = document.getElementById('liq-desc').value.trim() ||
    `${DEF_ASSETS.find(x=>x.id===_liqAssetId).name} ë§¤ë„`;
  const date = document.getElementById('liq-date').value || todayStr();

  // 1. ìì‚° ì”ì•¡ ì°¨ê° (ì›”ì´ˆë¥¼ opening - amt ë¡œ ê°±ì‹ , ì ë¦½ë¶„ì€ ìœ ì§€)
  const r = getAssetBal(_liqAssetId);
  if (!S.ms[S.month]) S.ms[S.month] = {};
  if (!S.ms[S.month].assets) S.ms[S.month].assets = {};
  S.ms[S.month].assets[_liqAssetId] = r.opening - amt;

  // 2. ë‚´ì—­ì— ìˆ˜ì…ìœ¼ë¡œ ê¸°ë¡ (ì”ì•¡ì€ ìë™ ê³„ì‚°)
  S.txs.push({
    id: Date.now().toString(),
    amount: amt,
    desc,
    date,
    category: 'ê¸°íƒ€',
    payment: _liqPayment,
    type: 'personal',
    dir: 'income',
  });

  save();
  document.getElementById('mo-liquidate').classList.remove('open');
  render();
}

document.getElementById('mo-liquidate').addEventListener('click', e => {
  if (e.target === document.getElementById('mo-liquidate'))
    document.getElementById('mo-liquidate').classList.remove('open');
});
document.getElementById('liq-amount').addEventListener('input', updateLiqInfo);


ensureMonthBudgets(S.month);
switchSub('personal');
render();
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ONBOARDING WIZARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openWizard() {
  document.getElementById('wiz-p-acc').value  = S.ms[S.month]?.pAccBal   || '';
  document.getElementById('wiz-p-cash').value = S.ms[S.month]?.pCashBal  || '';
  document.getElementById('wiz-p-card').value = S.ms[S.month]?.pPrevCard || '';
  document.getElementById('wiz-j-acc').value  = S.ms[S.month]?.jBal      || '';
  nextWizard(1);
  document.getElementById('mo-wizard').classList.add('open');
}

function nextWizard(step) {
  [1,2,3].forEach(i =>
    document.getElementById(`wiz-step-${i}`).style.display = i===step ? 'block' : 'none'
  );
}

function finishWizard() {
  if(!S.ms[S.month]) S.ms[S.month]={};
  S.ms[S.month].pAccBal   = parseFloat(document.getElementById('wiz-p-acc').value)  || 0;
  S.ms[S.month].pCashBal  = parseFloat(document.getElementById('wiz-p-cash').value) || 0;
  S.ms[S.month].pPrevCard = parseFloat(document.getElementById('wiz-p-card').value) || 0;
  S.ms[S.month].jBal      = parseFloat(document.getElementById('wiz-j-acc').value)  || 0;
  save();
  document.getElementById('mo-wizard').classList.remove('open');
  render();
  switchMain('settings');
  setTimeout(() => {
    const budgetCard = document.getElementById('set-p-budgets')?.parentElement;
    if (!budgetCard) return;
    budgetCard.scrollIntoView({behavior:'smooth', block:'center'});
    budgetCard.style.transition = 'box-shadow 0.4s ease-in-out';
    budgetCard.style.boxShadow  = '0 0 0 4px var(--plt)';
    setTimeout(() => budgetCard.style.boxShadow = 'var(--shadow)', 1500);
  }, 100);
}

document.getElementById('mo-wizard').addEventListener('click', e => {
  if (e.target === document.getElementById('mo-wizard'))
    document.getElementById('mo-wizard').classList.remove('open');
});
</script>
</body>
</html>
